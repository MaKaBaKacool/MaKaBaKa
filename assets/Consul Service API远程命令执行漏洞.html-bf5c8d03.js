import{_ as t}from"./plugin-vue_export-helper-c27b6911.js";import{r as p,o,c as i,a as n,b as s,d as c,e as a}from"./app-58e4a7d6.js";const l={},r=a('<h2 id="漏洞描述" tabindex="-1"><a class="header-anchor" href="#漏洞描述" aria-hidden="true">#</a> 漏洞描述</h2><p>2018年11月27日，Consul在官方博客中发布了关于Consul工具在特定配置下可能导致远程命令执行（RCE）漏洞的公告，并描述了防护该漏洞的配置方案。</p><p>Consul是HashiCorp公司推出的一款开源工具，用于实现分布式系统的服务发现与配置。与其他分布式服务注册与发现的方案相比，Consul提供的方案更为“一站式”。Consul内置了服务注册与发现框架、分布一致性协议实现、健康检查、Key/Value存储、多数据中心方案，不再需要依赖其他工具（例如ZooKeeper等），使用方式也相对简单。</p><p>Consul使用Go语言编写，因此具有天然的可移植性（支持Linux、Windows和Mac OS X系统）；且安装包中仅包含一个可执行文件，便于部署，可与Docker等轻量级容器无缝配合。</p><p>在特定配置下，恶意攻击者可以通过发送精心构造的HTTP请求在未经授权的情况下在Consul服务端远程执行命令。</p><h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><p>启用了脚本检查参数（-enable-script-checks）的所有版本</p><h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2>',8),u={href:"https://releases.hashicorp.com/consul/1.2.4/",target:"_blank",rel:"noopener noreferrer"},d=a(`<h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>Windows在当前目录下执行命令：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>#开启脚本检测功能，该功能开启后漏洞才存在
consul.exe agent -dev -client &lt;your-target-ip&gt;  -enable-script-checks   
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>访问<code>your-target-ip:8500</code>：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20230306091757424.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>验证是否存在该远程命令执行漏洞，访问以下网址，如果<code>EnableRemoteScriptChecks</code>参数为<code>true</code>，则漏洞存在：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://your-target-ip:port/v1/agent/self
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>也可以使用Meterpreter进行利用：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>msf6 &gt; search Hashicorp
msf6 &gt; use exploit/multi/misc/consul_service_exec
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="漏洞poc" tabindex="-1"><a class="header-anchor" href="#漏洞poc" aria-hidden="true">#</a> 漏洞POC</h2><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> requests
<span class="token keyword">import</span> argparse
<span class="token keyword">from</span> requests<span class="token punctuation">.</span>packages <span class="token keyword">import</span> urllib3
urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> colorama <span class="token keyword">import</span> init
init<span class="token punctuation">(</span>autoreset<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">import</span> json
headers<span class="token operator">=</span><span class="token punctuation">{</span>
<span class="token string">&#39;User-Agent&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0) Gecko/20100101 Firefox/78.0&#39;</span>
<span class="token punctuation">}</span>
<span class="token keyword">def</span> <span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	des<span class="token operator">=</span><span class="token string">&quot;Hashicorp Consul Service API远程命令执行漏洞POC&quot;</span>
	parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span>des<span class="token punctuation">)</span>
	parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&#39;target_url&#39;</span><span class="token punctuation">,</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span><span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&#39;The target address,example: http://192.168.140.153&#39;</span><span class="token punctuation">)</span>
	args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span> 
	target_url <span class="token operator">=</span> args<span class="token punctuation">.</span>target_url
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Hashicorp Consul Service API远程命令执行漏洞POC&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[-]正在执行检测...&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;[-]目标地址：</span><span class="token interpolation"><span class="token punctuation">{</span>target_url<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> target_url
<span class="token keyword">def</span> <span class="token function">check</span><span class="token punctuation">(</span>target_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
	url <span class="token operator">=</span> target_url <span class="token operator">+</span> <span class="token string">&#39;/v1/agent/self&#39;</span>
	<span class="token keyword">try</span><span class="token punctuation">:</span>
		response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
		value <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&#39;DebugConfig&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;EnableRemoteScriptChecks&#39;</span><span class="token punctuation">]</span>
		<span class="token keyword">if</span> <span class="token builtin">str</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&#39;True&#39;</span><span class="token punctuation">:</span>
			<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;\\033[0;31m[+]漏洞存在\\033[0m&#39;</span><span class="token punctuation">)</span>
		<span class="token keyword">else</span><span class="token punctuation">:</span>
			<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;漏洞不存在&#39;</span><span class="token punctuation">)</span>
	<span class="token keyword">except</span> Exception <span class="token keyword">as</span> a<span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;漏洞不存在&#39;</span><span class="token punctuation">)</span>
	
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
	target_url <span class="token operator">=</span> url<span class="token punctuation">(</span><span class="token punctuation">)</span>
	check<span class="token punctuation">(</span>target_url<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="漏洞修复" tabindex="-1"><a class="header-anchor" href="#漏洞修复" aria-hidden="true">#</a> 漏洞修复</h2><ul><li>禁用Consul服务器上的脚本检查功能</li><li>确保Consul HTTP API服务无法通过外网访问或调用</li><li>对<code>/v1/agent/service/register</code> 禁止PUT方法</li></ul>`,13);function k(v,m){const e=p("ExternalLinkIcon");return o(),i("div",null,[r,n("p",null,[s("以1.2.4为例，下载地址："),n("a",u,[s("https://releases.hashicorp.com/consul/1.2.4/"),c(e)])]),d])}const h=t(l,[["render",k],["__file","Consul Service API远程命令执行漏洞.html.vue"]]);export{h as default};
