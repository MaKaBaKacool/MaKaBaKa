import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,e as t}from"./app-58e4a7d6.js";const p={},o=t(`<h2 id="漏洞描述" tabindex="-1"><a class="header-anchor" href="#漏洞描述" aria-hidden="true">#</a> 漏洞描述</h2><p>OKLite v1.2.25 后台插件过滤不完善导致可以上传恶意木马文件</p><h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>OKLite 1.2.25
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>关于执行逻辑参照上一篇 <strong>OKLite 1.2.25 后台模块导入 任意文件上传 CVE-2019-16131</strong></p><p>出现漏洞的位置在于<strong>framework/admin/plugin_control.php</strong></p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202162317826.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">unzip_f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;id&#39;</span><span class="token punctuation">,</span><span class="token string single-quoted-string">&#39;int&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$rs</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;res&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get_one</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$rs</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">P_Lang</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;附件不存在&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$rs</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;ext&#39;</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string single-quoted-string">&#39;zip&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">P_Lang</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;非ZIP文件不支持在线解压&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">dir_root</span><span class="token operator">.</span><span class="token variable">$rs</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;filename&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">P_Lang</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;文件不存在&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$info</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">lib</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;phpzip&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">zip_info</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">dir_root</span><span class="token operator">.</span><span class="token variable">$rs</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;filename&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$info</span> <span class="token operator">=</span> <span class="token function">current</span><span class="token punctuation">(</span><span class="token variable">$info</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;filename&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">P_Lang</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;插件有异常&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$info</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;/&#39;</span><span class="token punctuation">,</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;filename&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">P_Lang</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;插件有异常&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">dir_root</span><span class="token operator">.</span><span class="token string single-quoted-string">&#39;plugins/&#39;</span><span class="token operator">.</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">P_Lang</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;插件已存在，不允许重复解压&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">P_Lang</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;插件打包模式有问题&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">lib</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;phpzip&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">unzip</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">dir_root</span><span class="token operator">.</span><span class="token variable">$rs</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;filename&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">dir_root</span><span class="token operator">.</span><span class="token string single-quoted-string">&#39;plugins/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里可以看到需要上传ZIP压缩包格式的插件，跟进<strong>zip_info</strong>函数</p><p>函数位置 <strong>framework/libs/phpzip.php</strong></p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202162317758.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>这里会返回关于ZIP压缩包的一些信息</p><p>往下看关键位置</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$info</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;/&#39;</span><span class="token punctuation">,</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;filename&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">P_Lang</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;插件有异常&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">dir_root</span><span class="token operator">.</span><span class="token string single-quoted-string">&#39;plugins/&#39;</span><span class="token operator">.</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">P_Lang</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;插件已存在，不允许重复解压&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">P_Lang</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;插件打包模式有问题&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">lib</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;phpzip&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">unzip</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">dir_root</span><span class="token operator">.</span><span class="token variable">$rs</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;filename&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">dir_root</span><span class="token operator">.</span><span class="token string single-quoted-string">&#39;plugins/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里用 explode函数以 <strong>/</strong> 分隔返回两个值，也就是说格式应为 <strong>AAA/BBB</strong>这样的目录格式，直接上传ZIP文件则会报错 <strong>插件打包模式有问题</strong></p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202162317579.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>在这里上传一个ZIP文件，格式要是解压出来为目录，目录中含PHP文件就行了</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">lib</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;phpzip&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">unzip</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">dir_root</span><span class="token operator">.</span><span class="token variable">$rs</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;filename&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">dir_root</span><span class="token operator">.</span><span class="token string single-quoted-string">&#39;plugins/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>最后两行告诉了文件解压的位置，上传的文件在 <strong>plugins目录下</strong></p>`,20),e=[o];function c(i,l){return s(),a("div",null,e)}const k=n(p,[["render",c],["__file","OKLite 1.2.25 后台插件安装 任意文件上传.html.vue"]]);export{k as default};
