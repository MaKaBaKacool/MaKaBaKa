import{_ as a}from"./plugin-vue_export-helper-c27b6911.js";import{r as n,o as s,c as r,a as t,b as d,d as l,e}from"./app-58e4a7d6.js";const c={},u=e(`<h2 id="漏洞描述" tabindex="-1"><a class="header-anchor" href="#漏洞描述" aria-hidden="true">#</a> 漏洞描述</h2><p>2021年8月爆出Redux Framework存在未授权的敏感信息泄露漏洞，CVE编号为CVE-2021-38314，影响v4.2.11及以下版本，发送特定的请求包可以在未授权的情况下获取服务器敏感信息</p><h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Redux Framework &lt;= v4.2.11
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="插件名" tabindex="-1"><a class="header-anchor" href="#插件名" aria-hidden="true">#</a> 插件名</h2><p>Redux Framework</p>`,6),v={href:"https://github.com/reduxframework/redux-framework",target:"_blank",rel:"noopener noreferrer"},o=e(`<h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>影响范围为 v4.211 以下, 看一下版本间的更新差异</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241336913.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>这里将 add_action 注册的函数都删除掉了，本地安装查看函数相关代码</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241337021.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$support_hash = md5( md5( Redux_Functions_Ex::hash_key() . &#39;-redux&#39; ) . &#39;-support&#39; );
add_action( &#39;wp_ajax_nopriv_&#39; . $support_hash, array( &#39;Redux_Helpers&#39;, &#39;support_args&#39; ) );
add_action( &#39;wp_ajax_&#39; . $support_hash, array( &#39;Redux_Helpers&#39;, &#39;support_args&#39; ) );
$hash_arg = md5( trailingslashit( network_site_url() ) . &#39;-redux&#39; );
add_action( &#39;wp_ajax_nopriv_&#39; . $hash_arg, array( &#39;Redux_Helpers&#39;, &#39;hash_arg&#39; ) );
add_action( &#39;wp_ajax_&#39; . $hash_arg, array( &#39;Redux_Helpers&#39;, &#39;hash_arg&#39; ) );
add_action( &#39;wp_ajax_redux_support_hash&#39;, array( &#39;Redux_Functions&#39;, &#39;support_hash&#39; ) );

add_filter( &#39;redux/tracking/options&#39;, array( &#39;Redux_Helpers&#39;, &#39;redux_stats_additions&#39; ) );
		
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看 add_action 注册的函数 hash_arg() 和 support_args()</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public static function hash_arg() {
			echo esc_html( md5( Redux_Functions_Ex::hash_key() . &#39;-redux&#39; ) );
			die();
		}
public static function support_args() {
			header( &#39;Expires: Mon, 26 Jul 1997 05:00:00 GMT&#39; );
			header( &#39;Last-Modified: &#39; . gmdate( &#39;D, d M Y H:i:s&#39; ) . &#39;GMT&#39; );
			header( &#39;Expires: Sat, 26 Jul 1997 05:00:00 GMT&#39; );
			header( &#39;Cache-Control: no-store, no-cache, must-revalidate&#39; );
			header( &#39;Cache-Control: post-check=0, pre-check=0&#39;, false );
			header( &#39;Pragma: no-cache&#39; );

			$instances = Redux::all_instances();

			if ( isset( $_REQUEST[&#39;i&#39;] ) &amp;&amp; ! empty( $_REQUEST[&#39;i&#39;] ) ) { // phpcs:ignore WordPress.Security.NonceVerification
				if ( is_array( $instances ) &amp;&amp; ! empty( $instances ) ) {
					foreach ( $instances as $opt_name =&gt; $data ) {
						if ( md5( $opt_name . &#39;-debug&#39; ) === $_REQUEST[&#39;i&#39;] ) { // phpcs:ignore WordPress.Security.NonceVerification
							$array = $data;
						}
					}
				}

				if ( isset( $array ) ) {

					// We only want the extension names and versions.
					$array-&gt;extensions = self::get_extensions( $opt_name );
					$to_return         = array();

					// Filter out all the unwanted data.
					foreach ( $array as $key =&gt; $value ) {
						if ( in_array(
							$key,
							array(
								// &#39;fields&#39;,
								&#39;extensions&#39;,
								&#39;sections&#39;,
								&#39;args&#39;,
								// &#39;field_types&#39;
							),
							true
						) ) {
							$to_return[ $key ] = $value;
						} else { // phpcs:ignore Generic.CodeAnalysis.EmptyStatement
							// phpcs:ignore Squiz.PHP.CommentedOutCode
							/* echo $key.PHP_EOL; */
						}
					}
					$array = $to_return;
				} else {
					die();
				}
			} else {
				$array = self::get_statistics_object();
				if ( is_array( $instances ) &amp;&amp; ! empty( $instances ) ) {
					$array[&#39;instances&#39;] = array();
					foreach ( $instances as $opt_name =&gt; $data ) {
						$array[&#39;instances&#39;][] = $opt_name;
					}
				}
				$array[&#39;key&#39;] = md5( Redux_Functions_Ex::hash_key() );
			}

			ksort( $array ); // Let&#39;s make that pretty.

			// phpcs:ignored WordPress.PHP.NoSilencedErrors, WordPress.Security.EscapeOutput
			echo @htmlspecialchars( @wp_json_encode( $array, true ), ENT_QUOTES );

			die();
		}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>support_args() 函数 $_REQUEST[&#39;i&#39;] 为空，来到另一处分支</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>} else {
				$array = self::get_statistics_object();
				if ( is_array( $instances ) &amp;&amp; ! empty( $instances ) ) {
					$array[&#39;instances&#39;] = array();
					foreach ( $instances as $opt_name =&gt; $data ) {
						$array[&#39;instances&#39;][] = $opt_name;
					}
				}
				$array[&#39;key&#39;] = md5( Redux_Functions_Ex::hash_key() );
			}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>跟踪 get_statistics_object() 函数，该函数可以获取插件等环境变量信息</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241337236.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到该函数 为 <code>wp_ajax_nopriv_*</code> 可未授权调用</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241337688.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>其中需要变量 $support_hash, 跟踪 hash_key() 方法</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$support_hash = md5( md5( Redux_Functions_Ex::hash_key() . &#39;-redux&#39; ) . &#39;-support&#39; );
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241337002.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>wp-config.php 中存在 AUTH_KEY 参数，为随机值</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241337166.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>回到 hash_arg() 函数</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241338129.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public static function hash_arg() {
			echo esc_html( md5( Redux_Functions_Ex::hash_key() . &#39;-redux&#39; ) );
			die();
		}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里就调用到了 Redux_Functions_Ex::hash_key() 中的函数，且返回 md5值</p><p>回到刚刚的代码中，可以发现得到的结果同样也是 $support_hash 我们所需要知道的参数，下面为等价替换</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$support_hash = md5(hash_arg(). &#39;-support&#39; );
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241338081.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>这样我们就获取到了一个利用链</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$hash_arg = md5( trailingslashit( network_site_url() ) . &#39;-redux&#39; );
add_action( &#39;wp_ajax_nopriv_&#39; . $hash_arg, array( &#39;Redux_Helpers&#39;, &#39;hash_arg&#39; ) );
|
获取 md5( Redux_Functions_Ex::hash_key() . &#39;-redux&#39;) 值
|
$support_hash = md5( md5( Redux_Functions_Ex::hash_key() . &#39;-redux&#39; ) . &#39;-support&#39; );
add_action( &#39;wp_ajax_nopriv_&#39; . $support_hash, array( &#39;Redux_Helpers&#39;, &#39;support_args&#39; ) );
|
调用函数 support_args 获取系统敏感信息
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241338421.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241338050.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241338052.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205241338807.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>成功获取到了插件版本等有关信息</p>`,33);function p(m,b){const i=n("ExternalLinkIcon");return s(),r("div",null,[u,t("p",null,[t("a",v,[d("https://github.com/reduxframework/redux-framework"),l(i)])]),o])}const g=a(c,[["render",p],["__file","WordPress Redux Framework class-redux-helpers.php 敏感信息泄漏漏洞 CVE-2021-38314.html.vue"]]);export{g as default};
